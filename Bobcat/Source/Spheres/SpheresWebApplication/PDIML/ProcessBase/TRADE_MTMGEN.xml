<?xml version="1.0" encoding="utf-8" ?>
<!-- FI 20100729 [17103] mise à jour jointures sur SESSIONRESTRICT-->
<!-- FI 20120102 []      mise en place des mots clefs %%SR -->
<!-- FI 20120102 []      mise en place des mots clefs %%SR -->
<!-- FI 20120119 [] mise de IsUseSQLParameters -->
<!-- FI 20120926 [] usage of data attribute for HyperLink column-->
<!-- PM 20160811 [RATP] Ajout product exchangeTradedDerivative (et passage de union à union all puisque PRODUCT différents)-->
<!-- EG 20200226 [25077] RDBMS : New version of Trades tables architecture (TRADEINSTRUMENT (INSTRUMENTNO=1) to TRADE)-->
<!-- FI 20200820 [25468] dates systemes en UTC -->

<Referentials>
  <Referential>
    <IsUseSQLParameters>true</IsUseSQLParameters>
    <TableName>VW_TRADEFORCLOSING</TableName>
    <Ressource>TRADE</Ressource>
    <ColumnByRow>3</ColumnByRow>
    <Create>false</Create>
    <Modify>false</Modify>
    <Remove>false</Remove>
    <Image>gif\Process.gif</Image>
    <Notepad>false</Notepad>

    <SQLSelect>
      <Command rdbms="all">
        <![CDATA[
                select distinct
                tblresult.IDT,tblresult.IDENTIFIER,tblresult.IDI,tblresult.DTTRADE,tblresult.DTSYS,tblresult.DESCRIPTION,
                tblresult.IDA_BUYER,tblresult.IDA_SELLER,tblresult.IDA_ENTITYBUYER,tblresult.IDA_ENTITYSELLER,
                tblresult.GPRODUCT, tblresult.IDP,tblresult.IDENTIFIER_PRODUCT,
                tblresult.IDSTENVIRONMENT,tblresult.IDSTBUSINESS,tblresult.IDSTACTIVATION,tblresult.IDSTPRIORITY,
                tblresult.SOURCE,tblresult.EXTLLINK
                from
                (
                /* All trades on product fxSimpleOption */
                /* With Start period date of event TRD is previous or equal to the process date and End period date of event TRD is later than the process date */
                /* And without Start period date of event EXE or ABN is previous or equal to the process date*/
                select distinct tblmain.IDT,tblmain.IDENTIFIER,tblmain.IDI,tblmain.DTTRADE,tblmain.DTSYS,tblmain.DESCRIPTION,
                tblmain.IDA_BUYER,tblmain.IDA_SELLER,tblmain.IDA_ENTITYBUYER,tblmain.IDA_ENTITYSELLER,
                tblmain.GPRODUCT, tblmain.IDP,tblmain.IDENTIFIER_PRODUCT,
                tblmain.IDSTENVIRONMENT,tblmain.IDSTBUSINESS,tblmain.IDSTACTIVATION,tblmain.IDSTPRIORITY,
                tblmain.SOURCE,tblmain.EXTLLINK
                from dbo.VW_TRADEFORCLOSING tblmain
                left outer join dbo.EVENT exeabn on exeabn.IDT = tblmain.IDT and exeabn.EVENTCODE in ('EXE', 'ABN')
                where
                /* TRADE */
                /* Status environment */
                (tblmain.IDSTENVIRONMENT = 'REGULAR'  or  tblmain.IDSTENVIRONMENT = 'SIMUL')
                /* PRODUCT */
                and tblmain.IDENTIFIER_PRODUCT = 'fxSimpleOption'
                /* EVENT TRD/DAT */
                /* Start Period and End Period */
                and ( tblmain.DTSTARTADJ <= @DATE1 and tblmain.DTENDADJ > @DATE1 )
                /* Status activation */
                and (tblmain.IDSTACTIVATION_EVENT = 'REGULAR'  or  tblmain.IDSTACTIVATION_EVENT = 'SIMUL')
                /* EVENT EXE/ABN */
                and  exeabn.DTSTARTADJ> @DATE1
                union all
                /* All trades on product fxSingleLeg and fxSwap */
                /* With Start period date of event TRD is previous or equal to the process date and End period date of event TRD is later than the process date */
                select distinct tblmain.IDT,tblmain.IDENTIFIER,tblmain.IDI,tblmain.DTTRADE,tblmain.DTSYS,tblmain.DESCRIPTION,
                tblmain.IDA_BUYER,tblmain.IDA_SELLER,tblmain.IDA_ENTITYBUYER,tblmain.IDA_ENTITYSELLER,
                tblmain.GPRODUCT, tblmain.IDP,tblmain.IDENTIFIER_PRODUCT,
                tblmain.IDSTENVIRONMENT,tblmain.IDSTBUSINESS,tblmain.IDSTACTIVATION,tblmain.IDSTPRIORITY,
                tblmain.SOURCE,tblmain.EXTLLINK
                from dbo.VW_TRADEFORCLOSING tblmain
                %%SR:TRADE_JOIN%%(tblmain.IDT, tblmain)
                where
                /* TRADE */
                /* Status environment */
                (tblmain.IDSTENVIRONMENT = 'REGULAR'  or  tblmain.IDSTENVIRONMENT = 'SIMUL')
                /* PRODUCT */
                and tblmain.IDENTIFIER_PRODUCT in( 'fxSingleLeg','fxSwap')
                /* EVENT TRD/DAT */
                /* Start Period and End Period */
                and ( tblmain.DTSTARTADJ <= @DATE1 and tblmain.DTENDADJ > @DATE1)
                /* Status activation */
                and (tblmain.IDSTACTIVATION_EVENT = 'REGULAR'  or  tblmain.IDSTACTIVATION_EVENT = 'SIMUL')
                and (%%SR:TRADE_WHERE_PREDICATE%%)
                
                union all
                /* All trades on product ExchangeTradedDerivative */
                /* With Start period date of event TRD is previous or equal to the process date and End period date of event TRD is later than the process date */
                select distinct tblmain.IDT,tblmain.IDENTIFIER,tblmain.IDI,tblmain.DTTRADE,tblmain.DTSYS,tblmain.DESCRIPTION,
                tblmain.IDA_BUYER,tblmain.IDA_SELLER,tblmain.IDA_ENTITYBUYER,tblmain.IDA_ENTITYSELLER,
                tblmain.GPRODUCT, tblmain.IDP,tblmain.IDENTIFIER_PRODUCT,
                tblmain.IDSTENVIRONMENT,tblmain.IDSTBUSINESS,tblmain.IDSTACTIVATION,tblmain.IDSTPRIORITY,
                tblmain.SOURCE,tblmain.EXTLLINK
                from dbo.VW_TRADEFORCLOSING tblmain
                %%SR:TRADE_JOIN%%(tblmain.IDT, tblmain)
                where
                /* TRADE */
                /* Status environment */
                (tblmain.IDSTENVIRONMENT = 'REGULAR'  or  tblmain.IDSTENVIRONMENT = 'SIMUL')
                /* PRODUCT */
                and tblmain.IDENTIFIER_PRODUCT = 'exchangeTradedDerivative'
                /* EVENT TRD/DAT */
                /* Start Period and End Period */
                and ( tblmain.DTSTARTADJ <= @DATE1 and tblmain.DTENDADJ > @DATE1)
                /* Status activation */
                and (tblmain.IDSTACTIVATION_EVENT = 'REGULAR'  or  tblmain.IDSTACTIVATION_EVENT = 'SIMUL')
                and (%%SR:TRADE_WHERE_PREDICATE%%)

                union all
                /* All trades on product fra, loanDeposit, swap and termDeposit */
                /* With Start period date of event TRD is previous or equal to the process date and End period date of event TRD is later than the process date */
                /* With one event INT/INT or TER/INT with date of eventclass STL is later to the process date */
                select distinct tblmain.IDT,tblmain.IDENTIFIER,tblmain.IDI,tblmain.DTTRADE,tblmain.DTSYS,tblmain.DESCRIPTION,
                tblmain.IDA_BUYER,tblmain.IDA_SELLER,tblmain.IDA_ENTITYBUYER,tblmain.IDA_ENTITYSELLER,
                tblmain.GPRODUCT, tblmain.IDP,tblmain.IDENTIFIER_PRODUCT,
                tblmain.IDSTENVIRONMENT,tblmain.IDSTBUSINESS,tblmain.IDSTACTIVATION,tblmain.IDSTPRIORITY,
                tblmain.SOURCE,tblmain.EXTLLINK
                from dbo.VW_TRADEFORCLOSING tblmain
                %%SR:TRADE_JOIN%%(tblmain.IDT, tblmain)
                inner join dbo.EVENT e_stl on e_stl.IDT = tblmain.IDT and e_stl.EVENTCODE !='OPP' and e_stl.IDSTACTIVATION !='DEACTIV'
                inner join dbo.EVENTCLASS ec on ec.IDE = e_stl.IDE and ec.EVENTCLASS =  'STL' and ec.ISPAYMENT = 1
                where
                /* TRADE */
                /* Status environment */
                (tblmain.IDSTENVIRONMENT = 'REGULAR'  or  tblmain.IDSTENVIRONMENT = 'SIMUL')
                /* Status activation */
                and tblmain.IDSTACTIVATION != 'DEACTIV'
                /* PRODUCT */
                and tblmain.IDENTIFIER_PRODUCT in ('fra','loanDeposit','swap','termDeposit')
                /* EVENT TRD/DAT */
                /* Start Period and End Period */
                and ( tblmain.DTSTARTADJ <= @DATE1 and tblmain.DTENDADJ > @DATE1)
                /* Status activation */
                and (tblmain.IDSTACTIVATION_EVENT = 'REGULAR'  or  tblmain.IDSTACTIVATION_EVENT = 'SIMUL')
                /* PAYMENT EVENT */
                and ec.DTEVENT > @DATE1
                /* */
                and (%%SR:TRADE_WHERE_PREDICATE%%)
                
                ) tblresult

                where
                (
                  (
                    (
                    tblresult.IDA_ENTITYBUYER =
                    case when -1=@ENTITY Then tblresult.IDA_ENTITYBUYER
                    else @ENTITY
                    end
                    )
                    or
                    (
                    tblresult.IDA_ENTITYSELLER =
                    case when -1=@ENTITY Then tblresult.IDA_ENTITYSELLER
                    else @ENTITY
                    end
                    )
                  )
                  and (tblresult.IDSTENVIRONMENT in ('REGULAR','SIMUL'))
                )
                ]]>
      </Command>
    </SQLSelect>

    <Column>
      <ColumnName>IDT</ColumnName>
      <Ressource>IDT</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsDataKeyField>true</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>true</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>true</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDENTIFIER</ColumnName>
      <Ressource>IDENTIFIER</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>true</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>true</IsOrderBy>
      <IsHyperLink linktype="column" type="IDT" data="IDT">true</IsHyperLink>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDI</ColumnName>
      <Ressource>IDI</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>true</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
        <TableName>INSTRUMENT</TableName>
        <ColumnRelation>
          <ColumnName>IDI</ColumnName>
          <DataType>int</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>IDENTIFIER</ColumnName>
          <Ressource>Instrument</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
        <ColumnLabel>
          <ColumnName>DISPLAYNAME</ColumnName>
          <Ressource>DISPLAYNAME</Ressource>
          <DataType>string</DataType>
        </ColumnLabel>
      </Relation>
    </Column>
    <Column>
      <ColumnName>DTTRADE</ColumnName>
      <Ressource>DTTRADE</Ressource>
      <DataType>date</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>DTSYS</ColumnName>
      <Ressource>DTSYS</Ressource>
      <DataType datakind='Timestamp' tzdbid='Etc/UTC' display='Audit'>datetime</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTENVIRONMENT</ColumnName>
      <Ressource>IDSTENVIRONMENT</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTBUSINESS</ColumnName>
      <Ressource>IDSTBUSINESS</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTACTIVATION</ColumnName>
      <Ressource>IDSTACTIVATION</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTPRIORITY</ColumnName>
      <Ressource>IDSTPRIORITY</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>SOURCE</ColumnName>
      <Ressource>SOURCE</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
        <DDLType>source</DDLType>
      </Relation>
    </Column>
    <Column>
      <ColumnName>DESCRIPTION</ColumnName>
      <Ressource>DESCRIPTION</Ressource>
      <DataType>string</DataType>
      <Colspan>0</Colspan>
      <Length>128</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
      </Relation>
    </Column>

    <Column>
      <ColumnName>GPRODUCT</ColumnName>
      <Ressource>GPRODUCT</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression/>
      <Default/>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <Relation/>
    </Column>
    <!--Column>
      <ColumnName>TRADEXML</ColumnName>
      <Ressource>TRADEXML</Ressource>
      <DataType>text</DataType>
      <Length>16</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
      </Relation>
    </Column-->
    <Column>
      <ColumnName>EXTLLINK</ColumnName>
      <Ressource>EXTLLINK</Ressource>
      <DataType>string</DataType>
      <Length>128</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
  </Referential>
</Referentials>