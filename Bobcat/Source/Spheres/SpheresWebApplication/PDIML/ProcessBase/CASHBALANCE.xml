<?xml version="1.0" encoding="utf-8" ?>
<!--FI 20120102 [] mise en place des mots clefs %%SR -->
<!--FI 20120726 Add CmptLevel2.5 car sinon le message est incorrect-->
<!--PM 20150520 [20575] Replace DTMARKET with DTENTITY-->
<!--FI 20170330 [23031] Modify -->
<!--FI 20170622 [23031] Modify (Correction d'un bug rencontré par le support) -->
<Referentials>
  <Referential>
    <CmptLevel>2.5</CmptLevel>
    <IsUseSQLParameters>true</IsUseSQLParameters>
    <TableName>xxxxxxxxx</TableName>
    <Ressource></Ressource>
    <ColumnByRow>2</ColumnByRow>
    <Create>false</Create>
    <Modify>false</Modify>
    <Remove>false</Remove>
    <Image></Image>
    <SQLCheckSelectedDefaultValue>0</SQLCheckSelectedDefaultValue>
    <LoadOnStart>true</LoadOnStart>

    <SQLSelect>
      <!-- FI 20170330 [23031] Il est désormais possible de lancer un cashBalance en date DTENTITYPREV si en DTENTITY aucun CashBalance n'a été exécuté 
      Usage de l'operator union pour faire office de distinct
      -->
      <!--
        FI 20170622 [23031] jointure sur ENTITYMARKETTRAIL 
        (Désormais il est possible de lancer le traitement en date précédente 
         sauf si cette date précédente est le 1er jour d'activité de l'entité) 
      -->
      <Command rdbms = "all">
        <![CDATA[
        select result.DATE1 as DTENTITY, 
result.IDA_ENTITY as ENTITY_IDA, a_entity.IDENTIFIER as ENTITY_IDENTIFIER,a_entity.DISPLAYNAME as ENTITY_DISPLAYNAME  
from 
(
select em.DTENTITY as DATE1, em.IDA as IDA_ENTITY
from dbo.ENTITYMARKET em
union 
select em.DTENTITYPREV as DATE1, em.IDA as IDA_ENTITY
from dbo.ENTITYMARKET em
inner join dbo.ENTITYMARKETTRAIL emt on emt.IDEM = em.IDEM and emt.DTENTITYOPEN = em.DTENTITYPREV
where not exists (select 1 from dbo.TRADE t 
                                inner join dbo.VW_INSTR_PRODUCT i on i.IDI = t.IDI and i.PRODUCT_IDENTIFIER = 'cashBalance'
                                where t.DTBUSINESS = em.DTMARKET)
)
result 
inner join dbo.ACTOR a_entity on a_entity.IDA=result.IDA_ENTITY
<choose>
  <when test="{ENTITY}>-1">where result.IDA_ENTITY=@ENTITY</when>
</choose>  
        ]]>
      </Command>
    </SQLSelect>

    <!--SQLRowStyle type="class">
      case
      when COUNTDTMARKET> 1 then 'DataGrid_ErrorStyle'
      else ''
      end
    </SQLRowStyle-->

    <Column>
      <ColumnName>ENTITY_IDA</ColumnName>
      <Ressource>ENTITY_IDA</Ressource>
      <DataType>int</DataType>
      <Nowrap>true</Nowrap>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
    </Column>
    <Column>
      <ColumnName>ENTITY_IDENTIFIER</ColumnName>
      <Ressource>IDA_ENTITY_2</Ressource>
      <DataType>string</DataType>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsKeyField>false</IsKeyField>
      <IsDataKeyField>false</IsDataKeyField>
      <IsResource>false</IsResource>
      <IsOrderBy>true</IsOrderBy>
      <IsHyperLink linktype="column" type="IDA" data="IDA_ENTITY" condition="ENTITY" linktable="ACTOR" name="IDENTIFIER">true</IsHyperLink>
    </Column>
    <Column>
      <ColumnName>ENTITY_DISPLAYNAME</ColumnName>
      <Ressource></Ressource>
      <DataType>string</DataType>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsKeyField>false</IsKeyField>
      <IsDataKeyField>false</IsDataKeyField>
      <IsIdentity>false</IsIdentity>
      <IsResource>false</IsResource>
      <IsOrderBy>false</IsOrderBy>
      <IsHyperLink linktype="column" type="IDA" data="IDA_ENTITY" condition="ENTITY" linktable="ACTOR" name="DISPLAYNAME">false</IsHyperLink>
    </Column>

    <Column>
      <ColumnName>DTENTITY</ColumnName>
      <Ressource>DTMARKET1</Ressource>
      <DataType>date</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsKeyField>false</IsKeyField>
      <IsDataKeyField>false</IsDataKeyField>
      <IsIdentity>false</IsIdentity>
      <IsOrderBy>true</IsOrderBy>
    </Column>
    <!--
    <Column>
      <ColumnName>COUNTDTMARKET</ColumnName>
      <Ressource>COUNTDTMARKET_</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
    </Column>
    <Column>
      <ColumnName>COUNTDTMARKETINFO</ColumnName>
      <Ressource>COUNTDTMARKETINFO</Ressource>
      <DataType>string</DataType>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsKeyField>false</IsKeyField>
      <IsDataKeyField>false</IsDataKeyField>
      <IsIdentity>false</IsIdentity>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
    </Column>
-->
    </Referential>
</Referentials>