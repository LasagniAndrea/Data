<?xml version="1.0" encoding="utf-8" ?>
<!--
CC/RD 20151203 [21066] VMG - Replace restriction sur 'EVENTCODE='LPP' par 'EVENTCODE in ('LPP','LPC')'
C'est pour afficher tous les flux: EOD, issus d'un transfert, ... 
à l'image des autres consultations: Flux financiers agrégés par actif, Flux financiers agrégés par trade, ...
RD 20130506 / Add "where ISPARTYCONSO=1"
CC 20121210 Ajout restriction sur EVENTCODE=LPP pour les flux VMG pour n'afficher que les flux EOD
EG 20191115 [25077] RDBMS : New version of Trades tables architecture (TRADESTSYS merge to TRADE, NEW TABLE TRADEXML)
EG 20200226 [25077] RDBMS : New version of Trades tables architecture (TRADEINSTRUMENT (INSTRUMENTNO=1) to TRADE)
-->
<Referentials>
  <Referential>
    <IsUseSQLParameters>true</IsUseSQLParameters>
    <TableName>FLOWSRISKCTRL_ALLOC</TableName>
    <Ressource>FLOWSRISKCTRL_ALLOC</Ressource>
    <ColumnByRow>2</ColumnByRow>
    <Create>false</Create>
    <Modify>false</Modify>
    <Remove>false</Remove>
    <AttachedDoc>false</AttachedDoc>
    <Notepad>false</Notepad>
    <LoadOnStart>false</LoadOnStart>
    <IsLoupe>false</IsLoupe>
    <Image></Image>

    <SQLSelect>
      <Command rdbms = "all">
        <![CDATA[
select '1_FLO' as ClassRecord, 
a.IDENTIFIER,a.DISPLAYNAME,
dc.CONTRACTSYMBOL,
dc.IDC_PRICE as IDC,isnull(isnull(ent.IDCREPORT,ent.IDCACCOUNT),'EUR') as IDCCtrval,
null as FXRATE,
null as Capital,null as LastUpdatedCapital,
isnull(sum(VMG_SIGNED),0) as VMG,isnull(sum(PRM_SIGNED),0) as PRM,isnull(sum(LOV2_SIGNED),0)-isnull(sum(LOV1_SIGNED),0) as LOV_DIF,
isnull(sum(VMG_SIGNED),0)+isnull(sum(PRM_SIGNED),0)+isnull(sum(LOV2_SIGNED),0)-isnull(sum(LOV1_SIGNED),0) as TOTAL,
--
null as THRESHOLD,null as RISKSTATUS, '' as INFORMATIONSTATUS 
from dbo.TRADE t
%%SR:TRADE_JOIN%%(t.IDT, t)
--
inner join dbo.INSTRUMENT i on i.IDI = t.IDI
inner join dbo.PRODUCT p on p.IDP=i.IDP and p.GPRODUCT='FUT' and p.CLASS='REGULAR'
--
inner join dbo.TRADEACTOR ta on ta.IDT=t.IDT and ta.IDROLEACTOR='COUNTERPARTY' and ta.FIXPARTYROLE='27'  
inner join dbo.BOOKACTOR_R bar on bar.IDB=ta.IDB and ISPARTYCONSO=1 and bar.LEVELACTOR>1 
inner join dbo.ACTOR a on a.IDA=bar.IDA_ACTOR
--
inner join dbo.ASSET_ETD asset on asset.IDASSET = t.IDASSET
inner join dbo.DERIVATIVEATTRIB da on da.IDDERIVATIVEATTRIB=asset.IDDERIVATIVEATTRIB
inner join dbo.DERIVATIVECONTRACT dc on dc.IDDC=da.IDDC
--
left outer join 
    (
      /* Cumul des flux VMG */
      select 
      sum(case when e.IDA_PAY=ta_dealer.IDA then -1 when e.IDA_REC=ta_dealer.IDA then +1 else 0 end * e.VALORISATION) as VMG_SIGNED, e.IDT
      from dbo.EVENT e
      inner join dbo.TRADEACTOR ta_dealer on ta_dealer.IDT=e.IDT and ta_dealer.IDROLEACTOR='COUNTERPARTY' and ta_dealer.FIXPARTYROLE='27'
      inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE and ec.EVENTCLASS='REC' and ec.DTEVENT between @DATE1 and @DATE2  
      where e.EVENTCODE in ('LPP','LPC') and e.EVENTTYPE='VMG' and e.IDSTACTIVATION='REGULAR'
      group by e.IDT--, e.UNIT
    ) e_vmg on (e_vmg.IDT=t.IDT)
--
left outer join 
    (
      /* Cumul des flux PRM */
      select 
      sum(case when e.IDA_PAY=ta_dealer.IDA then -1 when e.IDA_REC=ta_dealer.IDA then +1 else 0 end * e.VALORISATION) as PRM_SIGNED, e.IDT
      from dbo.EVENT e
      inner join dbo.TRADEACTOR ta_dealer on ta_dealer.IDT=e.IDT and ta_dealer.IDROLEACTOR='COUNTERPARTY' and ta_dealer.FIXPARTYROLE='27'
      inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE and ec.EVENTCLASS='REC' and ec.DTEVENT between @DATE1 and @DATE2  
      inner join dbo.EVENTCLASS ec2 on ec2.IDE=ec.IDE and ec2.EVENTCLASS='STL' and ec2.ISPAYMENT=1
      where e.EVENTTYPE='PRM' and e.IDSTACTIVATION='REGULAR'
      group by e.IDT--, e.UNIT
    ) e_prm on (e_prm.IDT=t.IDT)
--
left outer join 
    (
      /* Cumul des flux LOV début */
      select 
      sum(case when e.IDA_PAY=ta_dealer.IDA then -1 when e.IDA_REC=ta_dealer.IDA then +1 else 0 end * e.VALORISATION) as LOV1_SIGNED, e.IDT
      from dbo.EVENT e
      inner join dbo.TRADEACTOR ta_dealer on ta_dealer.IDT=e.IDT and ta_dealer.IDROLEACTOR='COUNTERPARTY' and ta_dealer.FIXPARTYROLE='27'
      inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE and ec.EVENTCLASS='REC' and ec.DTEVENT=@DATE1
      where e.EVENTCODE='LPC' and e.EVENTTYPE='LOV' and e.IDSTACTIVATION='REGULAR'
      group by e.IDT--, e.UNIT
    ) e_lov1 on (e_lov1.IDT=t.IDT)
left outer join 
    (
      /* Cumul des flux LOV fin */
      select 
      sum(case when e.IDA_PAY=ta_dealer.IDA then -1 when e.IDA_REC=ta_dealer.IDA then +1 else 0 end * e.VALORISATION) as LOV2_SIGNED, e.IDT
      from dbo.EVENT e
      inner join dbo.TRADEACTOR ta_dealer on ta_dealer.IDT=e.IDT and ta_dealer.IDROLEACTOR='COUNTERPARTY' and ta_dealer.FIXPARTYROLE='27'
      inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE and ec.EVENTCLASS='REC' and ec.DTEVENT=@DATE2
      where e.EVENTCODE='LPC' and e.EVENTTYPE='LOV' and e.IDSTACTIVATION='REGULAR'
      group by e.IDT--, e.UNIT
    ) e_lov2 on (e_lov2.IDT=t.IDT)
--
inner  join dbo.BOOK b on b.IDB=ta.IDB 
                       and b.ISPOSKEEPING=1
                       and b.IDA_ENTITY=case when @ENTITY=-1 then b.IDA_ENTITY else @ENTITY end
inner  join dbo.ENTITY ent on ent.IDA=b.IDA_ENTITY
--
--where t.DTBUSINESS between @DATE1 and @DATE2
where (t.IDSTENVIRONMENT='REGULAR') and (t.IDSTACTIVATION='REGULAR') and (t.IDSTBUSINESS='ALLOC') and 
(exists (
    select 1
    from dbo.EVENT e2
    inner join dbo.EVENTCLASS ec2 on ec2.IDE=e2.IDE and ec2.EVENTCLASS='REC' and ec2.DTEVENT between @DATE1 and @DATE2  
    where e2.IDT=t.IDT and e2.IDSTACTIVATION='REGULAR' and e2.EVENTTYPE in ('VMG','PRM','LOV')
   ))
--
group by a.IDENTIFIER,a.DISPLAYNAME,
t.IDM,dc.CONTRACTSYMBOL,dc.IDC_PRICE,
isnull(isnull(ent.IDCREPORT,ent.IDCACCOUNT),'EUR')
--
union all
--
select tip.ClassRecord as ClassRecord,
a.IDENTIFIER,a.DISPLAYNAME,
null as CONTRACTSYMBOL,
case tip.ClassRecord when '3_TOT' then isnull(isnull(ent.IDCREPORT,ent.IDCACCOUNT),'EUR') else aamt.IDC end as IDC,isnull(isnull(ent.IDCREPORT,ent.IDCACCOUNT),'EUR') as IDCCtrval,
null as FXRATE,
aamt.AMOUNT as Capital,isnull(aamt.DTUPD,aamt.DTINS) as LastUpdatedCapital,
null as VMG,null as PRM,null as LOV_DIF,null as TOTAL,
null as THRESHOLD,case tip.ClassRecord when '3_TOT' then 'Error [Undefined]' else null end as RISKSTATUS,null as INFORMATIONSTATUS
from dbo.TRADE t 
%%SR:TRADE_JOIN%%(t.IDT, t)
--
inner join dbo.INSTRUMENT i on i.IDI=t.IDI
inner join dbo.PRODUCT p on p.IDP=i.IDP and p.GPRODUCT='FUT' and p.CLASS='REGULAR'
--
inner join dbo.TRADEACTOR ta on ta.IDT=t.IDT and ta.IDROLEACTOR='COUNTERPARTY' and ta.FIXPARTYROLE='27'  
inner join dbo.BOOKACTOR_R bar on bar.IDB=ta.IDB and ISPARTYCONSO=1 and bar.LEVELACTOR>1  
inner join dbo.ACTOR a on a.IDA=bar.IDA_ACTOR
left outer join dbo.ACTORAMOUNT aamt on aamt.IDA=a.IDA and aamt.AMOUNTTYPE='CAPITAL' and aamt.ISENABLED=1 
                                and aamt.DTEFFECTIVE<=@DATE1 and isnull(aamt.DTEXPIRATION,@DATE2+1)>=@DATE2
--
inner  join dbo.BOOK b on b.IDB=ta.IDB 
                       and b.ISPOSKEEPING=1                       
                       and b.IDA_ENTITY=case when @ENTITY=-1 then b.IDA_ENTITY else @ENTITY end
inner  join dbo.ENTITY ent on ent.IDA=b.IDA_ENTITY
--
cross join (select '2_CAP' as ClassRecord from dual union all select '3_TOT' as ClassRecord from dual) tip
--
--where ((xISDISPLAYALLCAPITAL=1)
where (t.IDSTENVIRONMENT='REGULAR') and (t.IDSTACTIVATION='REGULAR') and (t.IDSTBUSINESS='ALLOC') and 
((@DISPLAYMODE='ALL+')
   or exists (
      select 1
      from dbo.EVENT e2
      inner join dbo.EVENTCLASS ec2 on ec2.IDE=e2.IDE and ec2.EVENTCLASS='REC' and ec2.DTEVENT between @DATE1 and @DATE2  
      where e2.IDT=t.IDT and e2.IDSTACTIVATION='REGULAR' and e2.EVENTTYPE in ('VMG','PRM','LOV')
   ))
--
group by tip.ClassRecord, 
a.IDENTIFIER,a.DISPLAYNAME,
aamt.IDC,
isnull(isnull(ent.IDCREPORT,ent.IDCACCOUNT),'EUR'),
aamt.AMOUNT,isnull(aamt.DTUPD,aamt.DTINS)
        ]]>
      </Command>
    </SQLSelect>

    <SQLRowStyle type="style">
      <![CDATA[
      case tblmain.CLASSRECORD
      when '2_CAP' then 'background-color:aliceblue'
      when '3_TOT' then 'background-color:mistyrose'
      else 'background-color:white'
      end
      ]]>
    </SQLRowStyle>
    <SQLRowState>
      <![CDATA[
      case tblmain.CLASSRECORD
      when '2_CAP' then 'lstaw=name:ledblue;title:Capital'
      when '2_TOT' then 'lstaw=name:ledblue;title:Capital'
      else 'lstaw=name:empty;title:Contract'
      end
      ]]>
    </SQLRowState>

    <Column>
      <ColumnName>CLASSRECORD</ColumnName>
      <Ressource>CLASSRECORD</Ressource>
      <DataType>string</DataType>
      <Length>5</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>RISKSTATUS</ColumnName>
      <Ressource>RISKSTATUS</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <Relation/>
      <CellStyle model="status"/>
    </Column>
    <Column>
      <ColumnName>IDENTIFIER</ColumnName>
      <Ressource>ACTOR_DISPLAYNAME</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy order="IDENTIFIER asc,ClassRecord asc,CONTRACTSYMBOL asc">true</IsOrderBy>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>DISPLAYNAME</ColumnName>
      <Ressource></Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>CONTRACTSYMBOL</ColumnName>
      <Ressource>CONTRACTSYMBOL</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>IDC</ColumnName>
      <Ressource>IDC</Ressource>
      <DataType>string</DataType>
      <Length>3</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>IDCCTRVAL</ColumnName>
      <Ressource>IDCCTRVAL</Ressource>
      <DataType>string</DataType>
      <Length>3</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>      
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>FXRATE</ColumnName>
      <Ressource>FXRATE</Ressource>
      <DataType>dec</DataType>
      <Length>15</Length>
      <Scale>4</Scale>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>CAPITAL</ColumnName>
      <Ressource>CAPITAL_LASTUPDATEDCAPITAL</Ressource>
      <DataType>dec</DataType>
      <Length>26</Length>
      <Scale>2</Scale>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>LASTUPDATEDCAPITAL</ColumnName>
      <Ressource></Ressource>
      <DataType>date</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>VMG</ColumnName>
      <Ressource>VMG</Ressource>
      <DataType>dec</DataType>
      <Length>26</Length>
      <Scale>2</Scale>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <Relation/>
      <CellStyle model="amount"/>
    </Column>
    <Column>
      <ColumnName>PRM</ColumnName>
      <Ressource>PRM</Ressource>
      <DataType>dec</DataType>
      <Length>26</Length>
      <Scale>2</Scale>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <Relation/>
      <CellStyle model="amount"/>
    </Column>
    <Column>
      <ColumnName>LOV_DIF</ColumnName>
      <Ressource>LOV_DIF</Ressource>
      <DataType>dec</DataType>
      <Length>26</Length>
      <Scale>2</Scale>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation/>
      <CellStyle model="amount"/>
    </Column>
    <Column>
      <ColumnName>TOTAL</ColumnName>
      <Ressource>TOTAL_ABC</Ressource>
      <DataType>dec</DataType>
      <Length>26</Length>
      <Scale>2</Scale>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <Relation/>
      <CellStyle model="amount"/>
    </Column>
    <Column>
      <ColumnName>THRESHOLD</ColumnName>
      <Ressource>THRESHOLD</Ressource>
      <DataType>string</DataType>
      <Align>right</Align>
      <Length>16</Length>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>INFORMATIONSTATUS</ColumnName>
      <Ressource>INFORMATIONSTATUS</Ressource>
      <DataType>string</DataType>
      <Length>128</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <Relation/>
    </Column>
  </Referential>
</Referentials>