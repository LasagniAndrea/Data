<?xml version="1.0" encoding="utf-8" ?>
<!-- 
RD 20230601 [26308] 
- Improvement : Exploitation de tous les prix des SSJ «Certifié» (ISENABLED=1) ou pas
RD 20230529 [26308] 
- Improvement : Appliquer l'Algorithme de recherche de la cotation du Sous-jacent (voir ci-dessous à la fin des commentaires)
- Performance : Utiliser la table de travail ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W pour afficher les prix des SSJ manquants
- Improvement : Afficher la valeur attendue pour les colonnes Date, Type et Timing pour le SSJ si la cotation n'existe pas
EG 20221010 [XXXXX][WI452] Déplacer la pavé WITH du select DSP/EDSP en tête de query (usage du SQL: WITHTOMOVE/SQL: ENDWITHTOMOVE)
FI 20201125 [XXXXX] Introduction de %%CC:ITRADE_JOIN%%(t) (existait en 8.1 sous %%CC:ITRADEINSTRUMENT%%)
RD 20200903 [25471] ASSET_MULTIPLIER: correction pour afficher la bonne valeur comme dans la vue VW_ASSET_ETD_EXPANDED 
EG 20200226 [25077] RDBMS : New version of Trades tables architecture (TRADEINSTRUMENT (INSTRUMENTNO=1) to TRADE)
EG 20191115 [25077] RDBMS : New version of Trades tables architecture (TRADESTSYS merge to TRADE, NEW TABLE TRADEXML)
FI 20190917 [24932] Refactoring 
PL 20190404 [XXXXX] Refactoring Controls on the form. Set Scale to 9 on VALUE
FI 20190403 [XXXXX] ETD => Restriction sur les TRADE REGULAR et usage de la nouvelle syntaxe SQL pour obtenir les trades en position BUSINESS
FI 20190403 [XXXXX] OTC,SEC => Restriction sur les TRADE REGULAR et usage de la nouvelle syntaxe SQL pour obtenir les trades en position BUSINESS 
FI 20190403 [XXXXX] OTC,SEC => Ajout des trades en position STL (Uniquement si ISSAFEKEEPING = 1)
FI 20181121 [XXXXX] add choose expression
CC/PL 20170307 [22916] - POSSYNT_PRESELECT & POSDET_PRESELECT - Prise en compte de DERIVATIVECONTRACT.ITMCONDITION
FI 20160219 [21317] OTC gère DEBTSECURITY, INDEX, EQUITY    
CC 20150102 Ajout d'un second élément SQLPreSelect et SQLSelect pour cours des CFD & EquitySecurityTransaction
FI 20141211 [20563] 1 seul element SQLPreSelect 
FI 20141001 [XXXXX] Modification de SQLPreSelect. Utilisation de la colonne ti.IDA_CSSCUSTODIAN
FI 20140924 [XXXXX] %%CC:ITRADEINSTRUMENT%% devient %%CC:ITRADEINSTRUMENT_JOIN%%
FI 20140702 [20142] Use %%CC:ITRADEINSTRUMENT%%(ti) 
                          => les filtres sur marché et Contrat dérivé sont pris en compte lors de l'alimentation de la table temporaire
FI 20140429 [19896] Mise en place de la colonne ATMATURITY_UNL
RD 20140121 [19671] Pour les Options avec SSJ Future, déterminer l'indicateur ITM/OTM en tenant compte de la base d'expression du prix de ce SSJ:
                         -	opérer une conversion si la base diffère de 100 (ex. 32) 

FI 20140122 [19482] Suite du chantier. 
                         Spheres® affiche les prix des assets option à l'échéance même si le prix n'est pas nécessaire à Spheres®. 
                         Cela permet d'afficher les option est in/out the money 

RD 20140121 [19516] Correction sur le deuxième SQLPreSelect 
FI 20140114 [19482] Refactoring Ajout et Reorganisation des colonnes 
EG 20140106 [XXXXX] Ne prendre que les ASSET actifs à la date demandée 
FI 20131128 [19255] Pour les futures arrivés à échéance on attend des prix close uniquement 
                         Les prix SettlementOffice seront nécessaires le jour où Spheres gère les livraison de futures 
FI 20131128 [19255] Gestion de la colonne FINALSETTLTSIDE 
FI 20131127 [19253] Recherche des assets en position en J-1 et des assets négocié en date J 
FI 20131126 [XXXXX] Add hyperlink sur la colonne ASSET_IDENTIFIER 
FI 20120926 [XXXXX] Usage of data attribute for HyperLink column 
FI 20120904 [18113] Nouveau standard, les tables de travail (temporaires) se terminent par _W
FI 20120530 [XXXXX] Ajout de la colonne des colonnes ASSET_MATFMT_FIX 
                         Spheres permet d'appliquer des critères sur les échéances uniquement sur les colonnes au format FIX 
FI 20111109 [XXXXX] Add Column ASSET_MATFMT_PROFIL pour affichage de l'échéance au format du profil
FI 20110707 [XXXXX] QUOTESIDE is null <=> QUOTESIDE='OfficialClose', QUOTETIMING is null <=> QUOTETIMING='Close'
FI 20110707 [XXXXX] QUOTESIDE is null <=> QUOTESIDE='OfficialClose', QUOTETIMING is null <=> QUOTETIMING='Close'
FI 20110630 [XXXXX] Comme partout l'opérateur <= est utilisé pour calculer les positions ouvertes et usage d'un or pour conserver les trades jours clôturées 
FI 20110629 [XXXXX] Prise en compte des books  telsque ISPOSKEEPING=1 
FI 20110629 [XXXXX] Suppression des prix OfficialClose des assets options arrivés à l'échéance (uniquement si contrat MarkToMarket)
-->
<!-- 
Algorithme de recherche de la cotation du Sous-jacent:

1/ OfficialClose/OfficialSettlement price:
******************************************

  Option AtMaturity
  ..................

  FinalSettltSide Specified
    FinalSettltSide price exists                  : Use FinalSettltSide price
    FinalSettltSide price doesn’t exist           : N/A

  NOT FinalSettltSide Specified
    OfficialSettlement price exists               : Use OfficialSettlement price
    OfficialClose price exists                    : Use OfficialClose price
    else                                          : N/A

  NOT Option AtMaturity
  .....................

    OfficialClose price exists                    : Use OfficialClose price
    else                                          : N/A

2/ Prix des SSJ «Certifié» (ISENABLED=1):
******************************************

  Exploitation de tous les prix des SSJ: «Certifié» (ISENABLED=1) ou pas.


NB: C'est le même algorithme Oracle et SQLServer pour:
- Consultation des Positions détaillées
- Consultation des Positions synthétiques
- Saisie des cours de clôture
-->

<Referentials>
  <Referential>
    <IsUseSQLParameters>true</IsUseSQLParameters>
    <TableName>QUOTE_H_EOD</TableName>
    <Ressource>QUOTE_H_EOD</Ressource>
    <ColumnByRow>4</ColumnByRow>
    <Create>false</Create>
    <Modify>true</Modify>
    <Remove>false</Remove>
    <Image></Image>

    <SQLPreSelect>
      <!-- Cours pour ETD -->
      <ConditionDynamicArg  grp="ACTIVITYTYPE">
        <DynamicArgValue name="ACTIVITYTYPE">1</DynamicArgValue>
      </ConditionDynamicArg>

      <!-- Fill ASSET_EOD_%%SHORTSESSIONID%%_W -->
      <Command rdbms = "sqlserver">
        <![CDATA[
        truncate table ASSET_EOD_%%SHORTSESSIONID%%_W;

        with TRADE_W as (
          select 
          t.IDT, t.IDASSET, t.SIDE, floor(t.QTY) as QTY, t.DTBUSINESS
          from dbo.TRADE t 
          %%CC:ITRADE_JOIN%%(t)
          %%SR:TRADE_JOIN%%(t.IDT, t)
          inner join dbo.INSTRUMENT ns on (ns.IDI = t.IDI)
          inner join dbo.PRODUCT pr on (pr.IDP = ns.IDP) and (pr.GPRODUCT = 'FUT')
          inner join dbo.BOOK bd on (bd.IDB=t.IDB_DEALER) and  (bd.ISPOSKEEPING=1)
          <choose>
            <when test="{ENTITY}>-1"> and (bd.IDA_ENTITY=@ENTITY)</when>
          </choose>
          where 
          (t.DTOUT is null or t.DTOUT > @DATE1) and (t.DTBUSINESS <= @DATE1)
          and (t.IDSTACTIVATION = 'REGULAR') and (t.IDSTBUSINESS = 'ALLOC')
          <choose>
              <when test="{CSSCUSTODIAN}>0"> and (t.IDA_CSSCUSTODIAN=@CSSCUSTODIAN)</when>
              <when test="{CSSCUSTODIAN}=-1 or {CSSCUSTODIAN}=-2"> and (1=1)</when>
              <when test="{CSSCUSTODIAN}=-3"> and (0=1)</when>
          </choose>   
          and (%%CC:ITRADE_WHERE_PREDICATE%%)
          and (%%SR:TRADE_WHERE_PREDICATE%%)
        ),
        POSSYNT_W as (
          select
          tw.IDT, tw.IDASSET, tw.DTBUSINESS, tw.QTY,
          isnull(pos.QTY_SELL,0) as QTY_CLEARSELL, isnull(pos.QTY_BUY,0) as QTY_CLEARBUY
          from TRADE_W tw
          left outer join (
              select pad.IDT_BUY as IDT, sum(isnull(pad.QTY,0)) as QTY_BUY, 0 as QTY_SELL
              from TRADE_W alloc 
              inner join dbo.POSACTIONDET pad on (pad.IDT_BUY = alloc.IDT)
              inner join dbo.POSACTION pa on (pa.IDPA = pad.IDPA)
              where (pa.DTOUT is null or pa.DTOUT > @DATE1) and (pa.DTBUSINESS <= @DATE1) and ((pad.DTCAN is null) or (pad.DTCAN > @DATE1))
              group by pad.IDT_BUY

              union all

              select pad.IDT_SELL as IDT, 0 as QTY_BUY, sum(isnull(pad.QTY,0)) as QTY_SELL
              from TRADE_W alloc 
              inner join dbo.POSACTIONDET pad on (pad.IDT_SELL = alloc.IDT)
              inner join dbo.POSACTION pa on (pa.IDPA = pad.IDPA)
              where (pa.DTOUT is null or pa.DTOUT > @DATE1) and (pa.DTBUSINESS <= @DATE1) and ((pad.DTCAN is null) or (pad.DTCAN > @DATE1))
              group by pad.IDT_SELL
          ) pos on (pos.IDT = tw.IDT)
         )
        insert into ASSET_EOD_%%SHORTSESSIONID%%_W(IDASSET,ASSETCATEGORY, IDDC,CATEGORY,MATURITYDATE,MATURITYDATESYS,PUTCALL,STRIKEPRICE,ITMCONDITION,LASTTRADINGDAY,ATMATURITY,EXERCISESTYLE,EXERCISESTYLE2,IDASSET_UNL,ASSETCATEGORY_UNL,ATMATURITY_UNL,FINALSETTLTPRICE,FINALSETTLTSIDE,FINALSETTLTTIME)
        select res.IDASSET, 'ExchangeTradedContract', res.IDDC, res.CATEGORY, res.MATURITYDATE, res.MATURITYDATESYS, res.PUTCALL, res.STRIKEPRICE, res.ITMCONDITION, 
        res.LASTTRADINGDAY, res.ATMATURITY,
        res.EXERCISESTYLE, res.EXERCISESTYLE2,
        res.IDASSET_UNL, res.ASSETCATEGORY_UNL, res.ATMATURITY_UNL,
        res.FINALSETTLPRICE, res.FINALSETTLTSIDE, res.FINALSETTLTTIME
        from (
          /* Retrieving ETD assets (Futures and Options) in position to D or traded to D */
          select etd.IDASSET, etd.PUTCALL, etd.STRIKEPRICE, 
          isnull(ma.MATURITYDATE, ma.MATURITYDATESYS) as MATURITYDATE, isnull(ma.MATURITYDATESYS, ma.MATURITYDATE) as MATURITYDATESYS, ma.LASTTRADINGDAY,
          case when isnull(ma.MATURITYDATE, ma.MATURITYDATESYS)= @DATE1 then '1' else '0' end as ATMATURITY,
          dc.IDDC, dc.CATEGORY, dc.ITMCONDITION, 
          dc.EXERCISESTYLE as EXERCISESTYLE, case dc.EXERCISESTYLE when '0' then 'European' when '1' then 'American' end as EXERCISESTYLE2,
          case when dc.ASSETCATEGORY='Future' then da.IDASSET else dc.IDASSET_UNL end as IDASSET_UNL, dc.ASSETCATEGORY as ASSETCATEGORY_UNL,
          case 
            when dc.ASSETCATEGORY='Future' then 
              case when isnull(maunl.MATURITYDATE, maunl.MATURITYDATESYS)= @DATE1 then '1' else '0' end 
            else  null 
          end as ATMATURITY_UNL,
          case when dc.CATEGORY='O' then isnull(dc.FINALSETTLTPRICE,'ExpiryDate') else null end as FINALSETTLPRICE,
          case when dc.CATEGORY='O' then dc.FINALSETTLTSIDE else null end as FINALSETTLTSIDE,
          case when dc.CATEGORY='O' then isnull(dc.FINALSETTLTTIME, '00:00') else null end as FINALSETTLTTIME
          from (
            select distinct posw.IDASSET as IDASSET
            from POSSYNT_W posw
            where (
              (posw.QTY - posw.QTY_CLEARSELL - posw.QTY_CLEARBUY > 0)
              or
              (posw.DTBUSINESS=@DATE1)
            )
          ) asset
          inner join dbo.ASSET_ETD etd on (etd.IDASSET=asset.IDASSET) and (etd.DTENABLED <= @DATE1) and (isnull(etd.DTDISABLED,@DATE1+1) > @DATE1) 
          inner join dbo.DERIVATIVEATTRIB da on (da.IDDERIVATIVEATTRIB=etd.IDDERIVATIVEATTRIB)
          inner join dbo.DERIVATIVECONTRACT dc on (dc.IDDC=da.IDDC)
          inner join dbo.MATURITY ma on (ma.IDMATURITY=da.IDMATURITY)
          left outer join dbo.ASSET_ETD etdunl on (etdunl.IDASSET=da.IDASSET)
          left outer join dbo.DERIVATIVEATTRIB daunl on (daunl.IDDERIVATIVEATTRIB=etdunl.IDDERIVATIVEATTRIB)
          left outer join dbo.MATURITY maunl on (maunl.IDMATURITY=daunl.IDMATURITY)
        ) res;]]>
      </Command>
      <Command rdbms = "oracle">
        <![CDATA[truncate table ASSET_EOD_%%SHORTSESSIONID%%_W purge MATERIALIZED VIEW LOG reuse STORAGE]]>
      </Command>
      <Command rdbms = "oracle">
        <![CDATA[
        insert into ASSET_EOD_%%SHORTSESSIONID%%_W(IDASSET,ASSETCATEGORY, IDDC,CATEGORY,MATURITYDATE,MATURITYDATESYS,PUTCALL,STRIKEPRICE,ITMCONDITION,LASTTRADINGDAY,ATMATURITY,EXERCISESTYLE,EXERCISESTYLE2,IDASSET_UNL,ASSETCATEGORY_UNL,ATMATURITY_UNL,FINALSETTLTPRICE,FINALSETTLTSIDE,FINALSETTLTTIME)
        with TRADE_W as (
          select t.IDT, t.IDASSET, t.SIDE, floor(t.QTY) as QTY, t.DTBUSINESS
          from dbo.TRADE t 
          %%CC:ITRADE_JOIN%%(t)
          %%SR:TRADE_JOIN%%(t.IDT, t)
          inner join dbo.INSTRUMENT ns on (ns.IDI = t.IDI)
          inner join dbo.PRODUCT pr on (pr.IDP = ns.IDP) and (pr.GPRODUCT = 'FUT')
          inner join dbo.BOOK bd on (bd.IDB=t.IDB_DEALER) and  (bd.ISPOSKEEPING=1)
          <choose>
            <when test="{ENTITY}>-1"> and (bd.IDA_ENTITY=@ENTITY)</when>
          </choose>
          where 
          (t.DTOUT is null or t.DTOUT > @DATE1) and (t.DTBUSINESS <= @DATE1)
          and (t.IDSTACTIVATION = 'REGULAR') and (t.IDSTBUSINESS = 'ALLOC')
          <choose>
              <when test="{CSSCUSTODIAN}>0"> and (t.IDA_CSSCUSTODIAN=@CSSCUSTODIAN)</when>
              <when test="{CSSCUSTODIAN}=-1 or {CSSCUSTODIAN}=-2"> and (1=1)</when>
              <when test="{CSSCUSTODIAN}=-3"> and (0=1)</when>
          </choose>              
          and (%%CC:ITRADE_WHERE_PREDICATE%%)
          and (%%SR:TRADE_WHERE_PREDICATE%%)
        ),
        POSSYNT_W as (
	        select
          tw.IDT, tw.IDASSET, tw.DTBUSINESS, tw.QTY,
          isnull(pos.QTY_SELL,0) as QTY_CLEARSELL, isnull(pos.QTY_BUY,0) as QTY_CLEARBUY
	        from TRADE_W tw
          left outer join (
            select pad.IDT_BUY as IDT, sum(isnull(pad.QTY,0)) as QTY_BUY, 0 as QTY_SELL
            from TRADE_W alloc 
            inner join dbo.POSACTIONDET pad on (pad.IDT_BUY = alloc.IDT)
            inner join dbo.POSACTION pa on (pa.IDPA = pad.IDPA)
            where (pa.DTOUT is null or pa.DTOUT > @DATE1) and (pa.DTBUSINESS <= @DATE1) and ((pad.DTCAN is null) or (pad.DTCAN > @DATE1))
            group by pad.IDT_BUY

            union all

            select pad.IDT_SELL as IDT, 0 as QTY_BUY, sum(isnull(pad.QTY,0)) as QTY_SELL
            from TRADE_W alloc 
            inner join dbo.POSACTIONDET pad on (pad.IDT_SELL = alloc.IDT)
            inner join dbo.POSACTION pa on (pa.IDPA = pad.IDPA)
            where (pa.DTOUT is null or pa.DTOUT > @DATE1) and (pa.DTBUSINESS <= @DATE1) and ((pad.DTCAN is null) or (pad.DTCAN > @DATE1))
            group by pad.IDT_SELL
          ) pos on (pos.IDT = tw.IDT)
        )
        select res.IDASSET, 'ExchangeTradedContract', res.IDDC,res.CATEGORY,res.MATURITYDATE,res.MATURITYDATESYS,res.PUTCALL,res.STRIKEPRICE,res.ITMCONDITION, 
        res.LASTTRADINGDAY,res.ATMATURITY,
        res.EXERCISESTYLE,res.EXERCISESTYLE2,
        res.IDASSET_UNL,res.ASSETCATEGORY_UNL, res.ATMATURITY_UNL,
        res.FINALSETTLPRICE, res.FINALSETTLTSIDE, res.FINALSETTLTTIME
        from (
          /* Retrieving ETD assets (Futures and Options) in position to D or traded to D */
          select etd.IDASSET, etd.PUTCALL, etd.STRIKEPRICE, 
          isnull(ma.MATURITYDATE, ma.MATURITYDATESYS) as MATURITYDATE, isnull(ma.MATURITYDATESYS, ma.MATURITYDATE) as MATURITYDATESYS, ma.LASTTRADINGDAY,
          case when isnull(ma.MATURITYDATE, ma.MATURITYDATESYS)= @DATE1 then '1' else '0' end as ATMATURITY,
          dc.IDDC,dc.CATEGORY, dc.ITMCONDITION, 
          dc.EXERCISESTYLE as EXERCISESTYLE,case dc.EXERCISESTYLE when '0' then 'European' when '1' then 'American' end as EXERCISESTYLE2,
          case when dc.ASSETCATEGORY='Future' then da.IDASSET else dc.IDASSET_UNL end as IDASSET_UNL,dc.ASSETCATEGORY as ASSETCATEGORY_UNL,
          case 
            when dc.ASSETCATEGORY='Future' then 
              case when isnull(maunl.MATURITYDATE, maunl.MATURITYDATESYS)= @DATE1 then '1' else '0' end 
            else  null 
          end as ATMATURITY_UNL,
          case when dc.CATEGORY='O' then isnull(dc.FINALSETTLTPRICE,'ExpiryDate') else null end as FINALSETTLPRICE,
          case when dc.CATEGORY='O' then dc.FINALSETTLTSIDE else null end as FINALSETTLTSIDE,
          case when dc.CATEGORY='O' then isnull(dc.FINALSETTLTTIME, '00:00') else null end as FINALSETTLTTIME
          from (
            select distinct posw.IDASSET as IDASSET
            from POSSYNT_W posw
            where (
              (posw.QTY - posw.QTY_CLEARSELL - posw.QTY_CLEARBUY > 0)
              or
              (posw.DTBUSINESS=@DATE1)
            )
          ) asset
          inner join dbo.ASSET_ETD etd on (etd.IDASSET=asset.IDASSET) and (etd.DTENABLED <= @DATE1) and (isnull(etd.DTDISABLED,@DATE1+1) > @DATE1) 
          inner join dbo.DERIVATIVEATTRIB da on (da.IDDERIVATIVEATTRIB=etd.IDDERIVATIVEATTRIB)
          inner join dbo.DERIVATIVECONTRACT dc on (dc.IDDC=da.IDDC)
          inner join dbo.MATURITY ma on (ma.IDMATURITY=da.IDMATURITY)
          left outer join dbo.ASSET_ETD etdunl on (etdunl.IDASSET=da.IDASSET)
          left outer join dbo.DERIVATIVEATTRIB daunl on (daunl.IDDERIVATIVEATTRIB=etdunl.IDDERIVATIVEATTRIB)
          left outer join dbo.MATURITY maunl on (maunl.IDMATURITY=daunl.IDMATURITY)
        ) res;]]>
      </Command>

      <!-- Update ASSET_EOD_%%SHORTSESSIONID%%_W column UNLQUOTE_TIME-->
      <Command rdbms = "sqlserver">
        <![CDATA[
        update ASSET_EOD_%%SHORTSESSIONID%%_W
        set UNLQUOTE_TIME =
          case 
            when CATEGORY = 'O' and ATMATURITY = '1' then
              case 
                when FINALSETTLTPRICE = 'ExpiryDate' then  
						      convert(datetime,replace(convert(varchar,MATURITYDATESYS,126),'T00:00','T'+FINALSETTLTTIME)+'.000',126)
                when FINALSETTLTPRICE = 'LastTradingDay' then 
						      convert(datetime,replace(convert(varchar,isnull(LASTTRADINGDAY,MATURITYDATESYS),126),'T00:00','T'+FINALSETTLTTIME)+'.000',126)
			          else 	
				          @DATE1
				      end
            else 
				      @DATE1
          end;]]>
      </Command>
      <Command rdbms = "oracle">
        <![CDATA[
        update ASSET_EOD_%%SHORTSESSIONID%%_W
        set UNLQUOTE_TIME =
          case  
            when CATEGORY = 'O' and ATMATURITY = '1' then
              case 
                when FINALSETTLTPRICE = 'ExpiryDate' then  
						      TO_DATE(replace(TO_CHAR(MATURITYDATESYS,'YYYYMMDD,HH24:MI:SS'),',00:00',',' || FINALSETTLTTIME), 'YYYYMMDD,HH24:MI:SS')
                when FINALSETTLTPRICE = 'LastTradingDay' then 
						      TO_DATE(replace(TO_CHAR(nvl(LASTTRADINGDAY,MATURITYDATESYS),'YYYYMMDD,HH24:MI:SS'),',00:00',',' || FINALSETTLTTIME), 'YYYYMMDD,HH24:MI:SS')
			          else 	
				          @DATE1
              end
            else 
				        @DATE1
          end;]]>
      </Command>

      <!-- Fill ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W -->
      <Command rdbms = "sqlserver">
        <![CDATA[
    truncate table ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W;

    with ASSET_EOD_OPT_W as (
      select asset.IDASSET, asset.ASSETCATEGORY, asset.IDASSET_UNL, asset.ASSETCATEGORY_UNL,
      asset.CATEGORY,asset.ATMATURITY,asset.FINALSETTLTSIDE,asset.UNLQUOTE_TIME,asset.FINALSETTLTTIME,asset.PUTCALL,
      case 
        when asset.ASSETCATEGORY_UNL='Future' then
          case when isnull(dc_unl.INSTRUMENTNUM,1) <= 1 and dc_unl.INSTRUMENTDEN >= 100 and mod(dc_unl.INSTRUMENTDEN,100) = 0 
            then asset.STRIKEPRICE
          else 
            floor(asset.STRIKEPRICE) + 
            ((asset.STRIKEPRICE - floor(asset.STRIKEPRICE)) * 
            case when isnull(dc_unl.INSTRUMENTDEN,0)<=0 then 1 else dc_unl.INSTRUMENTDEN end / 
            (100 * case when isnull(dc_unl.INSTRUMENTNUM,0)=0 then 1 else dc_unl.INSTRUMENTNUM end))
          end
        else 
          asset.STRIKEPRICE
      end as STRIKE_UNLBASE, asset.ITMCONDITION    
      from ASSET_EOD_%%SHORTSESSIONID%%_W asset
      left outer join dbo.ASSET_ETD asset_unl on (asset.ASSETCATEGORY_UNL='Future' and asset_unl.IDASSET = asset.IDASSET_UNL)
      left outer join dbo.DERIVATIVEATTRIB da_unl on (da_unl.IDDERIVATIVEATTRIB = asset_unl.IDDERIVATIVEATTRIB)
      left outer join dbo.DERIVATIVECONTRACT dc_unl on (dc_unl.IDDC = da_unl.IDDC)
      where asset.CATEGORY = 'O'
    )
    insert into ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W (IDASSET,ASSETCATEGORY,IDASSET_UNL,ASSETCATEGORY_UNL,IDQUOTE_H,VALUE,TIME,QUOTESIDE,QUOTETIMING,SOURCE,ITM_OTM)
    select asset.IDASSET,asset.ASSETCATEGORY,asset.IDASSET_UNL,asset.ASSETCATEGORY_UNL,quoteUnl.IDQUOTE_H,quoteUnl.VALUE,quoteUnl.TIME,quoteUnl.QUOTESIDE,quoteUnl.QUOTETIMING,quoteUnl.SOURCE,
    case 
      when asset.PUTCALL='1' and asset.STRIKE_UNLBASE < quoteUnl.VALUE then 'In the money' 
      when asset.PUTCALL='1' and asset.STRIKE_UNLBASE > quoteUnl.VALUE then 'Out the money'
      when asset.PUTCALL='1' and asset.STRIKE_UNLBASE = quoteUnl.VALUE 
        then case when asset.ITMCONDITION in ('1','2') then 'At the money (ITM)' else 'At the money (OTM)' end
      when asset.PUTCALL='0' and asset.STRIKE_UNLBASE > quoteUnl.VALUE then 'In the money'
      when asset.PUTCALL='0' and asset.STRIKE_UNLBASE < quoteUnl.VALUE then 'Out the money'
      when asset.PUTCALL='0' and asset.STRIKE_UNLBASE = quoteUnl.VALUE 
        then case when asset.ITMCONDITION in ('1','3') then 'At the money (ITM)' else 'At the money (OTM)' end
      else 'N/A' 
    end as ITM_OTM
    from ASSET_EOD_OPT_W asset
    inner join dbo.VW_QUOTE_H quoteUnl on quoteUnl.IDASSET = asset.IDASSET_UNL 
    and quoteUnl.ASSETCATEGORY = asset.ASSETCATEGORY_UNL 
    and quoteUnl.QUOTESIDE = asset.FINALSETTLTSIDE 
    and quoteUnl.QUOTETIMING = 'Close' 
    and (
      (quoteUnl.TIME = asset.UNLQUOTE_TIME and asset.FINALSETTLTTIME != '00:00')
      or
      (convert(varchar,quoteUnl.TIME,112) = convert(varchar,asset.UNLQUOTE_TIME,112))
    )
    where asset.ATMATURITY = '1' and asset.FINALSETTLTSIDE is not null
    
    union all
    
    select quote.IDASSET,quote.ASSETCATEGORY,quote.IDASSET_UNL,quote.ASSETCATEGORY_UNL,quote.IDQUOTE_H,quote.VALUE,quote.TIME,quote.QUOTESIDE,quote.QUOTETIMING,quote.SOURCE,
    case 
      when quote.PUTCALL='1' and quote.STRIKE_UNLBASE < quote.VALUE then 'In the money' 
      when quote.PUTCALL='1' and quote.STRIKE_UNLBASE > quote.VALUE then 'Out the money'
      when quote.PUTCALL='1' and quote.STRIKE_UNLBASE = quote.VALUE 
        then case when quote.ITMCONDITION in ('1','2') then 'At the money (ITM)' else 'At the money (OTM)' end
      when quote.PUTCALL='0' and quote.STRIKE_UNLBASE > quote.VALUE then 'In the money'
      when quote.PUTCALL='0' and quote.STRIKE_UNLBASE < quote.VALUE then 'Out the money'
      when quote.PUTCALL='0' and quote.STRIKE_UNLBASE = quote.VALUE 
        then case when quote.ITMCONDITION in ('1','3') then 'At the money (ITM)' else 'At the money (OTM)' end
      else 'N/A' 
    end as ITM_OTM
    from (
      select asset.IDASSET,asset.ASSETCATEGORY,asset.IDASSET_UNL,asset.ASSETCATEGORY_UNL,quoteUnl.IDQUOTE_H,quoteUnl.VALUE,quoteUnl.TIME,quoteUnl.QUOTESIDE,quoteUnl.QUOTETIMING,quoteUnl.SOURCE,
      asset.PUTCALL,asset.STRIKE_UNLBASE,asset.ITMCONDITION,
      ROW_NUMBER() OVER( PARTITION BY asset.IDASSET order by quoteUnl.TIME desc,
          case isnull(quoteUnl.QUOTESIDE,'OfficialClose') when 'OfficialSettlement' then 0 when 'OfficialClose' then 1 else 2 end asc
      ) AS ROWORDER
      from ASSET_EOD_OPT_W asset
      inner join dbo.VW_QUOTE_H quoteUnl on quoteUnl.IDASSET = asset.IDASSET_UNL 
      and quoteUnl.ASSETCATEGORY = asset.ASSETCATEGORY_UNL 
      and quoteUnl.QUOTESIDE in ('OfficialClose','OfficialSettlement') 
      and quoteUnl.QUOTETIMING = 'Close' 
      and (
        (quoteUnl.TIME = asset.UNLQUOTE_TIME and asset.FINALSETTLTTIME != '00:00')
        or
        (convert(varchar,quoteUnl.TIME,112) = convert(varchar,asset.UNLQUOTE_TIME,112))
      )
      where asset.ATMATURITY = '1' and asset.FINALSETTLTSIDE is null
    ) quote
    where (quote.ROWORDER=1)
    
    union all
      
    select asset.IDASSET,asset.ASSETCATEGORY,asset.IDASSET_UNL,asset.ASSETCATEGORY_UNL,quoteUnl.IDQUOTE_H,quoteUnl.VALUE,quoteUnl.TIME,quoteUnl.QUOTESIDE,quoteUnl.QUOTETIMING,quoteUnl.SOURCE,
    case 
      when asset.PUTCALL='1' and asset.STRIKE_UNLBASE < quoteUnl.VALUE then 'In the money' 
      when asset.PUTCALL='1' and asset.STRIKE_UNLBASE > quoteUnl.VALUE then 'Out the money'
      when asset.PUTCALL='1' and asset.STRIKE_UNLBASE = quoteUnl.VALUE 
        then case when asset.ITMCONDITION in ('1','2') then 'At the money (ITM)' else 'At the money (OTM)' end
      when asset.PUTCALL='0' and asset.STRIKE_UNLBASE > quoteUnl.VALUE then 'In the money'
      when asset.PUTCALL='0' and asset.STRIKE_UNLBASE < quoteUnl.VALUE then 'Out the money'
      when asset.PUTCALL='0' and asset.STRIKE_UNLBASE = quoteUnl.VALUE 
        then case when asset.ITMCONDITION in ('1','3') then 'At the money (ITM)' else 'At the money (OTM)' end
      else 'N/A' 
    end as ITM_OTM
    from ASSET_EOD_OPT_W asset
    inner join dbo.VW_QUOTE_H quoteUnl on quoteUnl.IDASSET = asset.IDASSET_UNL 
    and quoteUnl.ASSETCATEGORY = asset.ASSETCATEGORY_UNL 
    and quoteUnl.QUOTESIDE = 'OfficialClose' 
    and quoteUnl.QUOTETIMING = 'Close' 
    and (convert(varchar,quoteUnl.TIME,112) = convert(varchar,asset.UNLQUOTE_TIME,112))
    where (asset.ATMATURITY = '0');
        
    insert into ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W(IDASSET,ASSETCATEGORY,IDASSET_UNL,ASSETCATEGORY_UNL,IDQUOTE_H,VALUE,TIME,QUOTESIDE,QUOTETIMING,SOURCE,ITM_OTM)
    select asset.IDASSET,asset.ASSETCATEGORY,asset.IDASSET_UNL,asset.ASSETCATEGORY_UNL,null,null,asset.UNLQUOTE_TIME,
    case 
      when (asset.CATEGORY='O' and asset.ATMATURITY='1') then asset.FINALSETTLTSIDE
      when (asset.CATEGORY='O' and asset.ATMATURITY='0') then 'OfficialClose'
      else null 
    end as QUOTESIDE,
    'Close',null,'N/A'
    from ASSET_EOD_%%SHORTSESSIONID%%_W asset
    where not exists (select 1 from ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W quote where quote.IDASSET = asset.IDASSET and quote.ASSETCATEGORY = asset.ASSETCATEGORY);]]>
      </Command>
      <Command rdbms = "oracle">
        <![CDATA[truncate table ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W purge MATERIALIZED VIEW LOG reuse STORAGE]]>
      </Command>
      <Command rdbms = "oracle">
        <![CDATA[
    insert into ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W (IDASSET,ASSETCATEGORY,IDASSET_UNL,ASSETCATEGORY_UNL,IDQUOTE_H,VALUE,TIME,QUOTESIDE,QUOTETIMING,SOURCE,ITM_OTM)
    with ASSET_EOD_OPT_W as (
      select asset.IDASSET,asset.ASSETCATEGORY,asset.IDASSET_UNL,asset.ASSETCATEGORY_UNL,
      asset.CATEGORY,asset.ATMATURITY,asset.FINALSETTLTSIDE,asset.UNLQUOTE_TIME,asset.FINALSETTLTTIME,asset.PUTCALL,
      case 
        when asset.ASSETCATEGORY_UNL='Future' then
          case 
            when isnull(dc_unl.INSTRUMENTNUM,1) <= 1 and dc_unl.INSTRUMENTDEN >= 100 and mod(dc_unl.INSTRUMENTDEN,100) = 0 
              then asset.STRIKEPRICE
            else 
              floor(asset.STRIKEPRICE) + 
              ((asset.STRIKEPRICE - floor(asset.STRIKEPRICE)) * 
              case when isnull(dc_unl.INSTRUMENTDEN,0)<=0 then 1 else dc_unl.INSTRUMENTDEN end / 
              (100 * case when isnull(dc_unl.INSTRUMENTNUM,0)=0 then 1 else dc_unl.INSTRUMENTNUM end))
            end
        else 
          asset.STRIKEPRICE
      end as STRIKE_UNLBASE, asset.ITMCONDITION    
      from ASSET_EOD_%%SHORTSESSIONID%%_W asset
      left outer join dbo.ASSET_ETD asset_unl on (asset.ASSETCATEGORY_UNL='Future' and asset_unl.IDASSET = asset.IDASSET_UNL)
      left outer join dbo.DERIVATIVEATTRIB da_unl on (da_unl.IDDERIVATIVEATTRIB = asset_unl.IDDERIVATIVEATTRIB)
      left outer join dbo.DERIVATIVECONTRACT dc_unl on (dc_unl.IDDC = da_unl.IDDC)
      where asset.CATEGORY = 'O'
    )        
    select asset.IDASSET,asset.ASSETCATEGORY,asset.IDASSET_UNL,asset.ASSETCATEGORY_UNL,quoteUnl.IDQUOTE_H,quoteUnl.VALUE,quoteUnl.TIME,quoteUnl.QUOTESIDE,quoteUnl.QUOTETIMING,quoteUnl.SOURCE,
    case 
      when asset.PUTCALL='1' and asset.STRIKE_UNLBASE < quoteUnl.VALUE then 'In the money' 
      when asset.PUTCALL='1' and asset.STRIKE_UNLBASE > quoteUnl.VALUE then 'Out the money'
      when asset.PUTCALL='1' and asset.STRIKE_UNLBASE = quoteUnl.VALUE 
        then case when asset.ITMCONDITION in ('1','2') then 'At the money (ITM)' else 'At the money (OTM)' end
      when asset.PUTCALL='0' and asset.STRIKE_UNLBASE > quoteUnl.VALUE then 'In the money'
      when asset.PUTCALL='0' and asset.STRIKE_UNLBASE < quoteUnl.VALUE then 'Out the money'
      when asset.PUTCALL='0' and asset.STRIKE_UNLBASE = quoteUnl.VALUE 
        then case when asset.ITMCONDITION in ('1','3') then 'At the money (ITM)' else 'At the money (OTM)' end
      else 'N/A' 
    end as ITM_OTM
    from ASSET_EOD_OPT_W asset
    inner join dbo.VW_QUOTE_H quoteUnl on quoteUnl.IDASSET = asset.IDASSET_UNL 
    and quoteUnl.ASSETCATEGORY = asset.ASSETCATEGORY_UNL 
    and quoteUnl.QUOTESIDE = asset.FINALSETTLTSIDE 
    and quoteUnl.QUOTETIMING = 'Close' 
    and (
      (quoteUnl.TIME = asset.UNLQUOTE_TIME and asset.FINALSETTLTTIME != '00:00')
      or
      (convert(varchar,quoteUnl.TIME,112) = convert(varchar,asset.UNLQUOTE_TIME,112))
    )
    where asset.ATMATURITY = '1' and asset.FINALSETTLTSIDE is not null
    
    union all
    
    select quote.IDASSET,quote.ASSETCATEGORY,quote.IDASSET_UNL,quote.ASSETCATEGORY_UNL,quote.IDQUOTE_H,quote.VALUE,quote.TIME,quote.QUOTESIDE,quote.QUOTETIMING,quote.SOURCE,
    case 
      when quote.PUTCALL='1' and quote.STRIKE_UNLBASE < quote.VALUE then 'In the money' 
      when quote.PUTCALL='1' and quote.STRIKE_UNLBASE > quote.VALUE then 'Out the money'
      when quote.PUTCALL='1' and quote.STRIKE_UNLBASE = quote.VALUE 
        then case when quote.ITMCONDITION in ('1','2') then 'At the money (ITM)' else 'At the money (OTM)' end
      when quote.PUTCALL='0' and quote.STRIKE_UNLBASE > quote.VALUE then 'In the money'
      when quote.PUTCALL='0' and quote.STRIKE_UNLBASE < quote.VALUE then 'Out the money'
      when quote.PUTCALL='0' and quote.STRIKE_UNLBASE = quote.VALUE 
        then case when quote.ITMCONDITION in ('1','3') then 'At the money (ITM)' else 'At the money (OTM)' end
      else 'N/A' 
    end as ITM_OTM
    from (
      select asset.IDASSET,asset.ASSETCATEGORY,asset.IDASSET_UNL,asset.ASSETCATEGORY_UNL, 
      quoteUnl.IDQUOTE_H,quoteUnl.VALUE,quoteUnl.TIME,quoteUnl.QUOTESIDE,quoteUnl.QUOTETIMING,quoteUnl.SOURCE,
      asset.PUTCALL,asset.STRIKE_UNLBASE,asset.ITMCONDITION,
      ROW_NUMBER() OVER( PARTITION BY asset.IDASSET order by quoteUnl.TIME desc,
          case isnull(quoteUnl.QUOTESIDE,'OfficialClose') when 'OfficialSettlement' then 0 when 'OfficialClose' then 1 else 2 end asc
      ) AS ROWORDER
      from ASSET_EOD_OPT_W asset
      inner join dbo.VW_QUOTE_H quoteUnl on quoteUnl.IDASSET = asset.IDASSET_UNL 
      and quoteUnl.ASSETCATEGORY = asset.ASSETCATEGORY_UNL 
      and quoteUnl.QUOTESIDE in ('OfficialClose','OfficialSettlement') 
      and quoteUnl.QUOTETIMING = 'Close' 
      and (
        (quoteUnl.TIME = asset.UNLQUOTE_TIME and asset.FINALSETTLTTIME != '00:00')
        or
        (convert(varchar,quoteUnl.TIME,112) = convert(varchar,asset.UNLQUOTE_TIME,112))
      )
      where asset.ATMATURITY = '1' and asset.FINALSETTLTSIDE is null
    ) quote
    where (quote.ROWORDER=1)
    
    union all
    
    select asset.IDASSET,asset.ASSETCATEGORY,asset.IDASSET_UNL,asset.ASSETCATEGORY_UNL, quoteUnl.IDQUOTE_H,quoteUnl.VALUE,quoteUnl.TIME,quoteUnl.QUOTESIDE,quoteUnl.QUOTETIMING,quoteUnl.SOURCE,
    case 
      when asset.PUTCALL='1' and asset.STRIKE_UNLBASE < quoteUnl.VALUE then 'In the money' 
      when asset.PUTCALL='1' and asset.STRIKE_UNLBASE > quoteUnl.VALUE then 'Out the money'
      when asset.PUTCALL='1' and asset.STRIKE_UNLBASE = quoteUnl.VALUE 
        then case when asset.ITMCONDITION in ('1','2') then 'At the money (ITM)' else 'At the money (OTM)' end
      when asset.PUTCALL='0' and asset.STRIKE_UNLBASE > quoteUnl.VALUE then 'In the money'
      when asset.PUTCALL='0' and asset.STRIKE_UNLBASE < quoteUnl.VALUE then 'Out the money'
      when asset.PUTCALL='0' and asset.STRIKE_UNLBASE = quoteUnl.VALUE 
        then case when asset.ITMCONDITION in ('1','3') then 'At the money (ITM)' else 'At the money (OTM)' end
      else 'N/A' 
    end as ITM_OTM
    from ASSET_EOD_OPT_W asset
    inner join dbo.VW_QUOTE_H quoteUnl on quoteUnl.IDASSET = asset.IDASSET_UNL 
    and quoteUnl.ASSETCATEGORY = asset.ASSETCATEGORY_UNL 
    and quoteUnl.QUOTESIDE = 'OfficialClose' 
    and quoteUnl.QUOTETIMING = 'Close' 
    and (convert(varchar,quoteUnl.TIME,112) = convert(varchar,asset.UNLQUOTE_TIME,112))
    where asset.ATMATURITY = '0';
        
    insert into ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W (IDASSET,ASSETCATEGORY,IDASSET_UNL,ASSETCATEGORY_UNL,IDQUOTE_H,VALUE,TIME,QUOTESIDE,QUOTETIMING,SOURCE,ITM_OTM)
    select asset.IDASSET,asset.ASSETCATEGORY,asset.IDASSET_UNL,asset.ASSETCATEGORY_UNL,null,null,asset.UNLQUOTE_TIME,
    case 
      when (asset.CATEGORY='O' and asset.ATMATURITY='1') then asset.FINALSETTLTSIDE
      when (asset.CATEGORY='O' and asset.ATMATURITY='0') then 'OfficialClose'
      else null 
    end as QUOTESIDE,
    'Close',null,'N/A'
    from ASSET_EOD_%%SHORTSESSIONID%%_W asset
    where not exists (select 1 from ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W quote where quote.IDASSET= asset.IDASSET and quote.ASSETCATEGORY = asset.ASSETCATEGORY);]]>
      </Command>
    </SQLPreSelect>

    <SQLPreSelect>
      <!-- Cours pour CFD et EquitySecurityTransaction et DebtSecurityTransaction -->
      <ConditionDynamicArg  grp="ACTIVITYTYPE">
        <DynamicArgValue name="ACTIVITYTYPE">2</DynamicArgValue>
      </ConditionDynamicArg>
      <Command rdbms = "all">
        <![CDATA[
        delete from ASSET_EOD_%%SHORTSESSIONID%%_W;
        
        insert into ASSET_EOD_%%SHORTSESSIONID%%_W (IDASSET,ASSETCATEGORY,IDDC,CATEGORY,MATURITYDATE,MATURITYDATESYS,PUTCALL,STRIKEPRICE,ITMCONDITION,LASTTRADINGDAY,ATMATURITY,EXERCISESTYLE,EXERCISESTYLE2,IDASSET_UNL,ASSETCATEGORY_UNL,ATMATURITY_UNL,FINALSETTLTPRICE,FINALSETTLTSIDE,FINALSETTLTTIME)
        select asset.IDASSET,asset.ASSETCATEGORY,null as IDDC,null as CATEGORY, null as MATURITYDATE,null as MATURITYDATESYS, null as PUTCALL, null as STRIKEPRICE, null as ITMCONDITION,
        null as LASTTRADINGDAY, null as ATMATURITY,
        null as EXERCISESTYLE, null as EXERCISESTYLE2,
        null as IDASSET_UNL, null as ASSETCATEGORY_UNL, null as ATMATURITY_UNL,
        null as FINALSETTLPRICE, null as FINALSETTLTSIDE, null as FINALSETTLTTIME
        from (
          select distinct a.IDASSET as IDASSET, a.ASSETCATEGORY as ASSETCATEGORY
          from (
            select t.IDASSET as IDASSET, t.ASSETCATEGORY as ASSETCATEGORY
            from dbo.TRADE t
            %%CC:ITRADE_JOIN%%(t)
            %%SR:TRADE_JOIN%%(t.IDT, t)
            inner join dbo.VW_INSTR_PRODUCT product on (product.IDI=t.IDI) and (product.FUNGIBILITYMODE != 'NONE') and product.GPRODUCT in ('OTC','SEC')
            left outer join (
              select pad.IDT_BUY as IDT, sum(isnull(pad.QTY,0)) as QTY_BUY, 0 as QTY_SELL
              from dbo.TRADE alloc 
              inner join dbo.POSACTIONDET pad on (pad.IDT_BUY = alloc.IDT)
              inner join dbo.POSACTION pa on (pa.IDPA = pad.IDPA)
              where (pa.DTOUT is null or pa.DTOUT > @DATE1) and (pa.DTBUSINESS <= @DATE1) and ((pad.DTCAN is null) or (pad.DTCAN > @DATE1))
              group by pad.IDT_BUY

              union all

              select pad.IDT_SELL as IDT, 0 as QTY_BUY, sum(isnull(pad.QTY,0)) as QTY_SELL
              from dbo.TRADE alloc 
              inner join dbo.POSACTIONDET pad on (pad.IDT_SELL = alloc.IDT)
              inner join dbo.POSACTION pa on (pa.IDPA = pad.IDPA)
              where (pa.DTOUT is null or pa.DTOUT > @DATE1) and (pa.DTBUSINESS <= @DATE1) and ((pad.DTCAN is null) or (pad.DTCAN > @DATE1))
              group by pad.IDT_SELL
            ) pos on (pos.IDT = t.IDT)
            inner join dbo.BOOK bd on (bd.IDB=t.IDB_DEALER) and  (bd.ISPOSKEEPING=1)
            <choose>
              <when test="{ENTITY}>-1"> and bd.IDA_ENTITY=@ENTITY </when>
            </choose>
            inner join dbo.VW_ENTITYMARKET_ACTIVITY em on (em.IDA = t.IDA_ENTITY) and (em.IDM = t.IDM) and (em.IDA_CSSCUSTODIAN = t.IDA_CSSCUSTODIAN)
              <choose>
                <when test="{CSSCUSTODIAN}>0"> and (em.IDA_CSSCUSTODIAN=@CSSCUSTODIAN) </when>
                <when test="{CSSCUSTODIAN}=-1"> and (1=1) </when>
                <otherwise> and (em.CSSCUSTODIAN=@CSSCUSTODIAN) </otherwise>
            </choose>                  
            where (t.DTBUSINESS<=@DATE1)
            and (t.IDSTBUSINESS = 'ALLOC') and (t.IDSTACTIVATION = 'REGULAR')
            and (
              ((t.QTY - isnull(pos.QTY_BUY, 0) - isnull(pos.QTY_SELL, 0)) > 0 )
              or 
              (t.DTBUSINESS=@DATE1)
            )
            and (%%SR:TRADE_WHERE_PREDICATE%%)
            and (%%CC:ITRADE_WHERE_PREDICATE%%)
            union all
            select t.IDASSET as IDASSET, t.ASSETCATEGORY as ASSETCATEGORY
            from dbo.TRADE t
            %%CC:ITRADE_JOIN%%(t)
            %%SR:TRADE_JOIN%%(t.IDT, t)
            inner join dbo.VW_INSTR_PRODUCT product on (product.IDI=t.IDI) and (product.FUNGIBILITYMODE != 'NONE') and product.GPRODUCT in ('OTC','SEC') and product.ISSAFEKEEPING=1 
            left outer join (
              select pad.IDT_BUY as IDT,
              sum(case when isnull(tr.DTSETTLT,@DATE1) <= @DATE1 then isnull(pad.QTY,0) else 0 end) as QTY_BUY, 0 as QTY_SELL
              from dbo.TRADE alloc 
              inner join dbo.POSACTIONDET pad on (pad.IDT_BUY = alloc.IDT)
              inner join dbo.POSACTION pa on (pa.IDPA = pad.IDPA) 
              left outer join dbo.TRADE tr on (tr.IDT = pad.IDT_SELL) 
              where ((pa.DTOUT is null or pa.DTOUT > @DATE1) and (pa.DTBUSINESS <= @DATE1) and ((pad.DTCAN is null) or (pad.DTCAN > @DATE1)))
              group by pad.IDT_BUY
	                  
              union all
	                  
              select pad.IDT_SELL as IDT,
              0 as QTY_BUY, sum(case when isnull(tr.DTSETTLT,@DATE1) <= @DATE1  then isnull(pad.QTY,0) else 0 end) as QTY_SELL
              from dbo.TRADE alloc 
              inner join dbo.POSACTIONDET pad on (pad.IDT_SELL = alloc.IDT)
              inner join dbo.POSACTION pa on (pa.IDPA = pad.IDPA) 
              left outer join dbo.TRADE tr on (tr.IDT = pad.IDT_BUY) 
              where ((pa.DTOUT is null or pa.DTOUT > @DATE1) and (pa.DTBUSINESS <= @DATE1) and ((pad.DTCAN is null) or (pad.DTCAN > @DATE1)))
                    
              group by pad.IDT_SELL          
            ) pos on (pos.IDT = t.IDT)
            inner join dbo.BOOK bd on (bd.IDB=t.IDB_DEALER) and  (bd.ISPOSKEEPING=1)
            <choose>
              <when test="{ENTITY}>-1"> and bd.IDA_ENTITY=@ENTITY </when>
            </choose>
            inner join dbo.VW_ENTITYMARKET_ACTIVITY em on (em.IDA = t.IDA_ENTITY) and (em.IDM = t.IDM) and (em.IDA_CSSCUSTODIAN = t.IDA_CSSCUSTODIAN)
            <choose>
                <when test="{CSSCUSTODIAN}>0"> and em.IDA_CSSCUSTODIAN=@CSSCUSTODIAN </when>
                <when test="{CSSCUSTODIAN}=-1"> and (1=1) </when>
                <otherwise> and em.CSSCUSTODIAN=@CSSCUSTODIAN </otherwise>
            </choose>                  
            where (t.DTBUSINESS<=@DATE1)
            and (t.IDSTBUSINESS = 'ALLOC') and (t.IDSTACTIVATION = 'REGULAR')
            and (
              ((t.QTY - isnull(pos.QTY_BUY, 0) - isnull(pos.QTY_SELL, 0)) > 0 )
              or 
              (t.DTBUSINESS=@DATE1)
            )
            and (%%CC:ITRADE_WHERE_PREDICATE%%)
            and (%%SR:TRADE_WHERE_PREDICATE%%)
          ) a
        ) asset;]]>
      </Command>

      <Command rdbms = "all">
        <![CDATA[
        delete from ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W;

        insert into ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W (IDASSET, ASSETCATEGORY, IDQUOTE_H, VALUE,TIME, QUOTESIDE, QUOTETIMING,SOURCE)
        select asset.IDASSET,asset.ASSETCATEGORY, quoteUnl.IDQUOTE_H,quoteUnl.VALUE,quoteUnl.TIME,quoteUnl.QUOTESIDE,quoteUnl.QUOTETIMING,quoteUnl.SOURCE
        from ASSET_EOD_%%SHORTSESSIONID%%_W asset
        left outer join dbo.VW_QUOTE_H quoteUnl on quoteUnl.IDASSET = asset.IDASSET 
        and quoteUnl.ASSETCATEGORY = asset.ASSETCATEGORY 
        and quoteUnl.QUOTESIDE = 'OfficialClose' 
        and quoteUnl.QUOTETIMING = 'Close';
        ]]>
      </Command>
    </SQLPreSelect>

    <SQLSelect>
      <!--
      Liste des cotations nécessaires à une journée de bourse pour les ETD

      1/prix OfficialClose des assets futures non arrivés à échéance
      2/prix OfficialClose des assets futures arrivés à échéance
      3/prix OfficialClose des assets options non arrivés à échéance
      4/prix OfficialClose des assets options arrivés à échéance  (Rq prix non nécessaire à Spheres® pour la gestion des options)
      
      5/prix OfficialClose des sous-jacent de type Future des assets option non arrivé à échéance de type Americaine
      6/prix OfficialSettlement/OfficialClose des sous-jacent de type Future des assets option arrivés à échéance

      7/prix OfficialClose des sous-jacent de type Index des assets option non arrivé à échéance de type Americaine
      8/prix OfficialSettlement/OfficialClose des sous-jacent de type Index des assets option arrivés à échéance

      9/prix OfficialClose des sous-jacent de type EquityAsset des assets option non arrivé à échéance de type Americaine
      10/prix OfficialSettlement/OfficialClose des sous-jacent de type EquityAsset des assets option arrivés à échéance

      11/prix OfficialClose des sous-jacent de type Commodity des assets option non arrivé à échéance de type Americaine
      12/prix OfficialSettlement/OfficialClose des sous-jacent de type Commodity des assets option arrivés à échéance

      13/prix OfficialClose des sous-jacent de type ExchangeTradedFund des assets option non arrivé à échéance de type Americaine
      14/prix OfficialSettlement/OfficialClose des sous-jacent de type ExchangeTradedFund des assets option arrivés à échéance
      -->
      <ConditionDynamicArg  grp="ACTIVITYTYPE">
        <DynamicArgValue name="ACTIVITYTYPE">1</DynamicArgValue>
      </ConditionDynamicArg>

      <Command rdbms = "sqlserver">
        <![CDATA[
  /*ETD*/
  select 
  @ACTIVITYTYPE as ACTIVITYTYPE,
  case 
    when (isnull(q.IDQUOTE_H,0) = 0) then
      case when (dc.CATEGORY = 'O') and (a.ATMATURITY='1') then 'Optional' else 'Missing' end  
    when (isnull(q.IDQUOTE_H,0) > 0 ) and (isnull(q.ISENABLED,1) = 0) then 'NotCertified' 
    else 'Available'
  end as PRICESTATUS,  
  convert(varchar,isnull(q.IDQUOTE_H,0)) || ';' || 'ETD' || ';' || convert(varchar,aETD.IDASSET) as KEYVALUE,
  aETD.IDASSET,aETD.IDENTIFIER as ASSET_IDENTIFIER, aETD.DISPLAYNAME as ASSET_DSP,'ExchangeTradedContract' as ASSET_TYPE,
  dc.IDM as ASSET_IDM,
  da.IDDC as ASSET_IDDC,
  dc.IDENTIFIER as ASSET_DC_IDENT,
  dc.DISPLAYNAME as ASSET_DC_DSP,
  da.IDMATURITY as ASSET_IDMATURITY,
  ma.MATURITYMONTHYEAR as ASSET_MATFMT_PROFIL,
  ma.MATURITYMONTHYEAR as ASSET_MATFMT_FIX,
  ma.MATURITYDATE as ASSET_MATURITYDATE,
  dc.CATEGORY as ASSET_CATEGORY,
  case aETD.PUTCALL when '0' then 'Put' when '1' then 'Call' else '' end as ASSET_PUTCALL,
  aETD.STRIKEPRICE as ASSET_STRIKEPRICE,
  dc.MINPRICEINCRAMOUNT as ASSET_TICKVALUE,
  dc.MINPRICEINCR as ASSET_TICKSIZE,
  (case when aETD.CONTRACTMULTIPLIER is null then (case when da.CONTRACTMULTIPLIER is null then dc.CONTRACTMULTIPLIER else da.CONTRACTMULTIPLIER end) else aETD.CONTRACTMULTIPLIER end)
    / (case when (c.IDC != isnull(c.IDCQUOTED,c.IDC)) and ((isnull(c.FACTOR,1)) > 0) then isnull(c.FACTOR,1) else 1 end) as ASSET_MULTIPLIER,
  dc.INSTRUMENTDEN as ASSET_DEN,
  isnull(aETD.ISINCODE,dc.ISINCODE) as ASSET_ISINCODE,
  isnull(unlQuote.ITM_OTM,'N/A') as ASSET_ITM_OTM,
  a.ATMATURITY as ASSET_ATMATURITY,
  isnull(q.IDQUOTE_H,0) as IDQUOTE_H, 
  isnull(q.IDMARKETENV, a.IDMARKETENV) as IDMARKETENV, 
  isnull(q.IDVALSCENARIO,a.IDVALSCENARIO) as IDVALSCENARIO, 
  isnull(q.QUOTESIDE,a.QUOTESIDE) as QUOTESIDE, 
  isnull(q.ISENABLED,1) as ISENABLED, 
  isnull(q.TIME,a.TIME) as TIME,
  isnull(q.QUOTETIMING,a.QUOTETIMING) as QUOTETIMING, 
  q.CASHFLOWTYPE as CASHFLOWTYPE,
  q.VALUE as VALUE, 
  isnull(q.QUOTEUNIT,'Price') as QUOTEUNIT, 
  q.SPREADVALUE as SPREADVALUE,
  q.TIMETOEXPIRATION as TIMETOEXPIRATION,
  q.EXPIRITYTIME as EXPIRITYTIME,
  q.CONTRACTMULTIPLIER as CONTRACTMULTIPLIER,
  q.SOURCE as  SOURCE,
  q.ASSETMEASURE as ASSETMEASURE,
  q.IDC as IDC,q.IDBC as IDBC,q.IDM as IDM,
  q.IDAINS as IDAINS,q.DTINS as DTINS,q.IDAUPD as IDAUPD,q.DTUPD as DTUPD ,
  q.EXTLLINK as EXTLLINK,q.ROWATTRIBUT as ROWATTRIBUT,q.ROWVERSION as ROWVERSION,
  unl.IDM as ASSETUNL_IDM,
  unl.IDASSET as IDASSET_UNL,
  unl.ASSETCATEGORY as ASSETCATEGORY_UNL,
  unl.IDENTIFIER as ASSETUNL_IDENT,
  unlQuote.TIME as ASSETUNLQUOTE_TIME,
  unlQuote.QUOTESIDE as ASSETUNLQUOTE_QUOTESIDE,
  unlQuote.QUOTETIMING as ASSETUNLQUOTE_QUOTETIMING,
  unlQuote.VALUE as ASSETUNLQUOTE_VALUE,
  unlQuote.SOURCE as ASSETUNLQUOTE_SOURCE
  from (
    /* 1/prix OfficialClose des assets futures non arrivés à échéance */
    /* 2/prix OfficialClose des assets futures arrivés à échéance */
    /* 3/prix OfficialClose des assets options non arrivés à échéance */
    /* 4/prix OfficialClose des assets options arrivés à échéance */
    select a.IDASSET as IDASSET, 'OfficialClose' as QUOTESIDE, 'Close' as QUOTETIMING,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, @DATE1 as TIME, 'Between' as OPERATOR, a.ATMATURITY
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
  ) a
  inner join dbo.ASSET_ETD aETD on aETD.IDASSET = a.IDASSET
  inner join dbo.DERIVATIVEATTRIB da on da.IDDERIVATIVEATTRIB = aETD.IDDERIVATIVEATTRIB
  inner join dbo.DERIVATIVECONTRACT dc on dc.IDDC = da.IDDC
  inner join dbo.MATURITY ma on ma.IDMATURITY = da.IDMATURITY
  inner join CURRENCY c on (c.IDC = dc.IDC_PRICE)
  left outer join ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W unlQuote on unlQuote.IDASSET = a.IDASSET and dc.CATEGORY = 'O' 
  left outer join dbo.VW_ASSET unl on unl.IDASSET = unlQuote.IDASSET_UNL and unl.ASSETCATEGORY = unlQuote.ASSETCATEGORY_UNL
  left outer join dbo.QUOTE_ETD_H q on q.IDASSET=aETD.IDASSET 
  and (
    (q.TIME = a.TIME and a.OPERATOR = 'Equal')
    or
    (convert(varchar,q.TIME,112) = convert(varchar,a.TIME,112) and a.OPERATOR = 'Between')
  )
  and (isnull(q.QUOTESIDE,'OfficialClose') = a.QUOTESIDE)
  and (isnull(q.QUOTETIMING,'Close')= a.QUOTETIMING) 
  and (q.IDMARKETENV=a.IDMARKETENV) and (q.IDVALSCENARIO=a.IDVALSCENARIO)  
  
  union
  
  select 
  @ACTIVITYTYPE as ACTIVITYTYPE,
  case 
    when (isnull(q.IDQUOTE_H,0) = 0) then
      case when (dc.CATEGORY = 'O') and (a.ATMATURITY='1') then 'Optional' else 'Missing' end  
    when (isnull(q.IDQUOTE_H,0) > 0 ) and (isnull(q.ISENABLED,1) = 0) then 'NotCertified' 
    else 'Available'
  end as PRICESTATUS,  
  convert(varchar,isnull(q.IDQUOTE_H,0)) || ';' || 'ETD' || ';' || convert(varchar,aETD.IDASSET) as KEYVALUE,
  aETD.IDASSET,aETD.IDENTIFIER as ASSET_IDENTIFIER, aETD.DISPLAYNAME as ASSET_DSP,'ExchangeTradedContract' as ASSET_TYPE,
  dc.IDM as ASSET_IDM,
  da.IDDC as ASSET_IDDC,
  dc.IDENTIFIER as ASSET_DC_IDENT,
  dc.DISPLAYNAME as ASSET_DC_DSP,
  da.IDMATURITY as ASSET_IDMATURITY,
  ma.MATURITYMONTHYEAR as ASSET_MATFMT_PROFIL,
  ma.MATURITYMONTHYEAR as ASSET_MATFMT_FIX,
  ma.MATURITYDATE as ASSET_MATURITYDATE,
  dc.CATEGORY as ASSET_CATEGORY,
  case aETD.PUTCALL when '0' then 'Put' when '1' then 'Call' else '' end as ASSET_PUTCALL,
  aETD.STRIKEPRICE as ASSET_STRIKEPRICE,
  dc.MINPRICEINCRAMOUNT as ASSET_TICKVALUE,
  dc.MINPRICEINCR as ASSET_TICKSIZE,
  (case when aETD.CONTRACTMULTIPLIER is null then (case when da.CONTRACTMULTIPLIER is null then dc.CONTRACTMULTIPLIER else da.CONTRACTMULTIPLIER end) else aETD.CONTRACTMULTIPLIER end)
    / (case when (c.IDC != isnull(c.IDCQUOTED,c.IDC)) and ((isnull(c.FACTOR,1)) > 0) then isnull(c.FACTOR,1) else 1 end) as ASSET_MULTIPLIER,
  dc.INSTRUMENTDEN as ASSET_DEN,
  isnull(aETD.ISINCODE,dc.ISINCODE) as ASSET_ISINCODE,
  'N/A' as ASSET_ITM_OTM,
  a.ATMATURITY as ASSET_ATMATURITY,
  isnull(q.IDQUOTE_H,0) as IDQUOTE_H, 
  isnull(q.IDMARKETENV, a.IDMARKETENV) as IDMARKETENV, 
  isnull(q.IDVALSCENARIO,a.IDVALSCENARIO) as IDVALSCENARIO, 
  isnull(q.QUOTESIDE,a.QUOTESIDE) as QUOTESIDE, 
  isnull(q.ISENABLED,1) as ISENABLED, 
  isnull(q.TIME,a.TIME) as TIME,
  isnull(q.QUOTETIMING,a.QUOTETIMING) as QUOTETIMING, 
  q.CASHFLOWTYPE as CASHFLOWTYPE,
  q.VALUE as VALUE, 
  isnull(q.QUOTEUNIT,'Price') as QUOTEUNIT, 
  q.SPREADVALUE as SPREADVALUE,
  q.TIMETOEXPIRATION as TIMETOEXPIRATION,
  q.EXPIRITYTIME as EXPIRITYTIME,
  q.CONTRACTMULTIPLIER as CONTRACTMULTIPLIER,
  q.SOURCE as  SOURCE,
  q.ASSETMEASURE as ASSETMEASURE,
  q.IDC as IDC,q.IDBC as IDBC,q.IDM as IDM,
  q.IDAINS as IDAINS,q.DTINS as DTINS,q.IDAUPD as IDAUPD,q.DTUPD as DTUPD ,
  q.EXTLLINK as EXTLLINK,q.ROWATTRIBUT as ROWATTRIBUT,q.ROWVERSION as ROWVERSION,
  null as ASSETUNL_IDM,
  null as IDASSET_UNL,
  null as ASSETCATEGORY_UNL,
  null as ASSETUNL_IDENT,
  null as ASSETUNLQUOTE_TIME,
  null as ASSETUNLQUOTE_QUOTESIDE,
  null as ASSETUNLQUOTE_QUOTETIMING,
  null as ASSETUNLQUOTE_VALUE,
  null as ASSETUNLQUOTE_SOURCE
  from (
    /* 5/prix OfficialClose des sous-jacent de type Future des assets option non arrivé à échéance de type Americaine */
    select a.IDASSET_UNL as IDASSET, 'OfficialClose' as QUOTESIDE, 'Close' as QUOTETIMING,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, a.UNLQUOTE_TIME as TIME, 'Between' as OPERATOR, a.ATMATURITY_UNL as ATMATURITY, unlQuote.IDQUOTE_H
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
    left outer join ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W unlQuote on unlQuote.IDASSET = a.IDASSET
    where a.CATEGORY='O' and a.ATMATURITY='0' and a.EXERCISESTYLE=1
    and a.IDASSET_UNL is not null and a.ASSETCATEGORY_UNL='Future'    
    union
    /* 6/prix OfficialSettlement/OfficialClose des sous-jacent de type Future des assets option arrivés à échéance */
    select a.IDASSET_UNL as IDASSET, unlQuote.QUOTESIDE as QUOTESIDE, 'Close' as QUOTETIMING,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, a.UNLQUOTE_TIME as TIME,
    case when a.FINALSETTLTTIME != '00:00' then 'Equal' else 'Between' end as OPERATOR, a.ATMATURITY_UNL as ATMATURITY, unlQuote.IDQUOTE_H
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
    left outer join ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W unlQuote on unlQuote.IDASSET = a.IDASSET
    where a.CATEGORY='O' and a.ATMATURITY='1'
    and a.IDASSET_UNL is not null and a.ASSETCATEGORY_UNL='Future'
  ) a
  inner join dbo.ASSET_ETD aETD on aETD.IDASSET = a.IDASSET
  inner join dbo.DERIVATIVEATTRIB da on da.IDDERIVATIVEATTRIB = aETD.IDDERIVATIVEATTRIB
  inner join dbo.DERIVATIVECONTRACT dc on dc.IDDC = da.IDDC
  inner join dbo.MATURITY ma on ma.IDMATURITY = da.IDMATURITY
  inner join CURRENCY c on (c.IDC = dc.IDC_PRICE)
  left outer join dbo.QUOTE_ETD_H q on q.IDQUOTE_H = a.IDQUOTE_H
  
  union
  
  /*INDEX*/    
  select 
  @ACTIVITYTYPE as ACTIVITYTYPE,
  case 
    when (isnull(q.IDQUOTE_H,0) = 0) then 'Missing'  
    when (isnull(q.IDQUOTE_H,0) > 0 ) and (isnull(q.ISENABLED,1) = 0) then 'NotCertified' 
    else 'Available' 
  end as PRICESTATUS,  
  convert(varchar,isnull(q.IDQUOTE_H,0)) || ';' || 'INDEX' || ';' || convert(varchar,aRI.IDASSET) as KEYVALUE,
  aRI.IDASSET,aRI.IDENTIFIER as ASSET_IDENTIFIER, aRI.DISPLAYNAME as ASSET_DSP,'Index' as ASSET_TYPE,
  aRI.IDM as ASSET_IDM,
  null as ASSET_IDDC,
  null as ASSET_DC_IDENT,
  null as ASSET_DC_DSP,
  null as ASSET_IDMATURITY,
  null as ASSET_MATFMT_PROFIL,
  null as ASSET_MATFMT_FIX,
  null as ASSET_MATURITYDATE,
  null as ASSET_CATEGORY,
  null as ASSET_PUTCALL,
  null as ASSET_STRIKEPRICE,
  null as ASSET_TICKVALUE,
  null as ASSET_TICKSIZE,
  null as ASSET_MULTIPLIER,
  null as ASSET_DEN,
  aRI.ISINCODE as ASSET_ISINCODE,
  null as ASSET_ITM_OTM,
  null as ASSET_ATMATURITY,
  isnull(q.IDQUOTE_H,0) as IDQUOTE_H, 
  isnull(q.IDMARKETENV, a.IDMARKETENV) as IDMARKETENV, 
  isnull(q.IDVALSCENARIO,a.IDVALSCENARIO) as IDVALSCENARIO, 
  isnull(q.QUOTESIDE,a.QUOTESIDE) as QUOTESIDE, 
  isnull(q.ISENABLED,1) as ISENABLED, 
  isnull(q.TIME,a.TIME) as TIME,
  isnull(q.QUOTETIMING,a.QUOTETIMING) as QUOTETIMING, 
  q.CASHFLOWTYPE as CASHFLOWTYPE,
  q.VALUE as VALUE, 
  isnull(q.QUOTEUNIT,'Price') as QUOTEUNIT, 
  isnull(q.SPREADVALUE,0) as SPREADVALUE,
  null as TIMETOEXPIRATION,
  q.EXPIRITYTIME as EXPIRITYTIME,
  null as CONTRACTMULTIPLIER,
  isnull(q.SOURCE,'NA') as  SOURCE,
  q.ASSETMEASURE as ASSETMEASURE,
  q.IDC as IDC,q.IDBC as IDBC,q.IDM as IDM,
  q.IDAINS as IDAINS,q.DTINS as DTINS,q.IDAUPD as IDAUPD,q.DTUPD as DTUPD ,
  q.EXTLLINK as EXTLLINK,q.ROWATTRIBUT as ROWATTRIBUT,q.ROWVERSION as ROWVERSION,
  null as ASSETUNL_IDM,
  null as IDASSET_UNL,
  null as ASSETCATEGORY_UNL,
  null as ASSETUNL_IDENT,
  null as ASSETUNLQUOTE_TIME,
  null as ASSETUNLQUOTE_QUOTESIDE,
  null as ASSETUNLQUOTE_QUOTETIMING,
  null as ASSETUNLQUOTE_VALUE,
  null as ASSETUNLQUOTE_SOURCE
  from (
    /* 7/prix OfficialClose des sous-jacent de type Index des assets option non arrivé à échéance de type Americaine */
    select a.IDASSET_UNL as IDASSET, 'OfficialClose' as QUOTESIDE, 'Close' as QUOTETIMING,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, a.UNLQUOTE_TIME as TIME,
    'Between' as OPERATOR, unlQuote.IDQUOTE_H
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
    left outer join ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W unlQuote on unlQuote.IDASSET = a.IDASSET
    where a.CATEGORY='O' and a.ATMATURITY='0' and a.EXERCISESTYLE=1
    and a.IDASSET_UNL is not null and a.ASSETCATEGORY_UNL='Index'
    union
    /* 8/prix OfficialSettlement/OfficialClose des sous-jacent de type Index des assets option arrivés à échéance */
    select a.IDASSET_UNL as IDASSET, unlQuote.QUOTESIDE as QUOTESIDE, 'Close' as QUOTETIMING,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, a.UNLQUOTE_TIME as TIME,
    case when a.FINALSETTLTTIME != '00:00' then 'Equal' else 'Between' end as OPERATOR, unlQuote.IDQUOTE_H
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
    left outer join ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W unlQuote on unlQuote.IDASSET = a.IDASSET
    where a.CATEGORY='O' and a.ATMATURITY='1'
    and a.IDASSET_UNL is not null and a.ASSETCATEGORY_UNL='Index'
  ) a
  inner join dbo.ASSET_INDEX aRI on aRI.IDASSET = a.IDASSET
  left outer join dbo.QUOTE_INDEX_H q on q.IDQUOTE_H = a.IDQUOTE_H
  
  union
  
  /*EQUITY*/
  select 
  @ACTIVITYTYPE as ACTIVITYTYPE,
  case 
    when (isnull(q.IDQUOTE_H,0) = 0) then 'Missing'  
    when (isnull(q.IDQUOTE_H,0) > 0 ) and (isnull(q.ISENABLED,1) = 0) then 'NotCertified' 
    else 'Available' 
  end as PRICESTATUS,  
  convert(varchar,isnull(q.IDQUOTE_H,0)) || ';' || 'EQUITY' || ';' || convert(varchar,aEQ.IDASSET) as KEYVALUE,
  aEQ.IDASSET,aEQ.IDENTIFIER as ASSET_IDENTIFIER, aEQ.DISPLAYNAME as ASSET_DSP, 'EquityAsset' as ASSET_TYPE,
  aEQ.IDM as ASSET_IDM,
  null as ASSET_IDDC,
  null as ASSET_DC_IDENT,
  null as ASSET_DC_DSP,
  null as ASSET_IDMATURITY,
  null as ASSET_MATFMT_PROFIL,
  null as ASSET_MATFMT_FIX,
  null as ASSET_MATURITYDATE,
  null as ASSET_CATEGORY,
  null as ASSET_PUTCALL,
  null as ASSET_STRIKEPRICE,
  null as ASSET_TICKVALUE,
  null as ASSET_TICKSIZE,
  null as ASSET_MULTIPLIER,
  null as ASSET_DEN,
  aEQ.ISINCODE as ASSET_ISINCODE,
  null as ASSET_ITM_OTM,
  null as ASSET_ATMATURITY,
  isnull(q.IDQUOTE_H,0) as IDQUOTE_H, 
  isnull(q.IDMARKETENV, a.IDMARKETENV) as IDMARKETENV, 
  isnull(q.IDVALSCENARIO,a.IDVALSCENARIO) as IDVALSCENARIO, 
  isnull(q.QUOTESIDE,a.QUOTESIDE) as QUOTESIDE, 
  isnull(q.ISENABLED,1) as ISENABLED, 
  isnull(q.TIME,a.TIME) as TIME,
  isnull(q.QUOTETIMING,a.QUOTETIMING) as QUOTETIMING, 
  q.CASHFLOWTYPE as CASHFLOWTYPE,
  q.VALUE as VALUE, 
  isnull(q.QUOTEUNIT,'Price') as QUOTEUNIT, 
  isnull(q.SPREADVALUE,0) as SPREADVALUE,
  null as TIMETOEXPIRATION,
  q.EXPIRITYTIME as EXPIRITYTIME,
  null as CONTRACTMULTIPLIER,
  isnull(q.SOURCE,'NA') as  SOURCE,
  q.ASSETMEASURE as ASSETMEASURE,
  q.IDC as IDC,q.IDBC as IDBC,q.IDM as IDM,
  q.IDAINS as IDAINS,q.DTINS as DTINS,q.IDAUPD as IDAUPD,q.DTUPD as DTUPD ,
  q.EXTLLINK as EXTLLINK,q.ROWATTRIBUT as ROWATTRIBUT,q.ROWVERSION as ROWVERSION,
  null as ASSETUNL_IDM,
  null as IDASSET_UNL,
  null as ASSETCATEGORY_UNL,
  null as ASSETUNL_IDENT,
  null as ASSETUNLQUOTE_TIME,
  null as ASSETUNLQUOTE_QUOTESIDE,
  null as ASSETUNLQUOTE_QUOTETIMING,
  null as ASSETUNLQUOTE_VALUE,
  null as ASSETUNLQUOTE_SOURCE
  from (
    /* 9/prix OfficialClose des sous-jacent de type EquityAsset des assets option non arrivé à échéance de type Americaine */
    select a.IDASSET_UNL as IDASSET, 'OfficialClose' as QUOTESIDE, 'Close' as QUOTETIMING,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, a.UNLQUOTE_TIME as TIME,
    'Between' as OPERATOR, unlQuote.IDQUOTE_H
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
    left outer join ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W unlQuote on unlQuote.IDASSET = a.IDASSET
    where a.CATEGORY='O' and a.EXERCISESTYLE=1 and a.ATMATURITY='0' 
    and a.IDASSET_UNL is not null and a.ASSETCATEGORY_UNL='EquityAsset'
    union
    /* 10/prix OfficialSettlement/OfficialClose des sous-jacent de type EquityAsset des assets option arrivés à échéance */
    select a.IDASSET_UNL as IDASSET, unlQuote.QUOTESIDE as QUOTESIDE, 'Close' as QUOTETIMING,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, a.UNLQUOTE_TIME as TIME,
    case when a.FINALSETTLTTIME != '00:00' then 'Equal' else 'Between' end as OPERATOR, unlQuote.IDQUOTE_H
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
    left outer join ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W unlQuote on unlQuote.IDASSET = a.IDASSET
    where a.CATEGORY='O' and a.ATMATURITY='1'
    and a.IDASSET_UNL is not null and a.ASSETCATEGORY_UNL='EquityAsset'
  ) a
  inner join dbo.ASSET_EQUITY aEQ on aEQ.IDASSET = a.IDASSET
  left outer join dbo.QUOTE_EQUITY_H q on q.IDQUOTE_H = a.IDQUOTE_H

  union
  
  /*COMMODITY*/
  select 
  @ACTIVITYTYPE as ACTIVITYTYPE,
  case 
    when (isnull(q.IDQUOTE_H,0) = 0) then 'Missing'  
    when (isnull(q.IDQUOTE_H,0) > 0 ) and (isnull(q.ISENABLED,1) = 0) then 'NotCertified' 
    else 'Available' 
  end as PRICESTATUS,  
  convert(varchar,isnull(q.IDQUOTE_H,0)) || ';' || 'COMMODITY' || ';' || convert(varchar,aCM.IDASSET) as KEYVALUE,
  aCM.IDASSET,aCM.IDENTIFIER as ASSET_IDENTIFIER, aCM.DISPLAYNAME as ASSET_DSP, 'Commodity' as ASSET_TYPE,
  aCM.IDM as ASSET_IDM,
  null as ASSET_IDDC,
  null as ASSET_DC_IDENT,
  null as ASSET_DC_DSP,
  null as ASSET_IDMATURITY,
  null as ASSET_MATFMT_PROFIL,
  null as ASSET_MATFMT_FIX,
  null as ASSET_MATURITYDATE,
  null as ASSET_CATEGORY,
  null as ASSET_PUTCALL,
  null as ASSET_STRIKEPRICE,
  null as ASSET_TICKVALUE,
  null as ASSET_TICKSIZE,
  null as ASSET_MULTIPLIER,
  null as ASSET_DEN,
  null as ASSET_ISINCODE,
  null as ASSET_ITM_OTM,
  null as ASSET_ATMATURITY,
  isnull(q.IDQUOTE_H,0) as IDQUOTE_H, 
  isnull(q.IDMARKETENV, a.IDMARKETENV) as IDMARKETENV, 
  isnull(q.IDVALSCENARIO,a.IDVALSCENARIO) as IDVALSCENARIO, 
  isnull(q.QUOTESIDE,a.QUOTESIDE) as QUOTESIDE, 
  isnull(q.ISENABLED,1) as ISENABLED, 
  isnull(q.TIME,a.TIME) as TIME,
  isnull(q.QUOTETIMING,a.QUOTETIMING) as QUOTETIMING, 
  q.CASHFLOWTYPE as CASHFLOWTYPE,
  q.VALUE as VALUE, 
  isnull(q.QUOTEUNIT,'Price') as QUOTEUNIT, 
  isnull(q.SPREADVALUE,0) as SPREADVALUE,
  null as TIMETOEXPIRATION,
  q.EXPIRITYTIME as EXPIRITYTIME,
  null as CONTRACTMULTIPLIER,
  isnull(q.SOURCE,'NA') as  SOURCE,
  q.ASSETMEASURE as ASSETMEASURE,
  q.IDC as IDC,q.IDBC as IDBC,q.IDM as IDM,
  q.IDAINS as IDAINS,q.DTINS as DTINS,q.IDAUPD as IDAUPD,q.DTUPD as DTUPD ,
  q.EXTLLINK as EXTLLINK,q.ROWATTRIBUT as ROWATTRIBUT,q.ROWVERSION as ROWVERSION,
  null as ASSETUNL_IDM,
  null as IDASSET_UNL,
  null as ASSETCATEGORY_UNL,
  null as ASSETUNL_IDENT,
  null as ASSETUNLQUOTE_TIME,
  null as ASSETUNLQUOTE_QUOTESIDE,
  null as ASSETUNLQUOTE_QUOTETIMING,
  null as ASSETUNLQUOTE_VALUE,
  null as ASSETUNLQUOTE_SOURCE
  from (
    /* 11/prix OfficialClose des sous-jacent de type Commodity des assets option non arrivé à échéance de type Americaine */
    select a.IDASSET_UNL as IDASSET, 'OfficialClose' as QUOTESIDE, 'Close' as QUOTETIMING,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, a.UNLQUOTE_TIME as TIME,
    'Between' as OPERATOR, unlQuote.IDQUOTE_H
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
    left outer join ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W unlQuote on unlQuote.IDASSET = a.IDASSET
    where a.CATEGORY='O' and a.EXERCISESTYLE=1 and a.ATMATURITY='0'  
    and a.IDASSET_UNL is not null and a.ASSETCATEGORY_UNL='Commodity'
    /* 12/prix OfficialSettlement/OfficialClose des sous-jacent de type Commodity des assets option arrivés à échéance */
    union
    select a.IDASSET_UNL as IDASSET, unlQuote.QUOTESIDE as QUOTESIDE, 'Close' as QUOTETIMING,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, a.UNLQUOTE_TIME as TIME,
    case when a.FINALSETTLTTIME != '00:00' then 'Equal' else 'Between' end as OPERATOR, unlQuote.IDQUOTE_H
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
    left outer join ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W unlQuote on unlQuote.IDASSET = a.IDASSET
    where a.CATEGORY='O' and a.ATMATURITY='1'
    and a.IDASSET_UNL is not null and a.ASSETCATEGORY_UNL='Commodity'
  ) a
  inner join dbo.ASSET_COMMODITY aCM on aCM.IDASSET = a.IDASSET
  left outer join dbo.QUOTE_COMMODITY_H q on q.IDQUOTE_H = a.IDQUOTE_H
  
  union
  
  /*EXCHANGETRADEDFUND*/
  select 
  @ACTIVITYTYPE as ACTIVITYTYPE,
  case 
    when (isnull(q.IDQUOTE_H,0) = 0) then 'Missing'  
    when (isnull(q.IDQUOTE_H,0) > 0 ) and (isnull(q.ISENABLED,1) = 0) then 'NotCertified' 
    else 'Available' 
  end as PRICESTATUS,  
  convert(varchar,isnull(q.IDQUOTE_H,0)) || ';' || 'EXCHANGETRADEDFUND' || ';' || convert(varchar,aETF.IDASSET) as KEYVALUE,
  aETF.IDASSET,aETF.IDENTIFIER as ASSET_IDENTIFIER, aETF.DISPLAYNAME as ASSET_DSP, 'ExchangeTradedFund' as ASSET_TYPE,
  aETF.IDM as ASSET_IDM,
  null as ASSET_IDDC,
  null as ASSET_DC_IDENT,
  null as ASSET_DC_DSP,
  null as ASSET_IDMATURITY,
  null as ASSET_MATFMT_PROFIL,
  null as ASSET_MATFMT_FIX,
  null as ASSET_MATURITYDATE,
  null as ASSET_CATEGORY,
  null as ASSET_PUTCALL,
  null as ASSET_STRIKEPRICE,
  null as ASSET_TICKVALUE,
  null as ASSET_TICKSIZE,
  null as ASSET_MULTIPLIER,
  null as ASSET_DEN,
  null as ASSET_ISINCODE,
  null as ASSET_ITM_OTM,
  null as ASSET_ATMATURITY,
  isnull(q.IDQUOTE_H,0) as IDQUOTE_H, 
  isnull(q.IDMARKETENV, a.IDMARKETENV) as IDMARKETENV, 
  isnull(q.IDVALSCENARIO,a.IDVALSCENARIO) as IDVALSCENARIO, 
  isnull(q.QUOTESIDE,a.QUOTESIDE) as QUOTESIDE, 
  isnull(q.ISENABLED,1) as ISENABLED, 
  isnull(q.TIME,a.TIME) as TIME,
  isnull(q.QUOTETIMING,a.QUOTETIMING) as QUOTETIMING, 
  q.CASHFLOWTYPE as CASHFLOWTYPE,
  q.VALUE as VALUE, 
  isnull(q.QUOTEUNIT,'Price') as QUOTEUNIT, 
  isnull(q.SPREADVALUE,0) as SPREADVALUE,
  null as TIMETOEXPIRATION,
  q.EXPIRITYTIME as EXPIRITYTIME,
  null as CONTRACTMULTIPLIER,
  isnull(q.SOURCE,'NA') as  SOURCE,
  q.ASSETMEASURE as ASSETMEASURE,
  q.IDC as IDC,q.IDBC as IDBC,q.IDM as IDM,
  q.IDAINS as IDAINS,q.DTINS as DTINS,q.IDAUPD as IDAUPD,q.DTUPD as DTUPD ,
  q.EXTLLINK as EXTLLINK,q.ROWATTRIBUT as ROWATTRIBUT,q.ROWVERSION as ROWVERSION,
  null as ASSETUNL_IDM,
  null as IDASSET_UNL,
  null as ASSETCATEGORY_UNL,
  null as ASSETUNL_IDENT,
  null as ASSETUNLQUOTE_TIME,
  null as ASSETUNLQUOTE_QUOTESIDE,
  null as ASSETUNLQUOTE_QUOTETIMING,
  null as ASSETUNLQUOTE_VALUE,
  null as ASSETUNLQUOTE_SOURCE
  from (
    /* 13/prix OfficialClose des sous-jacent de type ExchangeTradedFund des assets option non arrivé à échéance de type Americaine */
    select a.IDASSET_UNL as IDASSET, 'OfficialClose' as QUOTESIDE, 'Close' as QUOTETIMING,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, a.UNLQUOTE_TIME as TIME,
    'Between' as OPERATOR, unlQuote.IDQUOTE_H
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
    left outer join ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W unlQuote on unlQuote.IDASSET = a.IDASSET
    where a.CATEGORY='O' and a.ATMATURITY='0' and a.EXERCISESTYLE=1
    and a.IDASSET_UNL is not null and a.ASSETCATEGORY_UNL='ExchangeTradedFund'
    union
    /* 14/prix OfficialSettlement/OfficialClose des sous-jacent de type ExchangeTradedFund des assets option arrivés à échéance */
    select a.IDASSET_UNL as IDASSET, unlQuote.QUOTESIDE as QUOTESIDE, 'Close' as QUOTETIMING,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, a.UNLQUOTE_TIME as TIME,
    case when a.FINALSETTLTTIME != '00:00' then 'Equal' else 'Between' end as OPERATOR, unlQuote.IDQUOTE_H
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
    left outer join ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W unlQuote on unlQuote.IDASSET = a.IDASSET
    where a.CATEGORY='O' and a.ATMATURITY='1' 
    and a.IDASSET_UNL is not null and a.ASSETCATEGORY_UNL='ExchangeTradedFund'
  ) a
  inner join dbo.ASSET_EXTRDFUND aETF on aETF.IDASSET = a.IDASSET
  left outer join dbo.QUOTE_EXTRDFUND_H q on q.IDQUOTE_H = a.IDQUOTE_H
 ]]>
      </Command>
      <Command rdbms = "oracle">
        <![CDATA[
  /* SQL: WITHTOMOVE */
  with ASSET_EOD_OPT_UNL_W as (
    select a.IDASSET_UNL as IDASSET, a.ASSETCATEGORY_UNL as ASSETCATEGORY, 'OfficialClose' as QUOTESIDE, 'Close' as QUOTETIMING, 
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, a.UNLQUOTE_TIME as TIME, 
    'Between' as OPERATOR, a.ATMATURITY_UNL as ATMATURITY, unlQuote.IDQUOTE_H
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
    left outer join ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W unlQuote on unlQuote.IDASSET=a.IDASSET
    where a.CATEGORY='O' and a.EXERCISESTYLE=1 and a.ATMATURITY='0' and a.IDASSET_UNL is not null 
    union 
    select a.IDASSET_UNL as IDASSET, a.ASSETCATEGORY_UNL as ASSETCATEGORY, unlQuote.QUOTESIDE as QUOTESIDE, 'Close' as QUOTETIMING,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, a.UNLQUOTE_TIME as TIME,
    case when a.FINALSETTLTTIME != '00:00' then 'Equal' else 'Between' end as OPERATOR, a.ATMATURITY_UNL as ATMATURITY, unlQuote.IDQUOTE_H
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
    left outer join ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W unlQuote on unlQuote.IDASSET=a.IDASSET
    where a.CATEGORY='O' and a.ATMATURITY='1' and a.IDASSET_UNL is not null     
  ), 
  ASSET_EOD_OPT_UNL_FUT_W as (
    select IDASSET, QUOTESIDE, QUOTETIMING, IDMARKETENV, IDVALSCENARIO, TIME, OPERATOR, ATMATURITY, IDQUOTE_H
    from ASSET_EOD_OPT_UNL_W where ASSETCATEGORY = 'Future'
  ),
  ASSET_EOD_OPT_UNL_INDEX_W as (
    select IDASSET, QUOTESIDE, QUOTETIMING, IDMARKETENV, IDVALSCENARIO, TIME, OPERATOR, IDQUOTE_H
    from ASSET_EOD_OPT_UNL_W where ASSETCATEGORY = 'Index'
  ),
  ASSET_EOD_OPT_UNL_EQUITY_W as (
    select IDASSET, QUOTESIDE, QUOTETIMING, IDMARKETENV, IDVALSCENARIO, TIME, OPERATOR, IDQUOTE_H
    from ASSET_EOD_OPT_UNL_W where ASSETCATEGORY = 'EquityAsset'
  ),
  ASSET_EOD_OPT_UNL_COMMODITY_W as (
    select IDASSET, QUOTESIDE, QUOTETIMING, IDMARKETENV, IDVALSCENARIO, TIME, OPERATOR, IDQUOTE_H
    from ASSET_EOD_OPT_UNL_W where ASSETCATEGORY = 'Commodity'
  ),
  ASSET_EOD_OPT_UNL_ETF_W as (
    select IDASSET, QUOTESIDE, QUOTETIMING, IDMARKETENV, IDVALSCENARIO, TIME, OPERATOR, IDQUOTE_H
    from ASSET_EOD_OPT_UNL_W where ASSETCATEGORY = 'ExchangeTradedFund'
  )
  /* SQL: ENDWITHTOMOVE */      
  
  /*ETD*/
  select 
  @ACTIVITYTYPE as ACTIVITYTYPE,
  case
    when (isnull(q.IDQUOTE_H,0) = 0) then
      case when (dc.CATEGORY = 'O') and (a.ATMATURITY='1') then 'Optional' else 'Missing' end  
    when (isnull(q.IDQUOTE_H,0) > 0 ) and (isnull(q.ISENABLED,1) = 0) then 'NotCertified' 
    else 'Available' 
  end as PRICESTATUS,  
  convert(varchar,isnull(q.IDQUOTE_H,0)) || ';' || 'ETD' || ';' || convert(varchar,aETD.IDASSET) as KEYVALUE,
  aETD.IDASSET,aETD.IDENTIFIER as ASSET_IDENTIFIER, aETD.DISPLAYNAME as ASSET_DSP,'ExchangeTradedContract' as ASSET_TYPE,
  dc.IDM as ASSET_IDM,
  da.IDDC as ASSET_IDDC,
  dc.IDENTIFIER as ASSET_DC_IDENT,
  dc.DISPLAYNAME as ASSET_DC_DSP,
  da.IDMATURITY as ASSET_IDMATURITY,
  ma.MATURITYMONTHYEAR  as ASSET_MATFMT_PROFIL,
  ma.MATURITYMONTHYEAR as ASSET_MATFMT_FIX,
  ma.MATURITYDATE as ASSET_MATURITYDATE,
  dc.CATEGORY as ASSET_CATEGORY,
  case aETD.PUTCALL when '0' then 'Put' when '1' then 'Call' else '' end as ASSET_PUTCALL,
  aETD.STRIKEPRICE as ASSET_STRIKEPRICE,
  dc.MINPRICEINCRAMOUNT as ASSET_TICKVALUE,
  dc.MINPRICEINCR as ASSET_TICKSIZE,
  (case when aETD.CONTRACTMULTIPLIER is null then (case when da.CONTRACTMULTIPLIER is null then dc.CONTRACTMULTIPLIER else da.CONTRACTMULTIPLIER end) else aETD.CONTRACTMULTIPLIER end)
    / (case when (c.IDC != isnull(c.IDCQUOTED,c.IDC)) and ((isnull(c.FACTOR,1)) > 0) then isnull(c.FACTOR,1) else 1 end) as ASSET_MULTIPLIER,
  dc.INSTRUMENTDEN as ASSET_DEN,
  isnull(aETD.ISINCODE,dc.ISINCODE) as ASSET_ISINCODE,
  isnull(unlQuote.ITM_OTM,'N/A') as ASSET_ITM_OTM,
  a.ATMATURITY as ASSET_ATMATURITY,
  isnull(q.IDQUOTE_H,0) as IDQUOTE_H, 
  isnull(q.IDMARKETENV, a.IDMARKETENV) as IDMARKETENV, 
  isnull(q.IDVALSCENARIO,a.IDVALSCENARIO) as IDVALSCENARIO, 
  isnull(q.QUOTESIDE,a.QUOTESIDE) as QUOTESIDE, 
  isnull(q.ISENABLED,1) as ISENABLED, 
  isnull(q.TIME,a.TIME) as TIME,
  isnull(q.QUOTETIMING,a.QUOTETIMING) as QUOTETIMING, 
  q.CASHFLOWTYPE as CASHFLOWTYPE,
  q.VALUE as VALUE, 
  isnull(q.QUOTEUNIT,'Price') as QUOTEUNIT, 
  q.SPREADVALUE as SPREADVALUE,
  q.TIMETOEXPIRATION as TIMETOEXPIRATION,
  q.EXPIRITYTIME as EXPIRITYTIME,
  q.CONTRACTMULTIPLIER as CONTRACTMULTIPLIER,
  q.SOURCE as  SOURCE,
  q.ASSETMEASURE as ASSETMEASURE,
  q.IDC as IDC,q.IDBC as IDBC,q.IDM as IDM,
  q.IDAINS as IDAINS,q.DTINS as DTINS,q.IDAUPD as IDAUPD,q.DTUPD as DTUPD ,
  q.EXTLLINK as EXTLLINK,q.ROWATTRIBUT as ROWATTRIBUT,q.ROWVERSION as ROWVERSION,
  unl.IDM as ASSETUNL_IDM,
  unl.IDASSET as IDASSET_UNL,
  unl.ASSETCATEGORY as ASSETCATEGORY_UNL,
  unl.IDENTIFIER as ASSETUNL_IDENT,
  unlQuote.TIME as ASSETUNLQUOTE_TIME,
  unlQuote.QUOTESIDE as ASSETUNLQUOTE_QUOTESIDE,
  unlQuote.QUOTETIMING as ASSETUNLQUOTE_QUOTETIMING,
  unlQuote.VALUE as ASSETUNLQUOTE_VALUE,
  unlQuote.SOURCE as ASSETUNLQUOTE_SOURCE
  from (
    /* 1/prix OfficialClose des assets futures non arrivés à échéance */
    /* 2/prix OfficialClose des assets futures arrivés à échéance */
    /* 3/prix OfficialClose des assets options non arrivés à échéance */
    /* 4/prix OfficialClose des assets options arrivés à échéance */
    select a.IDASSET as IDASSET, 'OfficialClose' as QUOTESIDE, 'Close' as QUOTETIMING,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, @DATE1 as TIME, 'Between' as OPERATOR, a.ATMATURITY
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
  ) a  
  inner join dbo.ASSET_ETD aETD on aETD.IDASSET = a.IDASSET
  inner join dbo.DERIVATIVEATTRIB da on da.IDDERIVATIVEATTRIB = aETD.IDDERIVATIVEATTRIB
  inner join dbo.DERIVATIVECONTRACT dc on dc.IDDC = da.IDDC
  inner join dbo.MATURITY ma on ma.IDMATURITY = da.IDMATURITY  
  inner join CURRENCY c on (c.IDC = dc.IDC_PRICE)
  left outer join ASSETQUOTE_EOD_%%SHORTSESSIONID%%_W unlQuote on unlQuote.IDASSET = a.IDASSET and dc.CATEGORY = 'O' 
  left outer join dbo.VW_ASSET unl on unl.IDASSET = unlQuote.IDASSET_UNL and unl.ASSETCATEGORY = unlQuote.ASSETCATEGORY_UNL
  left outer join dbo.QUOTE_ETD_H q on q.IDASSET=aETD.IDASSET 
  and (
    (q.TIME = a.TIME and a.OPERATOR = 'Equal')
    or
    (convert(varchar,q.TIME,112) = convert(varchar,a.TIME,112) and a.OPERATOR = 'Between')
  ) 
  and (isnull(q.QUOTESIDE,'OfficialClose') = a.QUOTESIDE) 
  and (isnull(q.QUOTETIMING,'Close') = a.QUOTETIMING) 
  and (q.IDMARKETENV=a.IDMARKETENV) and (q.IDVALSCENARIO=a.IDVALSCENARIO)
  
  union
  
  /*ETD*/
  /* 5/prix OfficialClose des sous-jacent de type Future des assets option non arrivé à échéance de type Americaine */
  /* 6/prix OfficialSettlement/OfficialClose des sous-jacent de type Future des assets option arrivés à échéance */
  select 
  @ACTIVITYTYPE as ACTIVITYTYPE,
  case
    when (isnull(q.IDQUOTE_H,0) = 0) then
      case when (dc.CATEGORY = 'O') and (a.ATMATURITY='1') then 'Optional' else 'Missing' end  
    when (isnull(q.IDQUOTE_H,0) > 0 ) and (isnull(q.ISENABLED,1) = 0) then 'NotCertified' 
    else 'Available' 
  end as PRICESTATUS,  
  convert(varchar,isnull(q.IDQUOTE_H,0)) || ';' || 'ETD' || ';' || convert(varchar,aETD.IDASSET) as KEYVALUE,
  aETD.IDASSET,aETD.IDENTIFIER as ASSET_IDENTIFIER, aETD.DISPLAYNAME as ASSET_DSP,'ExchangeTradedContract' as ASSET_TYPE,
  dc.IDM as ASSET_IDM,
  da.IDDC as ASSET_IDDC,
  dc.IDENTIFIER as ASSET_DC_IDENT,
  dc.DISPLAYNAME as ASSET_DC_DSP,
  da.IDMATURITY as ASSET_IDMATURITY,
  ma.MATURITYMONTHYEAR  as ASSET_MATFMT_PROFIL,
  ma.MATURITYMONTHYEAR as ASSET_MATFMT_FIX,
  ma.MATURITYDATE as ASSET_MATURITYDATE,
  dc.CATEGORY as ASSET_CATEGORY,
  case aETD.PUTCALL when '0' then 'Put' when '1' then 'Call' else '' end as ASSET_PUTCALL,
  aETD.STRIKEPRICE as ASSET_STRIKEPRICE,
  dc.MINPRICEINCRAMOUNT as ASSET_TICKVALUE,
  dc.MINPRICEINCR as ASSET_TICKSIZE,
  (case when aETD.CONTRACTMULTIPLIER is null then (case when da.CONTRACTMULTIPLIER is null then dc.CONTRACTMULTIPLIER else da.CONTRACTMULTIPLIER end) else aETD.CONTRACTMULTIPLIER end)
    / (case when (c.IDC != isnull(c.IDCQUOTED,c.IDC)) and ((isnull(c.FACTOR,1)) > 0) then isnull(c.FACTOR,1) else 1 end) as ASSET_MULTIPLIER,
  dc.INSTRUMENTDEN as ASSET_DEN,
  isnull(aETD.ISINCODE,dc.ISINCODE) as ASSET_ISINCODE,
  'N/A' as ASSET_ITM_OTM,
  a.ATMATURITY as ASSET_ATMATURITY,
  isnull(q.IDQUOTE_H,0) as IDQUOTE_H, 
  isnull(q.IDMARKETENV, a.IDMARKETENV) as IDMARKETENV, 
  isnull(q.IDVALSCENARIO,a.IDVALSCENARIO) as IDVALSCENARIO, 
  isnull(q.QUOTESIDE,a.QUOTESIDE) as QUOTESIDE, 
  isnull(q.ISENABLED,1) as ISENABLED, 
  isnull(q.TIME,a.TIME) as TIME,
  isnull(q.QUOTETIMING,a.QUOTETIMING) as QUOTETIMING, 
  q.CASHFLOWTYPE as CASHFLOWTYPE,
  q.VALUE as VALUE, 
  isnull(q.QUOTEUNIT,'Price') as QUOTEUNIT, 
  q.SPREADVALUE as SPREADVALUE,
  q.TIMETOEXPIRATION as TIMETOEXPIRATION,
  q.EXPIRITYTIME as EXPIRITYTIME,
  q.CONTRACTMULTIPLIER as CONTRACTMULTIPLIER,
  q.SOURCE as  SOURCE,
  q.ASSETMEASURE as ASSETMEASURE,
  q.IDC as IDC,q.IDBC as IDBC,q.IDM as IDM,
  q.IDAINS as IDAINS,q.DTINS as DTINS,q.IDAUPD as IDAUPD,q.DTUPD as DTUPD ,
  q.EXTLLINK as EXTLLINK,q.ROWATTRIBUT as ROWATTRIBUT,q.ROWVERSION as ROWVERSION,
  null as ASSETUNL_IDM,
  null as IDASSET_UNL,
  null as ASSETCATEGORY_UNL,
  null as ASSETUNL_IDENT,
  null as ASSETUNLQUOTE_TIME,
  null as ASSETUNLQUOTE_QUOTESIDE,
  null as ASSETUNLQUOTE_QUOTETIMING,
  null as ASSETUNLQUOTE_VALUE,
  null as ASSETUNLQUOTE_SOURCE
  from ASSET_EOD_OPT_UNL_FUT_W a  
  inner join dbo.ASSET_ETD aETD on aETD.IDASSET = a.IDASSET
  inner join dbo.DERIVATIVEATTRIB da on da.IDDERIVATIVEATTRIB = aETD.IDDERIVATIVEATTRIB
  inner join dbo.DERIVATIVECONTRACT dc on dc.IDDC = da.IDDC
  inner join dbo.MATURITY ma on ma.IDMATURITY = da.IDMATURITY  
  inner join CURRENCY c on (c.IDC = dc.IDC_PRICE)
  left outer join dbo.QUOTE_ETD_H q on q.IDQUOTE_H = a.IDQUOTE_H
  
  union
  
  /*INDEX*/
  /* 7/prix OfficialClose des sous-jacent de type Index des assets option non arrivé à échéance de type Americaine */
  /* 8/prix OfficialSettlement/OfficialClose des sous-jacent de type Index des assets option arrivés à échéance */
  select 
  @ACTIVITYTYPE as ACTIVITYTYPE,
  case 
    when (isnull(q.IDQUOTE_H,0) = 0) then 'Missing'  
    when (isnull(q.IDQUOTE_H,0) > 0 ) and (isnull(q.ISENABLED,1) = 0) then 'NotCertified' 
    else 'Available' 
  end as PRICESTATUS,  
  convert(varchar,isnull(q.IDQUOTE_H,0)) || ';' || 'INDEX' || ';' || convert(varchar,aRI.IDASSET) as KEYVALUE,
  aRI.IDASSET,aRI.IDENTIFIER as ASSET_IDENTIFIER, aRI.DISPLAYNAME as ASSET_DSP,'Index' as ASSET_TYPE,
  aRI.IDM as ASSET_IDM,
  null as ASSET_IDDC,
  null as ASSET_DC_IDENT,
  null as ASSET_DC_DSP,
  null as ASSET_IDMATURITY,
  null as ASSET_MATFMT_PROFIL,
  null as ASSET_MATFMT_FIX,
  null as ASSET_MATURITYDATE,
  null as ASSET_CATEGORY,
  null as ASSET_PUTCALL,
  null as ASSET_STRIKEPRICE,
  null as ASSET_TICKVALUE,
  null as ASSET_TICKSIZE,
  null as ASSET_MULTIPLIER,
  null as ASSET_DEN,
  aRI.ISINCODE as ASSET_ISINCODE,
  null as ASSET_ITM_OTM,
  null as ASSET_ATMATURITY,
  isnull(q.IDQUOTE_H,0) as IDQUOTE_H, 
  isnull(q.IDMARKETENV, a.IDMARKETENV) as IDMARKETENV, 
  isnull(q.IDVALSCENARIO,a.IDVALSCENARIO) as IDVALSCENARIO, 
  isnull(q.QUOTESIDE,a.QUOTESIDE) as QUOTESIDE, 
  isnull(q.ISENABLED,1) as ISENABLED, 
  isnull(q.TIME,a.TIME) as TIME,
  isnull(q.QUOTETIMING,a.QUOTETIMING) as QUOTETIMING, 
  q.CASHFLOWTYPE as CASHFLOWTYPE,
  q.VALUE as VALUE, 
  isnull(q.QUOTEUNIT,'Price') as QUOTEUNIT, 
  isnull(q.SPREADVALUE,0) as SPREADVALUE,
  null as TIMETOEXPIRATION,
  q.EXPIRITYTIME as EXPIRITYTIME,
  null as CONTRACTMULTIPLIER,
  isnull(q.SOURCE,'NA') as  SOURCE,
  q.ASSETMEASURE as ASSETMEASURE,
  q.IDC as IDC,q.IDBC as IDBC,q.IDM as IDM,
  q.IDAINS as IDAINS,q.DTINS as DTINS,q.IDAUPD as IDAUPD,q.DTUPD as DTUPD ,
  q.EXTLLINK as EXTLLINK,q.ROWATTRIBUT as ROWATTRIBUT,q.ROWVERSION as ROWVERSION,
  null as ASSETUNL_IDM,
  null as IDASSET_UNL,
  null as ASSETCATEGORY_UNL,
  null as ASSETUNL_IDENT,
  null as ASSETUNLQUOTE_TIME,
  null as ASSETUNLQUOTE_QUOTESIDE,
  null as ASSETUNLQUOTE_QUOTETIMING,
  null as ASSETUNLQUOTE_VALUE,
  null as ASSETUNLQUOTE_SOURCE
  from ASSET_EOD_OPT_UNL_INDEX_W a
  inner join dbo.ASSET_INDEX aRI on aRI.IDASSET=a.IDASSET
  left outer join dbo.QUOTE_INDEX_H q on q.IDQUOTE_H=a.IDQUOTE_H

  union
  
  /*EQUITY*/
  /* 09/prix OfficialClose des sous-jacent de type EquityAsset des assets option non arrivé à échéance de type Americaine */
  /* 10/prix OfficialSettlement/OfficialClose des sous-jacent de type EquityAsset des assets option arrivés à échéance */
  select 
  @ACTIVITYTYPE as ACTIVITYTYPE,
  case 
    when (isnull(q.IDQUOTE_H,0) = 0) then 'Missing'  
      when (isnull(q.IDQUOTE_H,0) > 0 ) and (isnull(q.ISENABLED,1) = 0) then 'NotCertified' 
    else 'Available' 
  end as PRICESTATUS,  
  convert(varchar,isnull(q.IDQUOTE_H,0)) || ';' || 'EQUITY' || ';' || convert(varchar,aEQ.IDASSET) as KEYVALUE,
  aEQ.IDASSET,aEQ.IDENTIFIER as ASSET_IDENTIFIER, aEQ.DISPLAYNAME as ASSET_DSP, 'EquityAsset' as ASSET_TYPE,
  aEQ.IDM as ASSET_IDM,
  null as ASSET_IDDC,
  null as ASSET_DC_IDENT,
  null as ASSET_DC_DSP,
  null as ASSET_IDMATURITY,
  null as ASSET_MATFMT_PROFIL,
  null as ASSET_MATFMT_FIX,
  null as ASSET_MATURITYDATE,
  null as ASSET_CATEGORY,
  null as ASSET_PUTCALL,
  null as ASSET_STRIKEPRICE,
  null as ASSET_TICKVALUE,
  null as ASSET_TICKSIZE,
  null as ASSET_MULTIPLIER,
  null as ASSET_DEN,
  aEQ.ISINCODE as ASSET_ISINCODE,
  null as ASSET_ITM_OTM,
  null as ASSET_ATMATURITY,
  isnull(q.IDQUOTE_H,0) as IDQUOTE_H, 
  isnull(q.IDMARKETENV, a.IDMARKETENV) as IDMARKETENV, 
  isnull(q.IDVALSCENARIO,a.IDVALSCENARIO) as IDVALSCENARIO, 
  isnull(q.QUOTESIDE,a.QUOTESIDE) as QUOTESIDE, 
  isnull(q.ISENABLED,1) as ISENABLED, 
  isnull(q.TIME,a.TIME) as TIME,
  isnull(q.QUOTETIMING,a.QUOTETIMING) as QUOTETIMING, 
  q.CASHFLOWTYPE as CASHFLOWTYPE,
  q.VALUE as VALUE, 
  isnull(q.QUOTEUNIT,'Price') as QUOTEUNIT, 
  isnull(q.SPREADVALUE,0) as SPREADVALUE,
  null as TIMETOEXPIRATION,
  q.EXPIRITYTIME as EXPIRITYTIME,
  null as CONTRACTMULTIPLIER,
  isnull(q.SOURCE,'NA') as  SOURCE,
  q.ASSETMEASURE as ASSETMEASURE,
  q.IDC as IDC,q.IDBC as IDBC,q.IDM as IDM,
  q.IDAINS as IDAINS,q.DTINS as DTINS,q.IDAUPD as IDAUPD,q.DTUPD as DTUPD ,
  q.EXTLLINK as EXTLLINK,q.ROWATTRIBUT as ROWATTRIBUT,q.ROWVERSION as ROWVERSION,
  null as ASSETUNL_IDM,
  null as IDASSET_UNL,
  null as ASSETCATEGORY_UNL,
  null as ASSETUNL_IDENT,
  null as ASSETUNLQUOTE_TIME,
  null as ASSETUNLQUOTE_QUOTESIDE,
  null as ASSETUNLQUOTE_QUOTETIMING,
  null as ASSETUNLQUOTE_VALUE,
  null as ASSETUNLQUOTE_SOURCE
  from ASSET_EOD_OPT_UNL_EQUITY_W a
  inner join dbo.ASSET_EQUITY aEQ on aEQ.IDASSET=a.IDASSET
  left outer join dbo.QUOTE_EQUITY_H q on q.IDQUOTE_H=a.IDQUOTE_H  

  union
  
  /*COMMODITY*/
  /* 11/prix OfficialClose des sous-jacent de type Commodity des assets option non arrivé à échéance de type Americaine */
  /* 12/prix OfficialSettlement/OfficialClose des sous-jacent de type Commodity des assets option arrivés à échéance */
  select 
  @ACTIVITYTYPE as ACTIVITYTYPE,
  case 
    when (isnull(q.IDQUOTE_H,0) = 0) then 'Missing'  
    when (isnull(q.IDQUOTE_H,0) > 0 ) and (isnull(q.ISENABLED,1) = 0) then 'NotCertified' 
    else 'Available' 
  end as PRICESTATUS,  
  convert(varchar,isnull(q.IDQUOTE_H,0)) || ';' || 'COMMODITY' || ';' || convert(varchar,aCM.IDASSET) as KEYVALUE,
  aCM.IDASSET,aCM.IDENTIFIER as ASSET_IDENTIFIER, aCM.DISPLAYNAME as ASSET_DSP, 'Commodity' as ASSET_TYPE,
  aCM.IDM as ASSET_IDM,
  null as ASSET_IDDC,
  null as ASSET_DC_IDENT,
  null as ASSET_DC_DSP,
  null as ASSET_IDMATURITY,
  null as ASSET_MATFMT_PROFIL,
  null as ASSET_MATFMT_FIX,
  null as ASSET_MATURITYDATE,
  null as ASSET_CATEGORY,
  null as ASSET_PUTCALL,
  null as ASSET_STRIKEPRICE,
  null as ASSET_TICKVALUE,
  null as ASSET_TICKSIZE,
  null as ASSET_MULTIPLIER,
  null as ASSET_DEN,
  null as ASSET_ISINCODE,
  null as ASSET_ITM_OTM,
  null as ASSET_ATMATURITY,
  isnull(q.IDQUOTE_H,0) as IDQUOTE_H, 
  isnull(q.IDMARKETENV, a.IDMARKETENV) as IDMARKETENV, 
  isnull(q.IDVALSCENARIO,a.IDVALSCENARIO) as IDVALSCENARIO, 
  isnull(q.QUOTESIDE,a.QUOTESIDE) as QUOTESIDE, 
  isnull(q.ISENABLED,1) as ISENABLED, 
  isnull(q.TIME,a.TIME) as TIME,
  isnull(q.QUOTETIMING,a.QUOTETIMING) as QUOTETIMING, 
  q.CASHFLOWTYPE as CASHFLOWTYPE,
  q.VALUE as VALUE, 
  isnull(q.QUOTEUNIT,'Price') as QUOTEUNIT, 
  isnull(q.SPREADVALUE,0) as SPREADVALUE,
  null as TIMETOEXPIRATION,
  q.EXPIRITYTIME as EXPIRITYTIME,
  null as CONTRACTMULTIPLIER,
  isnull(q.SOURCE,'NA') as  SOURCE,
  q.ASSETMEASURE as ASSETMEASURE,
  q.IDC as IDC,q.IDBC as IDBC,q.IDM as IDM,
  q.IDAINS as IDAINS,q.DTINS as DTINS,q.IDAUPD as IDAUPD,q.DTUPD as DTUPD ,
  q.EXTLLINK as EXTLLINK,q.ROWATTRIBUT as ROWATTRIBUT,q.ROWVERSION as ROWVERSION,
  null as ASSETUNL_IDM,
  null as IDASSET_UNL,
  null as ASSETCATEGORY_UNL,
  null as ASSETUNL_IDENT,
  null as ASSETUNLQUOTE_TIME,
  null as ASSETUNLQUOTE_QUOTESIDE,
  null as ASSETUNLQUOTE_QUOTETIMING,
  null as ASSETUNLQUOTE_VALUE,
  null as ASSETUNLQUOTE_SOURCE
  from ASSET_EOD_OPT_UNL_COMMODITY_W a
  inner join dbo.ASSET_COMMODITY aCM on aCM.IDASSET=a.IDASSET
  left outer join dbo.QUOTE_COMMODITY_H q on q.IDQUOTE_H=a.IDQUOTE_H
      
  union
  
  /*EXCHANGETRADEDFUND*/
  /* 13/prix OfficialClose des sous-jacent de type ExchangeTradedFund des assets option non arrivé à échéance de type Americaine */
  /* 14/prix OfficialSettlement/OfficialClose des sous-jacent de type ExchangeTradedFund des assets option arrivés à échéance */
  select 
  @ACTIVITYTYPE as ACTIVITYTYPE,
  case 
    when (isnull(q.IDQUOTE_H,0) = 0) then 'Missing'  
    when (isnull(q.IDQUOTE_H,0) > 0 ) and (isnull(q.ISENABLED,1) = 0) then 'NotCertified' 
    else 'Available' 
  end as PRICESTATUS,  
  convert(varchar,isnull(q.IDQUOTE_H,0)) || ';' || 'EXCHANGETRADEDFUND' || ';' || convert(varchar,aETF.IDASSET) as KEYVALUE,
  aETF.IDASSET,aETF.IDENTIFIER as ASSET_IDENTIFIER, aETF.DISPLAYNAME as ASSET_DSP, 'ExchangeTradedFund' as ASSET_TYPE,
  aETF.IDM as ASSET_IDM,
  null as ASSET_IDDC,
  null as ASSET_DC_IDENT,
  null as ASSET_DC_DSP,
  null as ASSET_IDMATURITY,
  null as ASSET_MATFMT_PROFIL,
  null as ASSET_MATFMT_FIX,
  null as ASSET_MATURITYDATE,
  null as ASSET_CATEGORY,
  null as ASSET_PUTCALL,
  null as ASSET_STRIKEPRICE,
  null as ASSET_TICKVALUE,
  null as ASSET_TICKSIZE,
  null as ASSET_MULTIPLIER,
  null as ASSET_DEN,
  null as ASSET_ISINCODE,
  null as ASSET_ITM_OTM,
  null as ASSET_ATMATURITY,
  isnull(q.IDQUOTE_H,0) as IDQUOTE_H, 
  isnull(q.IDMARKETENV, a.IDMARKETENV) as IDMARKETENV, 
  isnull(q.IDVALSCENARIO,a.IDVALSCENARIO) as IDVALSCENARIO, 
  isnull(q.QUOTESIDE,a.QUOTESIDE) as QUOTESIDE, 
  isnull(q.ISENABLED,1) as ISENABLED, 
  isnull(q.TIME,a.TIME) as TIME,
  isnull(q.QUOTETIMING,a.QUOTETIMING) as QUOTETIMING, 
  q.CASHFLOWTYPE as CASHFLOWTYPE,
  q.VALUE as VALUE, 
  isnull(q.QUOTEUNIT,'Price') as QUOTEUNIT, 
  isnull(q.SPREADVALUE,0) as SPREADVALUE,
  null as TIMETOEXPIRATION,
  q.EXPIRITYTIME as EXPIRITYTIME,
  null as CONTRACTMULTIPLIER,
  isnull(q.SOURCE,'NA') as  SOURCE,
  q.ASSETMEASURE as ASSETMEASURE,
  q.IDC as IDC,q.IDBC as IDBC,q.IDM as IDM,
  q.IDAINS as IDAINS,q.DTINS as DTINS,q.IDAUPD as IDAUPD,q.DTUPD as DTUPD ,
  q.EXTLLINK as EXTLLINK,q.ROWATTRIBUT as ROWATTRIBUT,q.ROWVERSION as ROWVERSION,
  null as ASSETUNL_IDM,
  null as IDASSET_UNL,
  null as ASSETCATEGORY_UNL,
  null as ASSETUNL_IDENT,
  null as ASSETUNLQUOTE_TIME,
  null as ASSETUNLQUOTE_QUOTESIDE,
  null as ASSETUNLQUOTE_QUOTETIMING,
  null as ASSETUNLQUOTE_VALUE,
  null as ASSETUNLQUOTE_SOURCE
  from ASSET_EOD_OPT_UNL_ETF_W a
  inner join dbo.ASSET_EXTRDFUND aETF on aETF.IDASSET=a.IDASSET
  left outer join dbo.QUOTE_EXTRDFUND_H q on q.IDQUOTE_H=a.IDQUOTE_H
      ]]>
      </Command>
    </SQLSelect>

    <SQLSelect>
      <!-- Liste des cotations nécessaires à une journée de bourse pour les CFD et EquitySecurityTransaction et debtsecurity -->
      <ConditionDynamicArg  grp="ACTIVITYTYPE">
        <DynamicArgValue name="ACTIVITYTYPE">2</DynamicArgValue>
      </ConditionDynamicArg>
      <Command rdbms = "all">
        <![CDATA[
  /*INDEX*/
  select 
  @ACTIVITYTYPE as ACTIVITYTYPE,
  case 
    when (isnull(q.IDQUOTE_H,0) = 0) then 'Missing'
    when (isnull(q.IDQUOTE_H,0) > 0 ) and (isnull(q.ISENABLED,1) = 0) then 'NotCertified' 
    else 'Available' 
  end as PRICESTATUS,  
  convert(varchar,isnull(q.IDQUOTE_H,0)) || ';' || 'INDEX' || ';' || convert(varchar,asset.IDASSET) as KEYVALUE,
  asset.IDASSET,asset.IDENTIFIER as ASSET_IDENTIFIER,asset.DISPLAYNAME as ASSET_DSP, 'Index' as ASSET_TYPE,
  asset.IDM as ASSET_IDM,
  null as ASSET_IDDC,
  null as ASSET_DC_IDENT,
  null as ASSET_DC_DSP,
  null as ASSET_IDMATURITY,
  null as ASSET_MATFMT_PROFIL,
  null as ASSET_MATFMT_FIX,
  null as ASSET_MATURITYDATE,
  null as ASSET_CATEGORY,
  null as ASSET_PUTCALL,
  null as ASSET_STRIKEPRICE,
  null as ASSET_TICKVALUE,
  null as ASSET_TICKSIZE,
  null as ASSET_MULTIPLIER,
  null as ASSET_DEN,
  asset.ISINCODE as ASSET_ISINCODE,
  null as ASSET_ITM_OTM,
  null as ASSET_ATMATURITY,
  isnull(q.IDQUOTE_H,0) as IDQUOTE_H, 
  isnull(q.IDMARKETENV, ae.IDMARKETENV) as IDMARKETENV, 
  isnull(q.IDVALSCENARIO,ae.IDVALSCENARIO) as IDVALSCENARIO, 
  isnull(q.QUOTESIDE,ae.QUOTESIDE) as QUOTESIDE, 
  isnull(q.ISENABLED,1) as ISENABLED, 
  isnull(q.TIME,ae.TIME) as TIME,
  isnull(q.QUOTETIMING,ae.QUOTETIMING) as QUOTETIMING, 
  q.CASHFLOWTYPE as CASHFLOWTYPE,
  q.VALUE as VALUE, 
  isnull(q.QUOTEUNIT,'Price') as QUOTEUNIT, 
  isnull(q.SPREADVALUE,0) as SPREADVALUE,
  null as TIMETOEXPIRATION,
  q.EXPIRITYTIME as EXPIRITYTIME,
  null as CONTRACTMULTIPLIER,
  isnull(q.SOURCE,'NA') as  SOURCE,
  q.ASSETMEASURE as ASSETMEASURE,
  q.IDC as IDC,q.IDBC as IDBC,q.IDM as IDM,
  q.IDAINS as IDAINS,q.DTINS as DTINS,q.IDAUPD as IDAUPD,q.DTUPD as DTUPD ,
  q.EXTLLINK as EXTLLINK,q.ROWATTRIBUT as ROWATTRIBUT,q.ROWVERSION as ROWVERSION,
  null as ASSETUNL_IDM,
  null as IDASSET_UNL,
  null as ASSETCATEGORY_UNL,
  null as ASSETUNL_IDENT,
  null as ASSETUNLQUOTE_TIME,
  null as ASSETUNLQUOTE_QUOTESIDE,
  null as ASSETUNLQUOTE_QUOTETIMING,
  null as ASSETUNLQUOTE_VALUE,
  null as ASSETUNLQUOTE_SOURCE
  from (
    select a.IDASSET, 'OfficialClose' as QUOTESIDE, 'Close' as QUOTETIMING,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, @DATE1 as TIME
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
    where a.ASSETCATEGORY = 'Index'
  ) ae
  inner join dbo.ASSET_INDEX asset on asset.IDASSET = ae.IDASSET
  left outer join dbo.QUOTE_INDEX_H q on q.IDASSET=asset.IDASSET 
  and (
    (q.TIME = ae.TIME)
    or
    (convert(varchar,q.TIME,112) = convert(varchar,ae.TIME,112))
  ) 
  and (
    (q.QUOTESIDE= ae.QUOTESIDE) 
    or
    (isnull(q.QUOTESIDE,'OfficialClose') = case when ae.QUOTESIDE = 'OfficialClose' then 'OfficialClose' else 'xxx' end)
  )
  and (isnull(q.QUOTETIMING,'Close')= ae.QUOTETIMING) 
  and (q.IDMARKETENV=ae.IDMARKETENV) and (q.IDVALSCENARIO=ae.IDVALSCENARIO)

  union all
  
  /*EQUITY*/
  select 
  @ACTIVITYTYPE as ACTIVITYTYPE,
  case
    when (isnull(q.IDQUOTE_H,0) = 0) then 'Missing'
    when (isnull(q.IDQUOTE_H,0) > 0 ) and (isnull(q.ISENABLED,1) = 0) then 'NotCertified' 
    else 'Available' 
  end as PRICESTATUS,  
  convert(varchar,isnull(q.IDQUOTE_H,0)) || ';' || 'EQUITY' || ';' || convert(varchar,asset.IDASSET) as KEYVALUE,
  asset.IDASSET,asset.IDENTIFIER as ASSET_IDENTIFIER, asset.DISPLAYNAME as ASSET_DSP, 'EquityAsset' as ASSET_TYPE,
  asset.IDM as ASSET_IDM,
  null as ASSET_IDDC,
  null as ASSET_DC_IDENT,
  null as ASSET_DC_DSP,
  null as ASSET_IDMATURITY,
  null as ASSET_MATFMT_PROFIL,
  null as ASSET_MATFMT_FIX,
  null as ASSET_MATURITYDATE,
  null as ASSET_CATEGORY,
  null as ASSET_PUTCALL,
  null as ASSET_STRIKEPRICE,
  null as ASSET_TICKVALUE,
  null as ASSET_TICKSIZE,
  null as ASSET_MULTIPLIER,
  null as ASSET_DEN,
  asset.ISINCODE as ASSET_ISINCODE,
  null as ASSET_ITM_OTM,
  null as ASSET_ATMATURITY,
  isnull(q.IDQUOTE_H,0) as IDQUOTE_H, 
  isnull(q.IDMARKETENV, ae.IDMARKETENV) as IDMARKETENV, 
  isnull(q.IDVALSCENARIO,ae.IDVALSCENARIO) as IDVALSCENARIO, 
  isnull(q.QUOTESIDE,ae.QUOTESIDE) as QUOTESIDE, 
  isnull(q.ISENABLED,1) as ISENABLED, 
  isnull(q.TIME,ae.TIME) as TIME,
  isnull(q.QUOTETIMING,ae.QUOTETIMING) as QUOTETIMING, 
  q.CASHFLOWTYPE as CASHFLOWTYPE,
  q.VALUE as VALUE, 
  isnull(q.QUOTEUNIT,'Price') as QUOTEUNIT, 
  isnull(q.SPREADVALUE,0) as SPREADVALUE,
  null as TIMETOEXPIRATION,
  q.EXPIRITYTIME as EXPIRITYTIME,
  null as CONTRACTMULTIPLIER,
  isnull(q.SOURCE,'NA') as  SOURCE,
  q.ASSETMEASURE as ASSETMEASURE,
  q.IDC as IDC,q.IDBC as IDBC,q.IDM as IDM,
  q.IDAINS as IDAINS,q.DTINS as DTINS,q.IDAUPD as IDAUPD,q.DTUPD as DTUPD ,
  q.EXTLLINK as EXTLLINK,q.ROWATTRIBUT as ROWATTRIBUT,q.ROWVERSION as ROWVERSION,
  null as ASSETUNL_IDM,
  null as IDASSET_UNL,
  null as ASSETCATEGORY_UNL,
  null as ASSETUNL_IDENT,
  null as ASSETUNLQUOTE_TIME,
  null as ASSETUNLQUOTE_QUOTESIDE,
  null as ASSETUNLQUOTE_QUOTETIMING,
  null as ASSETUNLQUOTE_VALUE,
  null as ASSETUNLQUOTE_SOURCE
  from (
    select a.IDASSET,  'OfficialClose' as QUOTESIDE, 'Close' as QUOTETIMING,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, @DATE1 as TIME
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
    where a.ASSETCATEGORY='EquityAsset'
  ) ae
  inner join dbo.ASSET_EQUITY asset on asset.IDASSET = ae.IDASSET
  left outer join dbo.QUOTE_EQUITY_H q on q.IDASSET=asset.IDASSET 
  and (
    (q.TIME = ae.TIME )
    or
    (convert(varchar,q.TIME,112) = convert(varchar,ae.TIME,112))
  ) 
  and(
    (q.QUOTESIDE= ae.QUOTESIDE) 
    or 
    (isnull(q.QUOTESIDE,'OfficialClose') = case when ae.QUOTESIDE = 'OfficialClose' then 'OfficialClose' else 'xxx' end)
  )
  and (isnull(q.QUOTETIMING,'Close')= ae.QUOTETIMING) 
  and (q.IDMARKETENV=ae.IDMARKETENV) and (q.IDVALSCENARIO=ae.IDVALSCENARIO)
  
  union all
  
  /*DEBTSEC*/
  select 
  @ACTIVITYTYPE as ACTIVITYTYPE,
  case 
    when (isnull(q.IDQUOTE_H,0) = 0) then 'Optional'
    when (isnull(q.IDQUOTE_H,0) > 0 ) and (isnull(q.ISENABLED,1) = 0) then 'NotCertified' 
    else 'Available' 
  end as PRICESTATUS,  
  convert(varchar,isnull(q.IDQUOTE_H,0)) || ';' || 'DEBTSEC' || ';' || convert(varchar,asset.IDASSET) as KEYVALUE,
  asset.IDASSET,asset.IDENTIFIER as ASSET_IDENTIFIER,asset.DISPLAYNAME as ASSET_DSP, 'Bond' as ASSET_TYPE,
  asset.IDM as ASSET_IDM,
  null as ASSET_IDDC,
  null as ASSET_DC_IDENT,
  null as ASSET_DC_DSP,
  null as ASSET_IDMATURITY,
  null as ASSET_MATFMT_PROFIL,
  null as ASSET_MATFMT_FIX,
  null as ASSET_MATURITYDATE,
  null as ASSET_CATEGORY,
  null as ASSET_PUTCALL,
  null as ASSET_STRIKEPRICE,
  null as ASSET_TICKVALUE,
  null as ASSET_TICKSIZE,
  null as ASSET_MULTIPLIER,
  null as ASSET_DEN,
  asset.ISINCODE as ASSET_ISINCODE,
  null as ASSET_ITM_OTM,
  null as ASSET_ATMATURITY,
  isnull(q.IDQUOTE_H,0) as IDQUOTE_H, 
  isnull(q.IDMARKETENV, ae.IDMARKETENV) as IDMARKETENV, 
  isnull(q.IDVALSCENARIO,ae.IDVALSCENARIO) as IDVALSCENARIO, 
  isnull(q.QUOTESIDE,ae.QUOTESIDE) as QUOTESIDE, 
  isnull(q.ISENABLED,1) as ISENABLED, 
  isnull(q.TIME,ae.TIME) as TIME,
  isnull(q.QUOTETIMING,ae.QUOTETIMING) as QUOTETIMING, 
  q.CASHFLOWTYPE as CASHFLOWTYPE,
  q.VALUE as VALUE, 
  isnull(q.QUOTEUNIT,ae.QUOTEUNIT) as QUOTEUNIT, 
  isnull(q.SPREADVALUE,0) as SPREADVALUE,
  null as TIMETOEXPIRATION,
  q.EXPIRITYTIME as EXPIRITYTIME,
  null as CONTRACTMULTIPLIER,
  isnull(q.SOURCE,'NA') as  SOURCE,
  isnull(q.ASSETMEASURE,ae.ASSETMEASURE) as ASSETMEASURE,
  q.IDC as IDC,q.IDBC as IDBC,q.IDM as IDM,
  q.IDAINS as IDAINS,q.DTINS as DTINS,q.IDAUPD as IDAUPD,q.DTUPD as DTUPD,
  q.EXTLLINK as EXTLLINK,q.ROWATTRIBUT as ROWATTRIBUT,q.ROWVERSION as ROWVERSION,
  null as ASSETUNL_IDM,
  null as IDASSET_UNL,
  null as ASSETCATEGORY_UNL,
  null as ASSETUNL_IDENT,
  null as ASSETUNLQUOTE_TIME,
  null as ASSETUNLQUOTE_QUOTESIDE,
  null as ASSETUNLQUOTE_QUOTETIMING,
  null as ASSETUNLQUOTE_VALUE,
  null as ASSETUNLQUOTE_SOURCE
  from (
    select a.IDASSET, 'OfficialClose' as QUOTESIDE, 'Close' as QUOTETIMING,  
    'ParValueDecimal' as QUOTEUNIT , 'CleanPrice' as ASSETMEASURE,
    'DEFAULT_MARKET_ENV' as IDMARKETENV,'EOD_VALUATION' as IDVALSCENARIO, @DATE1 as TIME
    from ASSET_EOD_%%SHORTSESSIONID%%_W a
    where a.ASSETCATEGORY = 'Bond'
  ) ae
  inner join dbo.VW_ASSET asset on asset.IDASSET = ae.IDASSET and asset.ASSETCATEGORY='Bond'
  left outer join dbo.QUOTE_DEBTSEC_H q on q.IDASSET=asset.IDASSET 
  and (
    (q.TIME = ae.TIME)
    or
    (convert(varchar,q.TIME,112) = convert(varchar,ae.TIME,112))
  )
  and (
    (q.QUOTESIDE= ae.QUOTESIDE) 
    or
    (isnull(q.QUOTESIDE,'OfficialClose') = case when ae.QUOTESIDE = 'OfficialClose' then 'OfficialClose' else 'xxx' end)
  ) 
  and (isnull(q.QUOTETIMING,'Close')= ae.QUOTETIMING) 
  and (q.IDMARKETENV=ae.IDMARKETENV) and (q.IDVALSCENARIO=ae.IDVALSCENARIO)
      ]]>
      </Command>
    </SQLSelect>

    <SQLRowStyle type="style">
      <![CDATA[
      case 
        when tblmain.IDQUOTE_H = 0 then 
          'background-color:#DCDCDC'
        when tblmain.ISENABLED = 0  then
          'background-color:#f7b7b8'
        else 
          'background-color:#ffffff'
      end
      ]]>
    </SQLRowStyle>

    <SQLRowState>
      <!-- 
      FI 20160222
      ACTIVITY OTC: le prix sur les asset titres est optionnel puisque jusqu'à ce jour ne l'utilise pas (aucune VALO par exemple) 
      Remarque : L'absence du prix d'un asset titre génère un warning en cas d'absence même s'il est non utilisé
      EG 20200930 
      [XXXXX] Nouvelle interface GUI v10 (Mode Noir ou blanc) Correction      
      -->
      <![CDATA[
      case tblmain.ACTIVITYTYPE 
        when 1 then
          case 
            when (tblmain.IDQUOTE_H = 0) then
              case when tblmain.ASSET_CATEGORY = 'O' and tblmain.ASSET_ATMATURITY='1' then
                'img=class:fa-icon far fa-check-square gray;title:imgOptional'
              else 
                'img=class:fa-icon fas fa-window-close red;title:imgMissing'  
              end  
            when (tblmain.IDQUOTE_H > 0 ) and (tblmain.ISENABLED = 0) then 
              'img=class:fa-icon far fa-check-square orange;title:imgNotCertified' 
            else 
              'img=class:fa-icon fas fa-check-square green;title:imgAvailable' 
          end 
          || '+' ||
          case when tblmain.ASSET_ATMATURITY='1' then 'img=class:fa-icon fas fa-calendar-day;title:imgAtMaturity' else '' end
        when 2 then
          case 
            when (tblmain.IDQUOTE_H = 0) then
              case 
                when tblmain.ASSET_TYPE= 'Bond' then 
                  'img=class:fa-icon far fa-check-square gray;title:imgOptional'
                else     
                  'img=class:fa-icon fas fa-window-close red;title:imgMissing'
              end
            when (tblmain.IDQUOTE_H > 0 ) and (tblmain.ISENABLED = 0) then 
              'img=class:fa-icon far fa-check-square orange;title:imgNotCertified' 
            else 
              'img=class:fa-icon fas fa-check-square green;title:imgAvailable' 
          end 
      end
      ]]>
    </SQLRowState>

    <Column>
      <ColumnPositionInDataGrid>0</ColumnPositionInDataGrid>
      <ColumnName>KEYVALUE</ColumnName>
      <Ressource>KEYVALUE</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsDataKeyField>true</IsDataKeyField>
      <Relation/>
      <html_BLOCK title="Characteristics"></html_BLOCK>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>1</ColumnPositionInDataGrid>
      <ColumnName>IDQUOTE_H</ColumnName>
      <Ressource>IDQUOTE_H</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsIdentity>true</IsIdentity>
      <Relation/>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>2</ColumnPositionInDataGrid>
      <ColumnName>PRICESTATUS</ColumnName>
      <Ressource>STATUSRETURN</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsUpdatable>false</IsUpdatable>
      <IsVirtualColumn>true</IsVirtualColumn>
      <IsOrderBy>false</IsOrderBy>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>3</ColumnPositionInDataGrid>
      <ColumnName>IDMARKETENV</ColumnName>
      <Ressource>IDMARKETENV</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>true</IsOrderBy>
      <Relation>
        <TableName>MARKETENV</TableName>
        <ColumnRelation>
          <ColumnName>IDMARKETENV</ColumnName>
          <DataType>string</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>IDMARKETENV</ColumnName>
          <Ressource>IDMARKETENV</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
      </Relation>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>4</ColumnPositionInDataGrid>
      <ColumnName>IDVALSCENARIO</ColumnName>
      <Ressource>IDVALSCENARIO</Ressource>
      <DataType>string</DataType>
      <Colspan>3</Colspan>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>true</IsOrderBy>
      <Relation>
        <TableName>VALSCENARIO</TableName>
        <ColumnRelation>
          <ColumnName>IDVALSCENARIO</ColumnName>
          <DataType>string</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>IDVALSCENARIO</ColumnName>
          <Ressource>IDVALSCENARIO</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
      </Relation>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>5</ColumnPositionInDataGrid>
      <ColumnName>ISENABLED</ColumnName>
      <Ressource>ISENABLEDQUOTE</Ressource>
      <DataType>bool</DataType>
      <Colspan>0</Colspan>
      <Length>1</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default>
        <Value>1</Value>
      </Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation/>
      <Information>
        <Type>information</Type>
        <LabelMessage>Msg_ISENABLEDForQUOTE_H</LabelMessage>
      </Information>
      <html_HR></html_HR>
    </Column>

    <!-- ASSET -->
    <Column>
      <ColumnPositionInDataGrid>6</ColumnPositionInDataGrid>
      <ColumnName>ASSET_TYPE</ColumnName>
      <Ressource>ASSETTYPE</Ressource>
      <DataType>string</DataType>
      <Colspan>0</Colspan>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsUpdatable isupdatableincreation="false" >false</IsUpdatable>
      <IsOrderBy order="
      case @ACTIVITYTYPE 
            when 1 then
              case ASSET_TYPE 
                when 'ExchangeTradedContract' then 
                  case  when ASSET_CATEGORY = 'F' Then 12
                        when ASSET_PUTCALL = 'Call' then 11
                        else 10
                  end
                when 'Index' then 9  
                when 'EquityAsset' then 8 
                when 'Commodity' then 7 
                when 'ExchangeTradedFund' then 6
                else 0
              end             
            when 2 then
              case ASSET_TYPE 
                when 'Index' then 12 
                when 'EquityAsset' then 11
                when 'Bond' then 10
                else 0
            end
      end  desc">true</IsOrderBy>
      <IsAutoPostBack>false</IsAutoPostBack>
      <Relation>
        <DDLType>underlyingasset</DDLType>
      </Relation>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>7</ColumnPositionInDataGrid>
      <ColumnName>ASSET_IDM</ColumnName>
      <Ressource>IDM</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <Relation>
        <TableName>VW_MARKET_IDENTIFIER</TableName>
        <AliasTableName>mktident</AliasTableName>
        <ColumnRelation>
          <ColumnName>IDM</ColumnName>
          <DataType>int</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>SHORT_ACRONYM</ColumnName>
          <Ressource>IDM_SHORT_ACRONYM</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
        <AutoComplete enabled="true"/>
      </Relation>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>8</ColumnPositionInDataGrid>
      <ColumnName>IDASSET</ColumnName>
      <Ressource>IDASSET</Ressource>
      <DataType>int</DataType>
      <Colspan>0</Colspan>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <html_BLOCK title="Quotation_Title"></html_BLOCK>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>9</ColumnPositionInDataGrid>
      <ColumnName>ASSET_IDENTIFIER</ColumnName>
      <Ressource>IDENTIFIER_ASSET</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsUpdatable isupdatableincreation="false" >false</IsUpdatable>
      <IsOrderBy order="ASSET_IDENTIFIER asc">true</IsOrderBy>
      <IsHyperLink linktype="column" type="IDASSET" data="IDASSET">true</IsHyperLink>
      <Relation/>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>10</ColumnPositionInDataGrid>
      <ColumnName>ASSET_DSP</ColumnName>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Ressource></Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <Relation/>
    </Column>

    <!-- QUOTE -->
    <Column>
      <ColumnPositionInDataGrid>11</ColumnPositionInDataGrid>
      <ColumnName>TIME</ColumnName>
      <Ressource>TIME</Ressource>
      <DataType>datetime</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation/>
      <html_HR size="1"></html_HR>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>20</ColumnPositionInDataGrid>
      <ColumnName>SOURCE</ColumnName>
      <Ressource>PROVIDER</Ressource>
      <DataType>string</DataType>
      <Length>128</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default>
        <Value>ManualInput</Value>
      </Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation>
        <DDLType>enum.InformationProvider</DDLType>
      </Relation>
      <CellStyle type="style">
        <When test="=ManualInput">color:firebrick</When>
        <When test="=NA">color:red</When>
      </CellStyle>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>12</ColumnPositionInDataGrid>
      <ColumnName>QUOTESIDE</ColumnName>
      <Ressource>QUOTESIDE</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>true</IsOrderBy>
      <CellStyle model="quoteside"/>
      <Relation>
        <DDLType>enum.QuotationSideEnum</DDLType>
      </Relation>
      <html_HR></html_HR>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>13</ColumnPositionInDataGrid>
      <ColumnName>QUOTETIMING</ColumnName>
      <Ressource>QUOTETIMING</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default>
        <Value>Close</Value>
      </Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation>
        <DDLType>enum.QuoteTiming</DDLType>
      </Relation>
      <CellStyle model="quotetiming"/>
      <!--      
      <CellStyle type="style">
        <When test="=Open">color:darkcyan</When>
        <When test="=Close">color:royalblue</When>
      </CellStyle>
-->
    </Column>
    <Column>
      <ColumnPositionInDataGrid>14</ColumnPositionInDataGrid>
      <ColumnName>QUOTEUNIT</ColumnName>
      <Ressource>QUOTEUNIT</Ressource>
      <DataType>string</DataType>
      <Colspan>0</Colspan>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation>
        <DDLType>enum.PriceQuoteUnits</DDLType>
      </Relation>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>15</ColumnPositionInDataGrid>
      <ColumnName>VALUE</ColumnName>
      <Ressource>VALUE</Ressource>
      <DataType>dec</DataType>
      <Align>left</Align>
      <Length>15</Length>
      <!--<Scale>4</Scale>-->
      <!--<Scale>6</Scale>-->
      <Scale>9</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <!--IsQuantity>true</IsQuantity-->
      <!--<CellStyle model="quantity"/>-->
      <Relation/>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>16</ColumnPositionInDataGrid>
      <ColumnName>SPREADVALUE</ColumnName>
      <Ressource>SPREADVALUE</Ressource>
      <DataType>dec</DataType>
      <!--<Colspan>0</Colspan>-->
      <Align>left</Align>
      <Length>15</Length>
      <Scale>9</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default>
        <Value>0</Value>
      </Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>17</ColumnPositionInDataGrid>
      <ColumnName>EXPIRITYTIME</ColumnName>
      <Ressource>EXPIRITYTIME</Ressource>
      <DataType>datetime</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation/>
      <html_HR size="1"></html_HR>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>18</ColumnPositionInDataGrid>
      <ColumnName>TIMETOEXPIRATION</ColumnName>
      <Ressource>TIMETOEXPIRATION</Ressource>
      <DataType>dec</DataType>
      <!--<Colspan>3</Colspan>-->
      <Align>left</Align>
      <Length>26</Length>
      <Scale>9</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation/>
      <Information>
        <Type>information</Type>
        <ToolTipMessage>
          <![CDATA[<b>FIX:</b>\r\nTag 1189 TimeToExpiration.\r\nTime to expiration in years calculated as the number of days remaining to expiration divided by 365 days per year.]]>
        </ToolTipMessage>
      </Information>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>19</ColumnPositionInDataGrid>
      <ColumnName>CONTRACTMULTIPLIER</ColumnName>
      <Ressource>CONTRACTMULTIPLIER</Ressource>
      <DataType>decimal</DataType>
      <Colspan>0</Colspan>
      <Length>26</Length>
      <Scale>9</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation/>
      <Information>
        <Type>information</Type>
        <!--<ToolTipMessage>Msg_CONTRACTMULTIPLIERForQUOTE_ETD_H</ToolTipMessage>-->
        <LabelMessage>Msg_CONTRACTMULTIPLIERForQUOTE_ETD_H</LabelMessage>
      </Information>
      <html_HR size="1"></html_HR>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>21</ColumnPositionInDataGrid>
      <ColumnName>ASSETMEASURE</ColumnName>
      <Ressource>ASSETMEASURE</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation>
        <DDLType>enum.AssetMeasure</DDLType>
      </Relation>
      <html_HR></html_HR>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>22</ColumnPositionInDataGrid>
      <ColumnName>IDC</ColumnName>
      <Ressource>IDC</Ressource>
      <DataType>string</DataType>
      <Length>3</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation>
        <DDLType>currency</DDLType>
      </Relation>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>23</ColumnPositionInDataGrid>
      <ColumnName>IDBC</ColumnName>
      <Ressource>IDBC</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation>
        <DDLType>businesscenter</DDLType>
      </Relation>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>24</ColumnPositionInDataGrid>
      <ColumnName>CASHFLOWTYPE</ColumnName>
      <Ressource>CASHFLOWTYPE</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation>
        <DDLType>enum.cashFlow</DDLType>
      </Relation>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>25</ColumnPositionInDataGrid>
      <ColumnName>IDM</ColumnName>
      <Ressource>IDM</Ressource>
      <DataType>int</DataType>
      <Colspan>0</Colspan>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsUpdatable>true</IsUpdatable>
      <Relation>
        <TableName>VW_MARKET_IDENTIFIER</TableName>
        <AliasTableName>mi</AliasTableName>
        <ColumnRelation>
          <ColumnName>IDM</ColumnName>
          <DataType>int</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>SHORT_ACRONYM</ColumnName>
          <Ressource>IDM_SHORT_ACRONYM</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
        <AutoComplete enabled="true"/>
      </Relation>
    </Column>

    <Column>
      <ColumnPositionInDataGrid>26</ColumnPositionInDataGrid>
      <ColumnName>IDAINS</ColumnName>
      <Ressource>IDAINS</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <Relation>
        <TableName>ACTOR</TableName>
        <AliasTableName>insa</AliasTableName>
        <ColumnRelation>
          <ColumnName>IDA</ColumnName>
          <DataType>int</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>DISPLAYNAME</ColumnName>
          <Ressource>DISPLAYNAME</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
      </Relation>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>27</ColumnPositionInDataGrid>
      <ColumnName>DTINS</ColumnName>
      <Ressource>DTINS</Ressource>
      <DataType>date</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>28</ColumnPositionInDataGrid>
      <ColumnName>IDAUPD</ColumnName>
      <Ressource>IDAUPD</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <Relation>
        <TableName>ACTOR</TableName>
        <AliasTableName>upda</AliasTableName>
        <ColumnRelation>
          <ColumnName>IDA</ColumnName>
          <DataType>int</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>DISPLAYNAME</ColumnName>
          <Ressource>DISPLAYNAME</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
      </Relation>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>29</ColumnPositionInDataGrid>
      <ColumnName>DTUPD</ColumnName>
      <Ressource>DTUPD</Ressource>
      <DataType>date</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>30</ColumnPositionInDataGrid>
      <ColumnName>EXTLLINK</ColumnName>
      <Ressource>EXTLLINK</Ressource>
      <DataType>string</DataType>
      <Colspan>0</Colspan>
      <Length>128</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation/>
      <html_BLOCK title="ExtlLink_" columnbyrow="2"></html_BLOCK>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>31</ColumnPositionInDataGrid>
      <ColumnName>ROWATTRIBUT</ColumnName>
      <Ressource>ROWATTRIBUT</Ressource>
      <DataType>string</DataType>
      <Length>1</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>32</ColumnPositionInDataGrid>
      <ColumnName>ROWVERSION</ColumnName>
      <Ressource>ROWVERSION</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsUpdatable>true</IsUpdatable>
      <Relation/>
    </Column>

    <!-- ASSET_UNL -->
    <Column>
      <ColumnPositionInDataGrid>33</ColumnPositionInDataGrid>
      <ColumnName>ASSET_ITM_OTM</ColumnName>
      <Ressource>COL_ITM_OTM</Ressource>
      <DataType>string</DataType>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsVirtualColumn>true</IsVirtualColumn>
      <CellStyle model="moneyposition" />
      <Align>Center</Align>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>34</ColumnPositionInDataGrid>
      <ColumnName>ASSETUNL_IDM</ColumnName>
      <Ressource>COL_ASSETUNL_IDM</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Relation>
        <TableName>VW_MARKET_IDENTIFIER</TableName>
        <AliasTableName>unlMarket</AliasTableName>
        <ColumnRelation>
          <ColumnName>IDM</ColumnName>
          <DataType>int</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>SHORT_ACRONYM</ColumnName>
          <Ressource>COL_ASSETUNL_IDM</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
      </Relation>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>35</ColumnPositionInDataGrid>
      <ColumnName>IDASSET_UNL</ColumnName>
      <Ressource>COL_IDASSETUNL</Ressource>
      <DataType>int</DataType>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsVirtualColumn>true</IsVirtualColumn>
    </Column>

    <Column>
      <ColumnPositionInDataGrid>36</ColumnPositionInDataGrid>
      <ColumnName>ASSETUNL_IDENT</ColumnName>
      <Ressource>COL_IDASSETUNL</Ressource>
      <DataType>string</DataType>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInCriteria>false</IsHideInCriteria>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Relation/>
      <IsHyperLink linktype="column" type="IDASSET_UNL" data="IDASSET_UNL">true</IsHyperLink>
    </Column>

    <Column>
      <ColumnPositionInDataGrid>37</ColumnPositionInDataGrid>
      <ColumnName>ASSETUNLQUOTE_TIME</ColumnName>
      <Ressource>COL_ASSETUNLQUOTE_TIME</Ressource>
      <DataType>datetime</DataType>
      <Length>8</Length>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Relation/>
    </Column>

    <Column>
      <ColumnPositionInDataGrid>38</ColumnPositionInDataGrid>
      <ColumnName>ASSETUNLQUOTE_QUOTESIDE</ColumnName>
      <Ressource>COL_ASSETUNLQUOTE_QUOTESIDE</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsVirtualColumn>true</IsVirtualColumn>
      <CellStyle model="quoteside"/>
      <Relation>
        <DDLType>enum.QuotationSideEnum</DDLType>
      </Relation>
    </Column>

    <Column>
      <ColumnPositionInDataGrid>39</ColumnPositionInDataGrid>
      <ColumnName>ASSETUNLQUOTE_QUOTETIMING</ColumnName>
      <Ressource>COL_ASSETUNLQUOTE_QUOTETIMING</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Relation>
        <DDLType>enum.QuoteTiming</DDLType>
      </Relation>
      <CellStyle type="style">
        <When test="=Open">color:darkcyan</When>
        <When test="=Close">color:royalblue</When>
      </CellStyle>
    </Column>

    <Column>
      <ColumnPositionInDataGrid>40</ColumnPositionInDataGrid>
      <ColumnName>ASSETUNLQUOTE_VALUE</ColumnName>
      <Ressource>COL_ASSETUNLQUOTE_VALUE</Ressource>
      <DataType>dec</DataType>
      <Align>left</Align>
      <Length>15</Length>
      <!--<Scale>4</Scale>-->
      <Scale>6</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <CellStyle model="quantity"/>
      <IsVirtualColumn>true</IsVirtualColumn>
    </Column>

    <Column>
      <ColumnPositionInDataGrid>41</ColumnPositionInDataGrid>
      <ColumnName>ASSETUNLQUOTE_SOURCE</ColumnName>
      <Ressource>COL_ASSETUNLQUOTE_PROVIDER</Ressource>
      <DataType>string</DataType>
      <Length>128</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Relation>
        <DDLType>enum.InformationProvider</DDLType>
      </Relation>
      <CellStyle type="style">
        <When test="=ManualInput">color:firebrick</When>
        <When test="=NA">color:red</When>
      </CellStyle>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>42</ColumnPositionInDataGrid>
      <ColumnName>ASSET_ISINCODE</ColumnName>
      <Ressource>COL_ISINCODE</Ressource>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Ressource>Empty</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>43</ColumnPositionInDataGrid>
      <ColumnName>ASSET_IDDC</ColumnName>
      <Ressource>COL_CONTRACTIDENTIFIER_</Ressource>
      <Colspan>0</Colspan>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <Relation>
        <TableName>DERIVATIVECONTRACT</TableName>
        <AliasTableName>dc_etd</AliasTableName>
        <ColumnRelation>
          <ColumnName>IDDC</ColumnName>
          <DataType>int</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>IDENTIFIER</ColumnName>
          <Ressource>COL_CONTRACTIDENTIFIER_</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
        <ColumnLabel>
          <ColumnName>DISPLAYNAME</ColumnName>
          <Ressource>DISPLAYNAME</Ressource>
          <DataType>string</DataType>
        </ColumnLabel>
      </Relation>
      <IsVirtualColumn>true</IsVirtualColumn>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>44</ColumnPositionInDataGrid>
      <ColumnName>ASSET_DC_IDENT</ColumnName>
      <Ressource>COL_CONTRACTIDENTIFIER_</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHyperLink linktype="column" type="IDDC" data="ASSET_IDDC">true</IsHyperLink>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Relation/>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>45</ColumnPositionInDataGrid>
      <ColumnName>ASSET_DC_DSP</ColumnName>
      <Ressource></Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Relation/>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>55</ColumnPositionInDataGrid>
      <ColumnName>ASSET_CATEGORY</ColumnName>
      <Ressource>CATEGORY</Ressource>
      <DataType>string</DataType>
      <Length>1</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <Relation>
        <TableName>ENUM</TableName>
        <AliasTableName>cficode</AliasTableName>
        <ColumnRelation>
          <ColumnName>VALUE</ColumnName>
          <DataType>string</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>EXTVALUE</ColumnName>
          <Ressource>CATEGORY</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
        <Condition apply="ALL">
          <SQLWhere>CODE='CfiCodeCategoryEnum'</SQLWhere>
        </Condition>
      </Relation>
      <IsVirtualColumn>true</IsVirtualColumn>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>46</ColumnPositionInDataGrid>
      <ColumnName>ASSET_PUTCALL</ColumnName>
      <Ressource>COL_PutCall_</Ressource>
      <DataType>string</DataType>
      <Length>1</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Relation/>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>54</ColumnPositionInDataGrid>
      <ColumnName>ASSET_IDMATURITY</ColumnName>
      <Ressource>COL_MATFMT_PROFIL</Ressource>
      <DataType>int</DataType>
      <Colspan>0</Colspan>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
        <TableName>MATURITY</TableName>
        <ColumnRelation>
          <ColumnName>IDMATURITY</ColumnName>
          <DataType>int</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>MATURITYMONTHYEAR</ColumnName>
          <Ressource>MATURITYMONTHYEAR</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
      </Relation>
      <IsVirtualColumn>true</IsVirtualColumn>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>56</ColumnPositionInDataGrid>
      <ColumnName>ASSET_MATFMT_FIX</ColumnName>
      <Ressource>COL_MATURITYMONTHYEAR_ASSET</Ressource>
      <IsResource>false</IsResource>
      <DataType>string</DataType>
      <Colspan>0</Colspan>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInCriteria>false</IsHideInCriteria>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsHideInCriteria>false</IsHideInCriteria>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Relation/>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>47</ColumnPositionInDataGrid>
      <ColumnName>ASSET_MATFMT_PROFIL</ColumnName>
      <Ressource>COL_NOM_ECHE</Ressource>
      <IsResource>true</IsResource>
      <DataType>string</DataType>
      <Colspan>0</Colspan>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Relation/>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>48</ColumnPositionInDataGrid>
      <ColumnName>ASSET_MATURITYDATE</ColumnName>
      <Ressource></Ressource>
      <DataType>date</DataType>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInCriteria>false</IsHideInCriteria>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Relation/>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>49</ColumnPositionInDataGrid>
      <ColumnName>ASSET_STRIKEPRICE</ColumnName>
      <Ressource>STRIKEVALUE</Ressource>
      <DataType>dec</DataType>
      <Align>left</Align>
      <InputWidth>150</InputWidth>
      <Length>9</Length>
      <!--<Scale>4</Scale>-->
      <Scale>5</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsVirtualColumn>true</IsVirtualColumn>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>50</ColumnPositionInDataGrid>
      <ColumnName>ASSET_TICKVALUE</ColumnName>
      <Ressource>MINPRICEINCRAMOUNT</Ressource>
      <DataType>dec</DataType>
      <Scale>9</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsVirtualColumn>true</IsVirtualColumn>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>51</ColumnPositionInDataGrid>
      <ColumnName>ASSET_TICKSIZE</ColumnName>
      <Ressource>MINPRICEINCR</Ressource>
      <DataType>dec</DataType>
      <Colspan>2</Colspan>
      <Length>15</Length>
      <Scale>9</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsVirtualColumn>true</IsVirtualColumn>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>52</ColumnPositionInDataGrid>
      <ColumnName>ASSET_MULTIPLIER</ColumnName>
      <Ressource>CONTRACTMULTIPLIER</Ressource>
      <DataType>dec</DataType>
      <Colspan>2</Colspan>
      <Length>26</Length>
      <Scale>9</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Relation/>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>53</ColumnPositionInDataGrid>
      <ColumnName>ASSET_DEN</ColumnName>
      <Ressource>INSTRUMENTDEN</Ressource>
      <DataType>dec</DataType>
      <Colspan>2</Colspan>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Relation/>
    </Column>
    <Column>
      <ColumnPositionInDataGrid>57</ColumnPositionInDataGrid>
      <ColumnName>ASSETCATEGORY_UNL</ColumnName>
      <Ressource>CATEGORY</Ressource>
      <DataType>string</DataType>
      <Length>1</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsVirtualColumn>true</IsVirtualColumn>
    </Column>

    <Column>
      <ColumnPositionInDataGrid>58</ColumnPositionInDataGrid>
      <ColumnName>ASSET_ATMATURITY</ColumnName>
      <Ressource>ATMATURITY</Ressource>
      <DataType>string</DataType>
      <Length>1</Length>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsVirtualColumn>true</IsVirtualColumn>
    </Column>

  </Referential>
</Referentials>
<!-- Sample -->
<!-- <html_BLOCK title="Sample" blockbyrow="2" width="75%" columnbyrow="1"></html_BLOCK> -->
<!-- <html_HR title="Sample"></html_HR> -->
<!-- <Information> -->
<!-- <Type>information|warning</Type> -->
<!-- <ToolTipMessage|PopupMessage|LabelMessage> -->
<!-- Message... -->
<!-- </ToolTipMessage|PopupMessage|LabelMessage> -->
<!-- </Information> -->
