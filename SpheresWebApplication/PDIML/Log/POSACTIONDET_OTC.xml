<?xml version="1.0" encoding="utf-8" ?>
<!-- 
EG 20170412 [23081] New pour filtrage des décompensations jours sur négociations jour (ISWITHTODAYUNCLEARING)
CC/PL 20151029 [21494] Modify length of column QTY 
FI 20140610 [19923] add element RequestTrack 
FI 20120119 add IsUseSQLParameters==true 
FI 20120228 new expression for columns IDT and IDT_OFFSETBY
FI 20120516 Refactoring cette consultation 3 bts s'approche de la consultation 5 bts 
FI 20120904 [18113] Nouveau standard, les tables de travail(temporaires) se terminent par _W
FI 20120926 [] usage of data attribute for HyperLink column
EG 20200226 [25077] RDBMS : New version of Trades tables architecture (TRADEINSTRUMENT (INSTRUMENTNO=1) to TRADE)
FI 20200820 [25468] dates systemes en UTC
-->

<!-- Remarques
    Contrairement à la consultation 5 boutons les transferts sont systématiquement affichés
    Ceci parce que sur l'écran de consultation du trade Spheres® affiche Transfert dans le pavé ACTION
    Cette consultation est en phase avec le pavé action de l'écran de consultation du trade (écran qui permet d'ouvrir cette consultation)
    
    Dans la consultation 5bts POSACTIONDET
    Les Transferts sont affichés comme Transfert uniquement si TRDTYPE = PositionTransfert (42) et TRDSUBTYPE vaut Internal transfer or adjustment(1)
    Les Transferts sont affichés comme Correction dans les autres cas, Le trade résultat du transfert est non accessible depuis le grid 
-->



<Referentials>
  <Referential>
    <IsUseSQLParameters>true</IsUseSQLParameters>
    <TableName>POSACTIONDET</TableName>
    <Ressource>TradeAuditAction</Ressource>
    <AliasTableName>posact</AliasTableName>
    <Create>false</Create>
    <Modify>false</Modify>
    <Remove>false</Remove>
    <IsLoupe>false</IsLoupe>
    <IsDblClick>false</IsDblClick>

    <SQLPreSelectResource name="POSACTIONDET_OTC_TRADE_PRESELECT" />

    <SQLSelect>
      <Command rdbms = "all">
        <![CDATA[
        select ar.IDA as arCLIENT_IDA, posact.IDPR,  
        case when posact.DEACTIV = 1 then 'UNCLEARING' else case when posact.REQUESTTYPE ='UNCLEARING' then 'RECLEARING' else posact.REQUESTTYPE end end as REQUESTTYPE_VALUE,
        en.EXTVALUE as REQUESTTYPE_EXTVALUE, 
        posact.IDPA, posact.IDPADET, case when posact.DEACTIV = 1 then posact.DTUNCLEARING else posact.DTBUSINESS end as DTBUSINESS,
        posact.QTY, posact.DEACTIV, posact.DTSYS, 

        case when tr.IDA_DEALER = posact.RMG_IDA_PAY then case when posact.DEACTIV=0 then -1 else  1 end 
                                                     else case when posact.DEACTIV=0 then  1 else -1 end end * posact.RMG as COL_RMG,
        posact.RMG_IDC as COL_RMG_IDC, 

        tr.IDA_DEALER, tr.IDB_DEALER, tr.IDA_ENTITY,
        tr.IDT, posact.IDT2, tr.IDI, tr.IDASSET as IDASSET, tr.IDM as IDM, tr.IDA_CSSCUSTODIAN,
        
        asset.ASSETCATEGORY as CATEGORY, asset.IDENTIFIER_DISPLAYNAME as ASSET_IDENTIFIER, m.SHORT_ACRONYM as MARKET
        
        from POSACTIONDET_%%SHORTSESSIONID%%_W posact
        inner join dbo.VW_TRADE_FUNGIBLE_LIGHT_OTCSEC tr on (tr.IDT=posact.IDT)
        %%SR:TRADE_JOIN%%(tr.IDT, tr)
        inner join dbo.VW_ASSET asset on (asset.IDASSET = tr.IDASSET) and (asset.ASSETCATEGORY = tr.ASSETCATEGORY) 
        inner join dbo.VW_MARKET_IDENTIFIER m on (m.IDM = asset.IDM)
        left outer join dbo.ACTORROLE ar on (ar.IDA=tr.IDA_DEALER) and (ar.IDROLEACTOR='CLIENT') and (ar.IDA_ACTOR = tr.IDA_ENTITY)
        /*left outer join dbo.TRADEINSTRUMENT ti2 on ti2.IDT = posact.IDT2*/
        inner join dbo.ENUM en on (en.CODE='PosRequestTypeEnum') and 
        (en.VALUE = case when posact.DEACTIV = 1 then 'UNCLEARING' else case when posact.REQUESTTYPE ='UNCLEARING' then 'RECLEARING' else posact.REQUESTTYPE end end )
        where (%%SR:TRADE_WHERE_PREDICATE%%) 
        <choose> 
          <when test="{ISWITHTODAYUNCLEARING}=0">
            and ((posact.DTUNCLEARING is null) or (posact.DTUNCLEARING&lt;&gt;posact.DTBUSINESS))
          </when>
        </choose>
        
        ]]>
      </Command>
    </SQLSelect>

    <SQLRowStyle type="class">
      <![CDATA[
      case when posact.DEACTIV =1 then 'DataGrid-DEACTIV event-deactiv' else 'DataGrid_ItemStyle' end
      ]]>
    </SQLRowStyle>

    <RequestTrack>
      <RequestTrackData>
        <ColumnIdA alias="RTK_IDA_DEALER">
          <![CDATA[IDA_DEALER]]>
        </ColumnIdA>
        <ColumnIdB alias="RTK_IDB_DEALER">
          <![CDATA[IDB_DEALER]]>
        </ColumnIdB>
        <ColumnGrp alias="RTK_GRP_DEALER">
          <![CDATA[case when arCLIENT_IDA=IDA_DEALER then 'Client' else 'Custodian' end ]]>
        </ColumnGrp>
      </RequestTrackData>
    </RequestTrack>
    
    

    <Column>
      <ColumnName>DEACTIV</ColumnName>
      <Ressource>DEACTIV</Ressource>
      <DataType>bool</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy order="DTSYS,IDPR,DTBUSINESS,IDPADET">true</IsOrderBy>
    </Column>

    <Column>
      <ColumnName>REQUESTTYPE_VALUE</ColumnName>
      <Ressource>VALUE_REQUESTTYPE</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
    </Column>

    <Column>
      <ColumnName>REQUESTTYPE_EXTVALUE</ColumnName>
      <Ressource>EXTVALUE_REQUESTTYPE_</Ressource>
      <DataType>string</DataType>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>false</IsHideInCriteria>
      <IsKeyField>false</IsKeyField>
      <IsDataKeyField>false</IsDataKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <CellStyle complexModel="posRequestType" version="h"/>
    </Column>

    <Column>
      <ColumnName>QTY</ColumnName>
      <Ressource>ConcernedQuantity</Ressource>
      <Align>left</Align>
      <DataType>decimal</DataType>
      <Length>20</Length>
      <Scale>3</Scale>
      <IsMandatory>true</IsMandatory>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <CellStyle model="quantity"/>
    </Column>
    <Column>
      <ColumnName>DTBUSINESS</ColumnName>
      <Ressource>DTBUSINESS_</Ressource>
      <DataType>date</DataType>
      <Length>8</Length>
      <IsMandatory>true</IsMandatory>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>false</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
    </Column>
    <Column>
      <ColumnName>DTSYS</ColumnName>
      <Ressource>COL_DTPOSACTION</Ressource>
      <DataType datakind='Timestamp' tzdbid='Etc/UTC' display='Audit'>datetime</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>false</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
    </Column>
    
    <Column>
      <ColumnName>IDPR</ColumnName>
      <Ressource></Ressource>
      <DataType>int</DataType>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsKeyField>false</IsKeyField>
      <IsDataKeyField>false</IsDataKeyField>
      <IsIdentity>false</IsIdentity>
      <IsOrderBy>false</IsOrderBy>
    </Column>

    <Column>
      <ColumnName>IDPADET</ColumnName>
      <Ressource></Ressource>
      <DataType>int</DataType>
      <IsMandatory>false</IsMandatory>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsKeyField>false</IsKeyField>
      <IsDataKeyField>false</IsDataKeyField>
      <IsIdentity>false</IsIdentity>
      <IsOrderBy>false</IsOrderBy>
    </Column>
    
    <Column>
      <ColumnName>IDM</ColumnName>
      <Ressource>COL_Market</Ressource>
      <DataType>int</DataType>
      <IsMandatory>false</IsMandatory>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsKeyField>false</IsKeyField>
      <IsDataKeyField>false</IsDataKeyField>
      <IsIdentity>false</IsIdentity>
      <IsOrderBy>false</IsOrderBy>
    </Column>
    <Column>
      <ColumnName>MARKET</ColumnName>
      <Ressource>COL_Market</Ressource>
      <DataType>string</DataType>
      <IsMandatory>false</IsMandatory>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsHideInCriteria>false</IsHideInCriteria>
      <IsKeyField>false</IsKeyField>
      <IsDataKeyField>false</IsDataKeyField>
      <IsIdentity>false</IsIdentity>
      <IsOrderBy>false</IsOrderBy>
      <IsHyperLink linktype="column" type="IDM" data="IDM">true</IsHyperLink>
    </Column>
    <Column>
      <ColumnName>IDI</ColumnName>
      <Ressource>IDI</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
        <TableName>INSTRUMENT</TableName>
        <ColumnRelation>
          <ColumnName>IDI</ColumnName>
          <DataType>int</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>IDENTIFIER</ColumnName>
          <Ressource>Instrument</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
        <ColumnLabel>
          <ColumnName>DISPLAYNAME</ColumnName>
          <Ressource>DISPLAYNAME</Ressource>
          <DataType>string</DataType>
        </ColumnLabel>
      </Relation>
      <html_BLOCK title="PosKeepingKey" blockbyrow="2" width="50%" columnbyrow="1"></html_BLOCK>
    </Column>
    <Column>
      <ColumnName>IDASSET</ColumnName>
      <Ressource>IdAsset</Ressource>
      <DataType>int</DataType>
      <IsMandatory>false</IsMandatory>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsKeyField>false</IsKeyField>
      <IsDataKeyField>false</IsDataKeyField>
      <IsIdentity>false</IsIdentity>
      <IsOrderBy>false</IsOrderBy>
    </Column>
    <Column>
      <ColumnName>ASSET_IDENTIFIER</ColumnName>
      <Ressource>IdAsset</Ressource>
      <DataType>string</DataType>
      <Colspan>0</Colspan>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <html_HR size="1"></html_HR>
    </Column>

    <Column>
      <ColumnName>IDT</ColumnName>
      <Ressource>ConcernedTrade</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
        <TableName>TRADE</TableName>
        <AliasTableName>t2</AliasTableName>
        <ColumnRelation>
          <ColumnName>IDT</ColumnName>
          <DataType>int</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>IDENTIFIER</ColumnName>
          <Ressource>ConcernedTrade</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
        <ColumnLabel>
          <ColumnName>DISPLAYNAME</ColumnName>
          <Ressource>DISPLAYNAME</Ressource>
          <DataType>string</DataType>
        </ColumnLabel>
      </Relation>
      <html_HR size="2"></html_HR>
    </Column>
    <Column>
      <ColumnName>IDT2</ColumnName>
      <Ressource>TBL_TRADE2(POSACTIONDET)</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
        <TableName>TRADE</TableName>
        <AliasTableName>tr2</AliasTableName>
        <ColumnRelation>
          <ColumnName>IDT</ColumnName>
          <DataType>int</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>IDENTIFIER</ColumnName>
          <Ressource>TBL_TRADE2(POSACTIONDET)</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
        <ColumnLabel>
          <ColumnName>DISPLAYNAME</ColumnName>
          <Ressource>DISPLAYNAME</Ressource>
          <DataType>string</DataType>
        </ColumnLabel>
      </Relation>
    </Column>

    <Column>
      <ColumnName>COL_RMG</ColumnName>
      <Ressource>COL_RMG_SIGNED</Ressource>
      <DataType>dec</DataType>
      <Scale>2</Scale>
      <IsMandatory>false</IsMandatory>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
    </Column>
    <Column>
      <ColumnName>COL_RMG_IDC</ColumnName>
      <DataType>string</DataType>
      <Length>3</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
        <DDLType>currency</DDLType>
      </Relation>
    </Column>

  </Referential>

</Referentials>
