<?xml version="1.0" encoding="utf-8"?>
<!-- FI 20151015 [21262] Usage de choose -->
<!-- FI 20120926 [] usage of data attribute for HyperLink column-->
<!-- FI 20120131 [] refactoring query pour amélioration des performances
                    La query ne s'appuie plus sur VW_TRADE
                    Avec PL il est décidé de conserver p.GPRODUCT not in ('ADM','RISK')
                    Avant ( ds VW_TRADE) il y avait (p.GPRODUCT not in ('ADM','RISK') or (p.IDENTIFIER in ('cashBalance','cashPayment')))-->
<!-- FI 20120119 [] mise de IsUseSQLParameters -->
<!-- FI 20120102 [] mise en place des mots clefs %%SR -->
<!-- RD 20100810 [] Restriction pour les messages de type : MONO-TRADE-->
<!-- FI 20100729 [17103] mise à jour jointures sur SESSIONRESTRICT-->
<!-- CC 20091013  Replace VW_TRADE2 by VW_TRADE for display Trade only -->
<!-- FI 20190614 [23912] Gestion de ORDERALLOC -->
<!-- RD 20190718 Manage DDL Notification type-->
<!-- EG 20191115 [25077] RDBMS : New version of Trades tables architecture (TRADESTSYS merge to TRADE, NEW TABLE TRADEXML)-->
<!-- EG 20200226 [25077] RDBMS : New version of Trades tables architecture (TRADEINSTRUMENT (INSTRUMENTNO=1) to TRADE)-->
<!-- FI 20200820 [25468] dates systemes en UTC -->
<Referentials>
  <Referential>
    <IsUseSQLParameters>true</IsUseSQLParameters>
    <TableName>VW_TRADE</TableName>
    <Ressource>TRADE</Ressource>
    <ColumnByRow>3</ColumnByRow>
    <Create>false</Create>
    <Modify>false</Modify>
    <Remove>false</Remove>
    <Notepad>false</Notepad>
    
    <SQLSelect>
      <Command rdbms="all">
        <![CDATA[
        select  
        t.IDT,t.IDENTIFIER, t.ORDERID, t.IDI, t.DTTRADE, t.SOURCE, t.EXTLLINK, t.DTSYS,
        t.IDSTENVIRONMENT, t.IDSTBUSINESS, t.IDSTACTIVATION, t.IDSTPRIORITY,
        p.GPRODUCT
        from dbo.TRADE t
        inner join dbo.INSTRUMENT i on i.IDI = t.IDI
        inner join dbo.PRODUCT p on p.IDP=i.IDP
        where t.IDT in 
        (
          select 
          <choose>                                    
              <when test="{CNFTYPE}=ORDERALLOC">
                max(t.IDT) as IDT
              </when>
              <when test="{CNFTYPE}!=ORDERALLOC">
                t.IDT
              </when>
          </choose>
          --t.IDT
          from  dbo.TRADE t
          inner join dbo.INSTRUMENT i on i.IDI = t.IDI
          inner join dbo.PRODUCT p on p.IDP=i.IDP and (p.GPRODUCT not in ('ADM','RISK'))
          %%SR:TRADE_JOIN%%(t.IDT, t)
          inner join dbo.EVENT e on e.IDT=t.IDT
          inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE
          
          /* Party */
          inner join dbo.TRADEACTOR ta on ta.IDT = t.IDT 
          and ta.IDROLEACTOR='COUNTERPARTY'
          and ((ta.ISNCMINI = 1) or (ta.ISNCMINT = 1) or  (ta.ISNCMFIN = 1))
          
          /* Book */
          left outer join dbo.BOOK b on b.IDB=ta.IDB
          <choose>                                    
            <when test="{ENTITY}>0">
               and (b.IDA_ENTITY = @ENTITY)
            </when>
          </choose>          
          inner join dbo.CNFMESSAGE cnfMsg on cnfMsg.MSGTYPE = 'MONO-TRADE'          
          <choose>                                    
            <when test="{CNFTYPE}!=ALL">
               and (cnfMsg.CNFTYPE = @CNFTYPE)
            </when>
          </choose>
          and (cnfMsg.EVENTCODE= e.EVENTCODE) 
          and (cnfMsg.EVENTCLASS = ec.EVENTCLASS)
          and (
				    (cnfMsg.STEPLIFE  =  case  when ta.ISNCMINI = 1 then 'INITIAL' else 'N/A' end) 
				    or 
				    (cnfMsg.STEPLIFE  =  case  when ta.ISNCMINT = 1 then 'INTERMEDIARY' else 'N/A' end) 
				    or 
				    (cnfMsg.STEPLIFE  =  case  when ta.ISNCMFIN = 1 then 'FINAL' else 'N/A' end) 
				    or 
				    (cnfMsg.STEPLIFE is null)
				      )
          and ((cnfMsg.DTDISABLED is null) or (cnfMsg.DTDISABLED > getdate()))
          
          where (t.IDSTENVIRONMENT in ('REGULAR','SIMUL'))
          
          <choose>                                    
              <when test="{ISTOEND}=true">
                and ec.DTEVENTFORCED &gt;= @DATE1
              </when>
              <when test="{ISTOEND}=false">
                and ec.DTEVENTFORCED = @DATE1
              </when>
          </choose>
          and (%%SR:TRADE_WHERE_PREDICATE%%)
          <choose>                                    
              <when test="{CNFTYPE}=ORDERALLOC">
                group by t.ORDERID
              </when>
          </choose>
        ) 
        
        ]]>
      </Command>
    </SQLSelect>

    <Column>
      <ColumnName>IDT</ColumnName>
      <Ressource>IDT</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression/>
      <Default/>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsDataKeyField>true</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>true</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>true</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDENTIFIER</ColumnName>
      <Ressource>IDENTIFIER_TRADE</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression/>
      <Default/>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>true</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>true</IsOrderBy>
      <IsHyperLink linktype="column" type="IDT" data="IDT">true</IsHyperLink>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>ORDERID</ColumnName>
      <Ressource>COL_ORDERID</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsKeyField>false</IsKeyField>
      <IsDataKeyField>false</IsDataKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsVirtualColumn>true</IsVirtualColumn>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDI</ColumnName>
      <Ressource>IDI</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression/>
      <Default/>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>true</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
        <TableName>INSTRUMENT</TableName>
        <ColumnRelation>
          <ColumnName>IDI</ColumnName>
          <DataType>int</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>IDENTIFIER</ColumnName>
          <Ressource>Instrument</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
        <ColumnLabel>
          <ColumnName>DISPLAYNAME</ColumnName>
          <Ressource>DISPLAYNAME</Ressource>
          <DataType>string</DataType>
        </ColumnLabel>
      </Relation>
    </Column>
    <Column>
      <ColumnName>DTTRADE</ColumnName>
      <Ressource>DTTRADE2</Ressource>
      <DataType>date</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression/>
      <Default/>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTENVIRONMENT</ColumnName>
      <Ressource>IDSTENVIRONMENT</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default/>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTBUSINESS</ColumnName>
      <Ressource>IDSTBUSINESS</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default/>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTACTIVATION</ColumnName>
      <Ressource>IDSTACTIVATION</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default/>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTPRIORITY</ColumnName>
      <Ressource>IDSTPRIORITY</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default/>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>DTSYS</ColumnName>
      <Ressource>DTSYS</Ressource>
      <DataType datakind='Timestamp' tzdbid='Etc/UTC' display='Audit'>datetime</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression/>
      <Default/>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>SOURCE</ColumnName>
      <Ressource>SOURCE</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression/>
      <Default/>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
        <DDLType>source</DDLType>
      </Relation>
    </Column>
    <Column>
      <ColumnName>EXTLLINK</ColumnName>
      <Ressource>EXTLLINK</Ressource>
      <DataType>string</DataType>
      <Length>128</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression/>
      <Default/>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>GPRODUCT</ColumnName>
      <Ressource>GPRODUCT</Ressource>
      <DataType>string</DataType>
      <Colspan>0</Colspan>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsHideInCriteria>true</IsHideInCriteria>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation/>
    </Column>
  </Referential>
</Referentials>
