<?xml version="1.0" encoding="utf-8" ?>
<!-- FI 20100729 [17103] mise à jour jointures sur SESSIONRESTRICT-->
<!-- FI 20120102 [] mise en place des mots clefs %%SR -->
<!-- FI 20120119 [] mise de IsUseSQLParameters -->
<!-- FI 20120926 [] usage of data attribute for HyperLink column-->
<!-- RD 20121009 [] Suppression des vues et unification des XML de lancement-->
<!-- EG 20191115 [25077] RDBMS : New version of Trades tables architecture (TRADESTSYS merge to TRADE, NEW TABLE TRADEXML)-->
<!-- FI 20200820 [25468] dates systemes en UTC -->
<Referentials>
  <Referential>
    <IsUseSQLParameters>true</IsUseSQLParameters>
    <TableName>TRADE</TableName>
    <Ressource>TRADE</Ressource>
    <ColumnByRow>3</ColumnByRow>
    <Create>false</Create>
    <Modify>false</Modify>
    <Remove>false</Remove>
    <Notepad>false</Notepad>

    <!-- 
      // ***********************************************************************************************
      // ATTENTION: 
      //      Toute Modification de cette query doit être reportée sur le service des Ecritures Comptabless (méthode AccountGenProcess.SelectTrade)
      //
      // Détails sur les valeurs du paramètre %%PARAM1%% du SQL optionnel (voir %%DH:SQLIF%%):
      //
      // COMMON : 
      //      - Exclure les trades Administratifs (Factures, ...)
      //      - Exclure les trades Asset (Titres, ...)
      //      - Exclure les trades Risk (Deposit, ...) SAUF: CashBalance et CashPayment
      //
      //      (p.GPRODUCT not in ('ADM','ASSET','RISK') or p.IDENTIFIER in ('cashBalance','cashPayment'))
      //
      // ADMIN : 
      //      - Tous les trades Administratifs (Factures, ...)
      //      
      //      (p.GPRODUCT='ADM')
      //
      // CBI : 
      //      - Les trades CashBalanceInterest (Echelle d'intérêts)
      //
      //      (p.IDENTIFIER='cashBalanceInterest')
      // ***********************************************************************************************
      -->
    
    <SQLSelect>
      <Command rdbms = "all">
        <![CDATA[
        select tblresult.IDT, tblresult.IDENTIFIER, tblresult.DISPLAYNAME, tblresult.DESCRIPTION, tblresult.IDI, tblresult.DTTRADE, tblresult.DTSYS,
        tblresult.IDSTENVIRONMENT, tblresult.IDSTBUSINESS, tblresult.IDSTACTIVATION, tblresult.IDSTPRIORITY,
        tblresult.SOURCE, tblresult.GPRODUCT, tblresult.EXTLLINK
        from
        (        
          /* ----------------------------------------------------------------------------------------------------------- */
          /* Tous les EARs du jour non annules                                                                           */
          /* Tous les EARs passes non annules, non deja ignores par le parametrage et qui n''ont pas genere d''ecritures */
          /* ----------------------------------------------------------------------------------------------------------- */
          select tblmain.IDT, tblmain.IDENTIFIER, tblmain.DISPLAYNAME, tblmain.DESCRIPTION, tblmain.IDI, tblmain.DTTRADE, tblmain.DTSYS, 
          tblmain.IDSTENVIRONMENT, tblmain.IDSTBUSINESS, tblmain.IDSTACTIVATION, tblmain.IDSTPRIORITY, 
          tblmain.SOURCE, p.GPRODUCT, tblmain.EXTLLINK
          from dbo.TRADE tblmain
          %%SR:%%PARAM2%%%%(tblmain.IDT)
          inner join dbo.INSTRUMENT i on (i.IDI=tblmain.IDI) and (i.ISACCOUNTING=1)
          inner join dbo.PRODUCT p on (p.IDP=i.IDP) and
          %%DH:SQLIF%%[%%PARAM1%%;COMMON;(p.GPRODUCT not in ('ADM','ASSET','RISK') or p.IDENTIFIER in ('cashBalance','cashPayment'))]
          %%DH:SQLIF%%[%%PARAM1%%;ADMIN;(p.GPRODUCT='ADM')]
          %%DH:SQLIF%%[%%PARAM1%%;CBI;(p.IDENTIFIER='cashBalanceInterest')]
          /* Ne pas considérer les événements des trades désactivés */
          inner join dbo.EAR ear on (ear.IDT=tblmain.IDT)
          left outer join dbo.EAR_ACCMODEL eam on (eam.IDEAR=ear.IDEAR)
          where 
          (
            (tblmain.IDSTENVIRONMENT='REGULAR') and (tblmain.IDSTACTIVATION='REGULAR') and
            /*EARs du jour non annulés*/
            ((ear.DTEVENT=@DATE1) and (ear.DTEVENTCANCEL is null))
            or
            (
              /*EARs passes non annulés*/
              (ear.DTEVENT<@DATE1)
              and (ear.DTEVENTCANCEL is null)
              /*non deja ignores par le parametrage*/
              and (eam.ISIGNORED is null or eam.ISIGNORED=0)
              /*pas d'écritures générées*/
              and not exists 
              (
                select 1
                from dbo.ACCDAYBOOK
                where (ACCDAYBOOK.IDEAR=ear.IDEAR)
              )
            )
          )
          and (%%SR:%%PARAM3%%%%)

          union

          /* ----------------------------------------------------------------- */
          /* Tous les EARs annules du jour et passes qui n'ont pas ete traites */
          /* ----------------------------------------------------------------- */
          select tblmain.IDT, tblmain.IDENTIFIER, tblmain.DISPLAYNAME, tblmain.DESCRIPTION, tblmain.IDI, tblmain.DTTRADE, tblmain.DTSYS, 
          tblmain.IDSTENVIRONMENT, tblmain.IDSTBUSINESS, tblmain.IDSTACTIVATION, tblmain.IDSTPRIORITY, 
          tblmain.SOURCE, p.GPRODUCT, tblmain.EXTLLINK
          from dbo.TRADE tblmain
          %%SR:%%PARAM2%%%%(tblmain.IDT)
          inner join dbo.INSTRUMENT i on (i.IDI=tblmain.IDI) and (i.ISACCOUNTING=1)
          inner join dbo.PRODUCT p on (p.IDP=i.IDP) and
          %%DH:SQLIF%%[%%PARAM1%%;COMMON;(p.GPRODUCT not in ('ADM','ASSET','RISK') or p.IDENTIFIER in ('cashBalance','cashPayment'))]
          %%DH:SQLIF%%[%%PARAM1%%;ADMIN;(p.GPRODUCT='ADM')]
          %%DH:SQLIF%%[%%PARAM1%%;CBI;(p.IDENTIFIER='cashBalanceInterest')]
          inner join dbo.EAR ear on (ear.IDT=tblmain.IDT)
          where (tblmain.IDSTENVIRONMENT='REGULAR') and           
          /*EARs annules du jour et passes*/
          (ear.DTEVENTCANCEL<=@DATE1)
          /*EARs annules NON traités*/
          and exists 
          (
            select 1
            from dbo.ACCDAYBOOK
            where (ACCDAYBOOK.IDEAR=ear.IDEAR)
            and (ACCDAYBOOK.DTACCDAYBOOKCANCEL is null)
          )
          and (%%SR:%%PARAM3%%%%) 

        ) tblresult        
        inner join dbo.TRADEACTOR tabuyer on (tabuyer.IDT=tblresult.IDT) and (tabuyer.IDROLEACTOR='COUNTERPARTY')  and (tabuyer.BUYER_SELLER='Buyer')
        inner join dbo.TRADEACTOR taseller on (taseller.IDT=tblresult.IDT) and (taseller.IDROLEACTOR='COUNTERPARTY') and (taseller.BUYER_SELLER='Seller')
        left outer join dbo.BOOK bbuyer on (bbuyer.IDB=tabuyer.IDB)
        left outer join dbo.BOOK bseller on (bseller.IDB=taseller.IDB)
        where (-1=@ENTITY or bbuyer.IDA_ENTITY=@ENTITY or bseller.IDA_ENTITY=@ENTITY)
        ]]>
      </Command>
    </SQLSelect>
    <Column>
      <ColumnName>IDT</ColumnName>
      <Ressource>IDT</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsDataKeyField>true</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>true</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>true</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDENTIFIER</ColumnName>
      <Ressource>IDENTIFIER</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>true</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>true</IsOrderBy>
      <IsHyperLink linktype="column" type="IDT" data="IDT">true</IsHyperLink>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>DISPLAYNAME</ColumnName>
      <Ressource>DISPLAYNAME</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>IDI</ColumnName>
      <Ressource>IDI</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>true</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
        <TableName>INSTRUMENT</TableName>
        <ColumnRelation>
          <ColumnName>IDI</ColumnName>
          <DataType>int</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>IDENTIFIER</ColumnName>
          <Ressource>Instrument</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
        <ColumnLabel>
          <ColumnName>DISPLAYNAME</ColumnName>
          <Ressource>DISPLAYNAME</Ressource>
          <DataType>string</DataType>
        </ColumnLabel>
      </Relation>
    </Column>
    <Column>
      <ColumnName>DTTRADE</ColumnName>
      <Ressource>DTTRADE</Ressource>
      <DataType>date</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>DTSYS</ColumnName>
      <Ressource>DTSYS</Ressource>
      <DataType datakind='Timestamp' tzdbid='Etc/UTC' display='Audit'>datetime</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTENVIRONMENT</ColumnName>
      <Ressource>IDSTENVIRONMENT</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTBUSINESS</ColumnName>
      <Ressource>IDSTBUSINESS</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTACTIVATION</ColumnName>
      <Ressource>IDSTACTIVATION</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTPRIORITY</ColumnName>
      <Ressource>IDSTPRIORITY</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>SOURCE</ColumnName>
      <Ressource>SOURCE</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
        <DDLType>source</DDLType>
      </Relation>
    </Column>
    <Column>
      <ColumnName>DESCRIPTION</ColumnName>
      <Ressource>DESCRIPTION</Ressource>
      <DataType>string</DataType>
      <Colspan>0</Colspan>
      <Length>128</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>GPRODUCT</ColumnName>
      <Ressource>GPRODUCT</Ressource>
      <DataType>string</DataType>
      <Colspan>0</Colspan>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>EXTLLINK</ColumnName>
      <Ressource>EXTLLINK</Ressource>
      <DataType>string</DataType>
      <Length>128</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
  </Referential>
</Referentials>
