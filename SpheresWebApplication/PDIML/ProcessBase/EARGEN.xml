<?xml version="1.0" encoding="utf-8" ?>
<!-- FI 20100729 [17103] mise à jour jointures sur SESSIONRESTRICT-->
<!-- FI 20120102 [] mise en place des mots clefs %%SR -->
<!-- FI 20120119 [] mise de IsUseSQLParameters -->
<!-- FI 20120926 [] usage of data attribute for HyperLink column-->
<!-- RD 20121009 [] Suppression des vues et unification des XML de lancement-->
<!-- RD 20121026 [18201] Gestion des événements annulés-->
<!-- FI 20160420 [XXXXX] use of choose expression-->
<!-- FI 20170531 [23206] Refactoring pour augmenter les perfs   
                         Utilisation d'une instruction SQLPreSelect pour alimentation d'une table de travail 
-->
<!-- FI 20170607 [23221] Prise en considération de GPRODUCT= 'COM'-->
<!-- FI 20180907 [24160] EARs: Period considered -->
<!-- EG 20191115 [25077] RDBMS : New version of Trades tables architecture (TRADESTSYS merge to TRADE, NEW TABLE TRADEXML)-->
<!-- EG 20200226 [25077] RDBMS : New version of Trades tables architecture (TRADEINSTRUMENT (INSTRUMENTNO=1) to TRADE)-->
<!-- FI 20200820 [25468] dates systemes en UTC -->
<!-- EG 20200923 [XXXXX] Correction Mauvais lien Hyperlink sur Trade Risk (ajout INDENTIFIER du PRODUCT)-->

<Referentials>
  <Referential>
    <IsUseSQLParameters>true</IsUseSQLParameters>
    <!-- FI 20170531 [23206] TableName EARGEN -->
    <!--<TableName>TRADE</TableName>-->
    <TableName>EARGEN</TableName>
    <Ressource>TRADE</Ressource>
    <ColumnByRow>3</ColumnByRow>
    <Create>false</Create>
    <Modify>false</Modify>
    <Remove>false</Remove>
    <Notepad>false</Notepad>
    <LoadOnStart>false</LoadOnStart>
    <!-- FI 20170531 [23206] timeout à 5 minutes sur l'ensemble des requêtes (PRESELECT et SELECT) 
    Toute modification doit être reportée dans la méthode NormMsgFactory_EAR.GetQueryParameters() (voir Appel à CSTools.SetMaxTimeOut)
    -->
    <Timeout>300</Timeout>

    <!-- 
      // ***********************************************************************************************
      // COMMON : 
      //      - Exclure les trades Administratifs (Factures, ...)
      //      - Exclure les trades Asset (Titres, ...)
      //      - Exclure les trades Risk (Deposit, ...) SAUF: CashBalance et CashPayment
      //      (p.GPRODUCT not in ('ADM','ASSET','RISK') or p.IDENTIFIER in ('cashBalance','cashPayment'))
      //
      // ADMIN : 
      //      - Tous les trades Administratifs (Factures, ...)
      //      (p.GPRODUCT='ADM')
      //
      // CBI : 
      //      - Les trades CashBalanceInterest (Echelle d'intérêts)
      //      (p.IDENTIFIER='cashBalanceInterest')
      // ***********************************************************************************************
      -->
    <!-- FI 20170531 [23206] Toute modification doit être reportée dans la méthode NormMsgFactory_EAR.GetQueryParameters()  
    -->
    <SQLPreSelect>
        <Command rdbms = "all">
        <![CDATA[delete from EARGEN_%%SHORTSESSIONID%%_W]]>
      </Command>
      <Command rdbms = "all">
        <![CDATA[
        insert into EARGEN_%%SHORTSESSIONID%%_W (IDT, IDEC, IDE,  RMV_EAR_DAY, RECORDTYPE)
        <choose>
            <when test="'%%PARAM1%%'='COMMON'">
              select  t.IDT,ec.IDEC, e.IDE, enumrmv.EAR_DAY_FUT as RMV_EAR_DAY, '0' as RECORDTYPE
              from dbo.TRADE t
              inner join dbo.INSTRUMENT i on i.IDI=t.IDI and i.ISEAR=1
              inner join dbo.PRODUCT p on p.IDP=i.IDP and p.GPRODUCT='FUT'
              inner join dbo.EVENT e on e.IDT=t.IDT
              inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE and ec.DTEVENT between @DTSTART and @DATE1              
              inner join dbo.VW_EAREVENTENUM enumcode on enumcode.VALUE=e.EVENTCODE and enumcode.CODE='EventCode' and enumcode.EAR_DAY_FUT=1
              inner join dbo.VW_EAREVENTENUM enumtype on enumtype.VALUE=e.EVENTTYPE and enumtype.CODE='EventType' and  enumtype.EAR_DAY_FUT=1
              inner join dbo.VW_EAREVENTENUM enumclass on enumclass.VALUE=ec.EVENTCLASS and enumclass.CODE='EventClass' and enumclass.EAR_DAY_FUT=1
              inner join dbo.VW_EAREVENTENUM enumrmv on enumrmv.VALUE='RMV' and enumrmv.CODE='EventClass'
              where (t.IDSTENVIRONMENT='REGULAR') and (t.IDSTACTIVATION='REGULAR')
              <choose>
                <when test="{CLASS}='CLOSING'">and e.EVENTCODE='CLO'</when> 
                <when test="{CLASS}='CASH_FLOWS'">and e.EVENTCODE!='CLO'</when> 
              </choose> 
              union all
              select  t.IDT,ec.IDEC, e.IDE, enumrmv.EAR_DAY_COM as RMV_EAR_DAY, '0' as RECORDTYPE
              from dbo.TRADE t
              inner join dbo.INSTRUMENT i on i.IDI=t.IDI and i.ISEAR=1
              inner join dbo.PRODUCT p on p.IDP=i.IDP and p.GPRODUCT='COM'
              inner join dbo.EVENT e on e.IDT=t.IDT
              inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE and ec.DTEVENT between @DTSTART and @DATE1              
              inner join dbo.VW_EAREVENTENUM enumcode on enumcode.VALUE=e.EVENTCODE and enumcode.CODE='EventCode' and enumcode.EAR_DAY_COM=1
              inner join dbo.VW_EAREVENTENUM enumtype on enumtype.VALUE=e.EVENTTYPE and enumtype.CODE='EventType' and  enumtype.EAR_DAY_COM=1
              inner join dbo.VW_EAREVENTENUM enumclass on enumclass.VALUE=ec.EVENTCLASS and enumclass.CODE='EventClass' and enumclass.EAR_DAY_COM=1
              inner join dbo.VW_EAREVENTENUM enumrmv on enumrmv.VALUE='RMV' and enumrmv.CODE='EventClass'
              where (t.IDSTENVIRONMENT='REGULAR') and (t.IDSTACTIVATION='REGULAR')
              <choose>
                <when test="{CLASS}='CLOSING'">and e.EVENTCODE='CLO'</when> 
                <when test="{CLASS}='CASH_FLOWS'">and e.EVENTCODE!='CLO'</when> 
              </choose> 
              union all
              select t.IDT, ec.IDEC, e.IDE, enumrmv.EAR_DAY_FX as RMV_EAR_DAY, '0' as RECORDTYPE
              from dbo.TRADE t
              inner join dbo.INSTRUMENT i on i.IDI=t.IDI and i.ISEAR=1
              inner join dbo.PRODUCT p on p.IDP=i.IDP and p.GPRODUCT='FX'
              inner join dbo.EVENT e on e.IDT=t.IDT
              inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE and ec.DTEVENT between @DTSTART and @DATE1               
              inner join dbo.VW_EAREVENTENUM enumcode on enumcode.VALUE=e.EVENTCODE and enumcode.CODE='EventCode' and enumcode.EAR_DAY_FX=1
              inner join dbo.VW_EAREVENTENUM enumtype on enumtype.VALUE=e.EVENTTYPE and enumtype.CODE='EventType' and  enumtype.EAR_DAY_FX=1
              inner join dbo.VW_EAREVENTENUM enumclass on enumclass.VALUE=ec.EVENTCLASS and enumclass.CODE='EventClass' and enumclass.EAR_DAY_FX=1
              inner join dbo.VW_EAREVENTENUM enumrmv on enumrmv.VALUE='RMV' and enumrmv.CODE='EventClass'
              where (t.IDSTENVIRONMENT='REGULAR') and (t.IDSTACTIVATION='REGULAR')
              <choose>
                <when test="{CLASS}='CLOSING'">and e.EVENTCODE='CLO'</when> 
                <when test="{CLASS}='CASH_FLOWS'">and e.EVENTCODE!='CLO'</when> 
              </choose> 
              union all
              select t.IDT, ec.IDEC, e.IDE, enumrmv.EAR_DAY_OTC as RMV_EAR_DAY, '0' as RECORDTYPE
              from dbo.TRADE t
              inner join dbo.INSTRUMENT i on i.IDI=t.IDI and i.ISEAR=1
              inner join dbo.PRODUCT p on p.IDP=i.IDP and p.GPRODUCT='OTC'
              inner join dbo.EVENT e on e.IDT=t.IDT
              inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE and ec.DTEVENT between @DTSTART and @DATE1
              inner join dbo.VW_EAREVENTENUM enumcode on enumcode.VALUE=e.EVENTCODE and enumcode.CODE='EventCode' and enumcode.EAR_DAY_OTC=1 
              inner join dbo.VW_EAREVENTENUM enumtype on enumtype.VALUE=e.EVENTTYPE and enumtype.CODE='EventType' and  enumtype.EAR_DAY_OTC=1
              inner join dbo.VW_EAREVENTENUM enumclass on enumclass.VALUE=ec.EVENTCLASS and enumclass.CODE='EventClass' and enumclass.EAR_DAY_OTC=1
              inner join dbo.VW_EAREVENTENUM enumrmv on enumrmv.VALUE='RMV' and enumrmv.CODE='EventClass'
              where (t.IDSTENVIRONMENT='REGULAR') and (t.IDSTACTIVATION='REGULAR')
              <choose>
                <when test="{CLASS}='CLOSING'">and e.EVENTCODE='CLO'</when> 
                <when test="{CLASS}='CASH_FLOWS'">and e.EVENTCODE!='CLO'</when> 
              </choose> 
              union all
              select t.IDT, ec.IDEC, e.IDE, enumrmv.EAR_DAY_SEC as RMV_EAR_DAY, '0' as RECORDTYPE
              from dbo.TRADE t
              inner join dbo.INSTRUMENT i on i.IDI=t.IDI and i.ISEAR=1
              inner join dbo.PRODUCT p on p.IDP=i.IDP and p.GPRODUCT='SEC'
              inner join dbo.EVENT e on e.IDT=t.IDT
              inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE and ec.DTEVENT between @DTSTART and @DATE1               
              inner join dbo.VW_EAREVENTENUM enumcode on enumcode.VALUE=e.EVENTCODE and enumcode.CODE='EventCode' and enumcode.EAR_DAY_SEC=1 
              inner join dbo.VW_EAREVENTENUM enumtype on enumtype.VALUE=e.EVENTTYPE and enumtype.CODE='EventType' and  enumtype.EAR_DAY_SEC=1
              inner join dbo.VW_EAREVENTENUM enumclass on enumclass.VALUE=ec.EVENTCLASS and enumclass.CODE='EventClass' and enumclass.EAR_DAY_SEC=1
              inner join dbo.VW_EAREVENTENUM enumrmv on enumrmv.VALUE='RMV' and enumrmv.CODE='EventClass'
              where (t.IDSTENVIRONMENT='REGULAR') and (t.IDSTACTIVATION='REGULAR')              
              <choose>
                <when test="{CLASS}='CLOSING'">and e.EVENTCODE='CLO'</when> 
                <when test="{CLASS}='CASH_FLOWS'">and e.EVENTCODE!='CLO'</when> 
              </choose> 
              union all
              select t.IDT, ec.IDEC, e.IDE, enumrmv.EAR_DAY_RISK as RMV_EAR_DAY, '0' as RECORDTYPE
              from dbo.TRADE t
              inner join dbo.INSTRUMENT i on i.IDI=t.IDI and i.ISEAR=1
              inner join dbo.PRODUCT p on p.IDP=i.IDP and p.GPRODUCT='RISK' and p.IDENTIFIER in ('cashBalance','cashPayment')
              inner join dbo.EVENT e on e.IDT=t.IDT
              inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE and ec.DTEVENT between @DTSTART and @DATE1
              inner join dbo.VW_EAREVENTENUM enumcode on enumcode.VALUE=e.EVENTCODE and enumcode.CODE='EventCode' and enumcode.EAR_DAY_RISK=1
              inner join dbo.VW_EAREVENTENUM enumtype on enumtype.VALUE=e.EVENTTYPE and enumtype.CODE='EventType' and  enumtype.EAR_DAY_RISK=1
              inner join dbo.VW_EAREVENTENUM enumclass on enumclass.VALUE=ec.EVENTCLASS and enumclass.CODE='EventClass' and enumclass.EAR_DAY_RISK=1
              inner join dbo.VW_EAREVENTENUM enumrmv on enumrmv.VALUE='RMV' and enumrmv.CODE='EventClass'
              where (t.IDSTENVIRONMENT='REGULAR') and (t.IDSTACTIVATION='REGULAR') and not (e.EVENTCODE='OPP' and e.EVENTTYPE='CSH')
              <choose>
                <when test="{CLASS}='CLOSING'">and e.EVENTCODE='CLO'</when> 
                <when test="{CLASS}='CASH_FLOWS'">and e.EVENTCODE!='CLO'</when> 
              </choose>  
              union all
              select t.IDT, ec.IDEC, e.IDE, 0 as RMV_EAR_DAY, '1' as RECORDTYPE 
              from dbo.TRADE t
              inner join dbo.INSTRUMENT i on i.IDI=t.IDI and i.ISEAR=1
              inner join dbo.PRODUCT p on p.IDP=i.IDP and (p.GPRODUCT not in ('ADM','ASSET','RISK') or p.IDENTIFIER in ('cashBalance','cashPayment'))
              inner join dbo.EVENT e on e.IDT=t.IDT and e.EVENTCODE='RMV' and e.EVENTTYPE='DAT'
              inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE and ec.EVENTCLASS='GRP' and ec.DTEVENT between @DTSTART and @DATE1 
              where (t.IDSTENVIRONMENT='REGULAR')
              <choose>
                <when test="{CLASS}='CLOSING'">and e.EVENTCODE='CLO'</when> 
                <when test="{CLASS}='CASH_FLOWS'">and e.EVENTCODE!='CLO'</when> 
              </choose> 
            </when> 
            <when test="'%%PARAM1%%'='ADMIN'">
                select  t.IDT,ec.IDEC, e.IDE, enumrmv.EAR_DAY_ADM as RMV_EAR_DAY, '0' as RECORDTYPE
                from dbo.TRADE t
                inner join dbo.INSTRUMENT i on i.IDI=t.IDI and i.ISEAR=1
                inner join dbo.PRODUCT p on p.IDP=i.IDP and p.GPRODUCT='ADM'
                inner join dbo.EVENT e on e.IDT=t.IDT
                inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE and ec.DTEVENT between @DTSTART and @DATE1               
                inner join dbo.VW_EAREVENTENUM enumcode on enumcode.VALUE=e.EVENTCODE and enumcode.CODE='EventCode' and enumcode.EAR_DAY_ADM=1
                inner join dbo.VW_EAREVENTENUM enumtype on enumtype.VALUE=e.EVENTTYPE and enumtype.CODE='EventType' and  enumtype.EAR_DAY_ADM=1
                inner join dbo.VW_EAREVENTENUM enumclass on enumclass.VALUE=ec.EVENTCLASS and enumclass.CODE='EventClass' and enumclass.EAR_DAY_ADM=1
                inner join dbo.VW_EAREVENTENUM enumrmv on enumrmv.VALUE='RMV' and enumrmv.CODE='EventClass'
                where (t.IDSTENVIRONMENT='REGULAR') and (t.IDSTACTIVATION='REGULAR')
                <choose>
                  <when test="{CLASS}='CLOSING'">and e.EVENTCODE='CLO'</when> 
                  <when test="{CLASS}='CASH_FLOWS'">and e.EVENTCODE!='CLO'</when> 
                </choose> 
                union all
                select t.IDT, ec.IDEC, e.IDE, 0 as RMV_EAR_DAY, '1' as RECORDTYPE 
                from dbo.TRADE t
                inner join dbo.INSTRUMENT i on i.IDI=t.IDI and i.ISEAR=1
                inner join dbo.PRODUCT p on p.IDP=i.IDP and p.GPRODUCT='ADM'
                inner join dbo.EVENT e on e.IDT=t.IDT and e.EVENTCODE='RMV' and e.EVENTTYPE='DAT'
                inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE and ec.EVENTCLASS='GRP' and ec.DTEVENT between @DTSTART and @DATE1 
                where (t.IDSTENVIRONMENT='REGULAR')
                <choose>
                  <when test="{CLASS}='CLOSING'">and e.EVENTCODE='CLO'</when> 
                  <when test="{CLASS}='CASH_FLOWS'">and e.EVENTCODE!='CLO'</when> 
                </choose> 
            </when> 
            <when test="'%%PARAM1%%'='CBI'">
                select  t.IDT,ec.IDEC, e.IDE, enumrmv.EAR_DAY_RISK as RMV_EAR_DAY, '0' as RECORDTYPE
                from dbo.TRADE t
                inner join dbo.INSTRUMENT i on i.IDI=t.IDI and i.ISEAR=1
                inner join dbo.PRODUCT p on p.IDP=i.IDP and p.IDENTIFIER='cashBalanceInterest'
                inner join dbo.EVENT e on e.IDT=t.IDT
                inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE and ec.DTEVENT between @DTSTART and @DATE1               
                inner join dbo.VW_EAREVENTENUM enumcode on enumcode.VALUE=e.EVENTCODE and enumcode.CODE='EventCode' and enumcode.EAR_DAY_RISK=1
                inner join dbo.VW_EAREVENTENUM enumtype on enumtype.VALUE=e.EVENTTYPE and enumtype.CODE='EventType' and  enumtype.EAR_DAY_RISK=1
                inner join dbo.VW_EAREVENTENUM enumclass on enumclass.VALUE=ec.EVENTCLASS and enumclass.CODE='EventClass' and enumclass.EAR_DAY_RISK=1
                inner join dbo.VW_EAREVENTENUM enumrmv on enumrmv.VALUE='RMV' and enumrmv.CODE='EventClass'
                where (t.IDSTENVIRONMENT='REGULAR') and (t.IDSTACTIVATION='REGULAR')
                <choose>
                  <when test="{CLASS}='CLOSING'">and e.EVENTCODE='CLO'</when> 
                  <when test="{CLASS}='CASH_FLOWS'">and e.EVENTCODE!='CLO'</when> 
                </choose> 
                union all
                select t.IDT, ec.IDEC, e.IDE, 0 as RMV_EAR_DAY, '1' as RECORDTYPE 
                from dbo.TRADE t
                inner join dbo.INSTRUMENT i on i.IDI=t.IDI and i.ISEAR=1
                inner join dbo.PRODUCT p on p.IDP=i.IDP and p.IDENTIFIER='cashBalanceInterest'
                inner join dbo.EVENT e on e.IDT=t.IDT and e.EVENTCODE='RMV' and e.EVENTTYPE='DAT'
                inner join dbo.EVENTCLASS ec on ec.IDE=e.IDE and ec.EVENTCLASS='GRP' and ec.DTEVENT between @DTSTART and @DATE1 
                where (t.IDSTENVIRONMENT='REGULAR')
                <choose>
                  <when test="{CLASS}='CLOSING'">and e.EVENTCODE='CLO'</when> 
                  <when test="{CLASS}='CASH_FLOWS'">and e.EVENTCODE!='CLO'</when> 
                </choose> 
            </when> 
         </choose>
         ]]>
      </Command>
    </SQLPreSelect>

    <SQLSelect>
      <Command rdbms="all">
        <![CDATA[
      select 
      t.IDT as IDT,t.IDENTIFIER as IDENTIFIER,t.DISPLAYNAME as DISPLAYNAME,t.DESCRIPTION as DESCRIPTION,
      t.IDI as IDI,p.IDENTIFIER as PRODUCT_IDENTIFIER, p.GPRODUCT as GPRODUCT,
      t.DTTRADE as DTTRADE,t.DTSYS as DTSYS,
      t.IDSTENVIRONMENT as IDSTENVIRONMENT,t.IDSTBUSINESS as IDSTBUSINESS,
      t.IDSTACTIVATION as IDSTACTIVATION,t.IDSTPRIORITY as IDSTPRIORITY,
      t.SOURCE as SOURCE,t.EXTLLINK as EXTLLINK,1 as ISSELECTED
      from
      (
        /* event jour non annulé => l'EAR du jour sera (re)généré */
        select tblmain.IDT
            from EARGEN_%%SHORTSESSIONID%%_W tblmain
            inner join dbo.EVENT e on e.IDE=tblmain.IDE
            inner join dbo.EVENTCLASS ec on ec.IDEC=tblmain.IDEC
            where 
            tblmain.RECORDTYPE='0' and ec.DTEVENT=@DATE1 and e.IDSTACTIVATION='REGULAR'             
        union 
        /* event jour annulé avec EAR => l'EAR du jour sera supprimé et ne sera pas re-généré */
        select tblmain.IDT
            from EARGEN_%%SHORTSESSIONID%%_W tblmain
            inner join dbo.EVENT e on e.IDE=tblmain.IDE 
            inner join dbo.EVENTCLASS ec on ec.IDEC=tblmain.IDEC 
            where
            tblmain.RECORDTYPE='0' and ec.DTEVENT=@DATE1 and e.IDSTACTIVATION='DEACTIV'
            and exists 
            (
              select 1 
              from dbo.EARDAY ed11 
              inner join dbo.EAR ear11 on ear11.IDEAR=ed11.IDEAR
              where ear11.IDT=tblmain.IDT and ed11.IDEC=tblmain.IDEC
            )
        union
        /* event du passé non annulé sans EAR */
        select tblmain.IDT
            from EARGEN_%%SHORTSESSIONID%%_W tblmain
            inner join dbo.EVENT e on e.IDE=tblmain.IDE 
            inner join dbo.EVENTCLASS ec on ec.IDEC=tblmain.IDEC 
            where 
		        tblmain.RECORDTYPE='0' and ec.DTEVENT<@DATE1 and e.IDSTACTIVATION='REGULAR'
		        and not exists 
            (
              select 1 
              from dbo.EARDAY ed21 
              inner join dbo.EAR ear21 on ear21.IDEAR=ed21.IDEAR
              where ear21.IDT=tblmain.IDT and ed21.IDEC=tblmain.IDEC and ear21.IDSTACTIVATION='REGULAR'
            )
        union
        /* event du passé annulé */
        select tblmain.IDT
            from EARGEN_%%SHORTSESSIONID%%_W tblmain
            inner join dbo.EVENT e on e.IDE=tblmain.IDE 
            inner join dbo.EVENTCLASS ec on ec.IDEC=tblmain.IDEC 
            where
            tblmain.RECORDTYPE='0' and ec.DTEVENT<@DATE1 and e.IDSTACTIVATION='DEACTIV' 
            /* mode d'annulation native (autre que l'EventClass d'annulation) */
            and tblmain.RMV_EAR_DAY= 0
            /* avec un EAR NON annulé généré */
            and exists 
            (
              select 1 
              from dbo.EARDAY ed31 
              inner join dbo.EAR ear31 on ear31.IDEAR=ed31.IDEAR
              where ear31.IDT=tblmain.IDT and ed31.IDEC=ec.IDEC and ear31.IDSTACTIVATION='REGULAR'
            )
            /* annulation non traitée nativement */
            and not exists 
            (
              select 1 
              from dbo.EARDAY ed32 
              inner join dbo.EAR ear32 on ear32.IDEAR=ed32.IDEAR 
              where ear32.IDT=tblmain.IDT and ed32.IDEC=ec.IDEC and ear32.IDSTACTIVATION='REMOVED' and ear32.DTREMOVED is not null
            )
            /* annulation non traitée avec le mode externe */
            and not exists 
            (
              select 1 
              from dbo.EARDAY ed33 
              inner join dbo.EAR ear33 on ear33.IDEAR=ed33.IDEAR
              inner join dbo.EVENTCLASS ecrmv33 on ecrmv33.EVENTCLASS='RMV'
              where ear33.IDT=tblmain.IDT and ecrmv33.IDE=ec.IDE and ed33.IDEC=ecrmv33.IDEC
            )
        union
        /* event du passé annulé */
        select tblmain.IDT 
            from EARGEN_%%SHORTSESSIONID%%_W tblmain
            inner join dbo.EVENT e on e.IDE=tblmain.IDE 
            inner join dbo.EVENTCLASS ec on ec.IDEC=tblmain.IDEC 
            where
            tblmain.RECORDTYPE = '0' and ec.DTEVENT<@DATE1
            /* EventClass d'annulation, donc event annulé sans gestion native de l'annulation des évenements */
            and ec.EVENTCLASS='RMV'
            /* EARDAY frères générés */
            and exists 
            (
              select 1 
              from dbo.EARDAY ed41 
              inner join dbo.EAR ear41 on ear41.IDEAR=ed41.IDEAR
              inner join dbo.EVENTCLASS ec41 on ec41.EVENTCLASS!='RMV'
              where ec41.IDE=ec.IDE and ear41.IDT=tblmain.IDT and ed41.IDEC=ec41.IDEC
            )
            /* sans d'EAR généré, donc annulation non traitée avec le mode externe */
            and not exists 
            (
              select 1 
              from dbo.EARDAY ed42 
              inner join dbo.EAR ear42 on ear42.IDEAR=ed42.IDEAR
              where ear42.IDT=tblmain.IDT and ear42.IDSTACTIVATION='REGULAR' and ed42.IDEC=ec.IDEC
            )
            /* Annulation non traitée nativement */
            and not exists 
            (
              select 1 
              from dbo.EARDAY ed43 
              inner join dbo.EAR ear43 on ear43.IDEAR=ed43.IDEAR
              inner join dbo.EVENTCLASS ec43 on ec43.EVENTCLASS!='RMV'
              where ec43.IDE=ec.IDE and ear43.IDT=tblmain.IDT and ear43.IDSTACTIVATION='REMOVED' and ear43.DTREMOVED is not null and ed43.IDEC=ec43.IDEC
            )
         union
         /*event d'annulation (RMV/DAT/GRP) du jour et passés NON traités */
         select tblmain.IDT
            from EARGEN_%%SHORTSESSIONID%%_W tblmain
            where 
            tblmain.RECORDTYPE = '1' 
            /* NON traités */
            and exists                    
            (
              select 1 
              from dbo.EAR ear
              where ear.IDT=tblmain.IDT and ear.DTEARCANCEL is null
            ) 
      ) tblmain
      inner join dbo.TRADE t on t.IDT=tblmain.IDT
      inner join dbo.INSTRUMENT i on i.IDI=t.IDI
      inner join dbo.PRODUCT p on p.IDP=i.IDP
      <choose>
          <when test="{ENTITY}>-1">
              inner join dbo.TRADEACTOR tabuyer on tabuyer.IDT=tblmain.IDT and tabuyer.IDROLEACTOR='COUNTERPARTY'  and tabuyer.BUYER_SELLER='Buyer'
              inner join dbo.TRADEACTOR taseller on taseller.IDT=tblmain.IDT and taseller.IDROLEACTOR ='COUNTERPARTY' and taseller.BUYER_SELLER='Seller'
              left outer join dbo.BOOK bbuyer on bbuyer.IDB=tabuyer.IDB
              left outer join dbo.BOOK bseller on bseller.IDB=taseller.IDB
          </when>
        </choose>  
      <choose>
        <when test="'%%PARAM1%%'='COMMON'">
          %%SR:TRADE_JOIN%%(t.IDT,t)
          where %%SR:TRADE_WHERE_PREDICATE%%
        </when> 
        <when test="'%%PARAM1%%'='ADMIN'">
          %%SR:TRADEADMIN_JOIN%%(t.IDT, t)
          where %%SR:TRADEADMIN_WHERE_PREDICATE%%
        </when> 
        <when test="'%%PARAM1%%'='CBI'">
          %%SR:TRADERISK_JOIN%%(t.IDT,t)
          where %%SR:TRADERISK_WHERE_PREDICATE%%
        </when> 
      </choose>
      <choose>
        <when test="{ENTITY}>-1">
            and (bbuyer.IDA_ENTITY=@ENTITY or bseller.IDA_ENTITY=@ENTITY)
        </when>
      </choose>  
        ]]>
      </Command>
    </SQLSelect>


    <Column>
      <ColumnName>IDT</ColumnName>
      <Ressource>IDT</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsDataKeyField>true</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>true</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>true</IsOrderBy>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>IDENTIFIER</ColumnName>
      <Ressource>IDENTIFIER</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>true</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>true</IsOrderBy>
      <IsHyperLink linktype="column" type="IDT" data="IDT">true</IsHyperLink>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>DISPLAYNAME</ColumnName>
      <Ressource>DISPLAYNAME</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>DESCRIPTION</ColumnName>
      <Ressource>DESCRIPTION</Ressource>
      <DataType>string</DataType>
      <Length>128</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>IDI</ColumnName>
      <Ressource>IDI</Ressource>
      <DataType>int</DataType>
      <Length>10</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>true</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
        <TableName>INSTRUMENT</TableName>
        <ColumnRelation>
          <ColumnName>IDI</ColumnName>
          <DataType>int</DataType>
        </ColumnRelation>
        <ColumnSelect>
          <ColumnName>IDENTIFIER</ColumnName>
          <Ressource>Instrument</Ressource>
          <DataType>string</DataType>
        </ColumnSelect>
        <ColumnLabel>
          <ColumnName>DISPLAYNAME</ColumnName>
          <Ressource>DISPLAYNAME</Ressource>
          <DataType>string</DataType>
        </ColumnLabel>
      </Relation>
    </Column>
    <Column>
      <ColumnName>DTTRADE</ColumnName>
      <Ressource>DTTRADE</Ressource>
      <DataType>date</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>DTSYS</ColumnName>
      <Ressource>DTSYS</Ressource>
      <DataType datakind='Timestamp' tzdbid='Etc/UTC' display='Audit'>datetime</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTENVIRONMENT</ColumnName>
      <Ressource>IDSTENVIRONMENT</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTBUSINESS</ColumnName>
      <Ressource>IDSTBUSINESS</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTACTIVATION</ColumnName>
      <Ressource>IDSTACTIVATION</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>IDSTPRIORITY</ColumnName>
      <Ressource>IDSTPRIORITY</Ressource>
      <DataType>string</DataType>
      <Length>8</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression>RegexStringAlphaNumUpperLight</RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <IsResource>true</IsResource>
      <Relation>
      </Relation>
    </Column>
    <Column>
      <ColumnName>SOURCE</ColumnName>
      <Ressource>SOURCE</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
        <DDLType>source</DDLType>
      </Relation>
    </Column>
    <Column>
      <ColumnName>GPRODUCT</ColumnName>
      <Ressource>GPRODUCT</Ressource>
      <DataType>string</DataType>
      <Colspan>0</Colspan>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>true</IsHide>
      <IsHideInDataGrid>true</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>PRODUCT_IDENTIFIER</ColumnName>
      <Ressource>PRODUCT_IDENTIFIER</Ressource>
      <DataType>string</DataType>
      <Length>64</Length>
      <Scale>0</Scale>
      <IsMandatory>true</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>true</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>false</IsUpdatable>
      <IsOrderBy>true</IsOrderBy>
      <Relation/>
    </Column>
    <Column>
      <ColumnName>EXTLLINK</ColumnName>
      <Ressource>EXTLLINK</Ressource>
      <DataType>string</DataType>
      <Length>128</Length>
      <Scale>0</Scale>
      <IsMandatory>false</IsMandatory>
      <RegularExpression></RegularExpression>
      <Default></Default>
      <IsHide>false</IsHide>
      <IsHideInDataGrid>false</IsHideInDataGrid>
      <IsDataKeyField>false</IsDataKeyField>
      <IsKeyField>false</IsKeyField>
      <IsForeignKeyField>false</IsForeignKeyField>
      <IsIdentity>false</IsIdentity>
      <IsUpdatable>true</IsUpdatable>
      <IsOrderBy>false</IsOrderBy>
      <Relation>
      </Relation>
    </Column>
    
  </Referential>
</Referentials>
